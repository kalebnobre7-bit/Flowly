
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowly - To-Do Inteligente</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .task-completed { text-decoration: line-through; opacity: 0.5; }
        .day-column { border-right: 1px solid #1a1a1a; }
        .day-column:last-child { border-right: none; }
        .day-column.drag-over { background: #1a1a2a; border: 2px dashed #3b82f6; }
        .period-section { position: relative; }
        .period-section:hover .add-task-btn { opacity: 1; }
        .add-task-btn { opacity: 0; transition: opacity 0.2s; cursor: pointer; padding: 6px 10px; background: #1a1a1a; border: 1px dashed #404040; border-radius: 4px; font-size: 12px; color: #888; display: flex; align-items: center; gap: 6px; margin-top: 4px; }
        .add-task-btn:hover { background: #252525; border-color: #555; color: #aaa; }
        .task-input { background: #1a1a1a; border: 2px solid #3b82f6; border-radius: 4px; padding: 6px 10px; color: #e5e5e5; font-size: 13px; width: 100%; outline: none; margin-top: 4px; }
        .period-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; background: #1a1a1a; display: inline-block; margin-bottom: 8px; }
        .period-badge.hidden { display: none; }
        .period-section.compact .period-badge { display: none; }
        .period-section.compact { margin-bottom: 0 !important; }
        .task-drop-zone { height: 3px; background: transparent; margin: 2px 0; opacity: 0; transition: opacity 0.15s; }
        .task-drop-zone.show { opacity: 1; background: linear-gradient(90deg, transparent, #3b82f6, transparent); box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); border-radius: 2px; }
        .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .auth-modal.show { opacity: 1; pointer-events: all; }
        .auth-content { background: #1a1a1a; border-radius: 16px; padding: 40px; max-width: 400px; width: 90%; border: 1px solid #333; }
        .auth-input { width: 100%; padding: 12px 16px; background: #0f0f0f; border: 1px solid #333; border-radius: 8px; color: #e5e5e5; font-size: 14px; margin-bottom: 12px; transition: all 0.2s; }
        .auth-input:focus { outline: none; border-color: #3b82f6; }
        .auth-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 14px; }
        .auth-btn-primary { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; margin-bottom: 8px; }
        .auth-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .auth-btn-secondary { background: transparent; color: #aaa; border: 1px solid #444; }
        .auth-btn-secondary:hover { background: #2a2a2a; color: #fff; border-color: #555; }
        .user-menu { position: relative; }
        .user-dropdown { position: absolute; top: 100%; right: 0; margin-top: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; min-width: 200px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .user-dropdown.show { display: block; }
        .user-dropdown-item { padding: 10px 12px; border-radius: 4px; cursor: pointer; transition: all 0.15s; font-size: 14px; }
        .user-dropdown-item:hover { background: #2a2a2a; }
        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #404040;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .checkbox-custom:hover { border-color: #555; }
        .checkbox-custom:checked {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-color: #3b82f6;
        }
        .checkbox-custom:checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .task-item { cursor: grab; transition: all 0.2s; position: relative; padding-left: 24px; }
        .task-item:active { cursor: grabbing; opacity: 0.5; }
        .task-item.dragging { opacity: 0.3; }
        .drag-handle { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; opacity: 0; transition: opacity 0.2s; cursor: grab; display: flex; flex-wrap: wrap; gap: 2px; padding: 2px; }
        .task-item:hover .drag-handle { opacity: 0.4; }
        .drag-handle:hover { opacity: 0.8 !important; }
        .drag-handle-dot { width: 3px; height: 3px; background: #888; border-radius: 50%; }
        .drop-indicator { height: 3px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); margin: 2px 0; opacity: 0; transition: opacity 0.15s; border-radius: 2px; }
        .drop-indicator.show { opacity: 1; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }
        .empty-line { min-height: 20px; border-radius: 4px; transition: all 0.2s; position: relative; margin: 2px 0; }
        .empty-line:hover { background: rgba(59, 130, 246, 0.1); }
        .empty-line-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s; display: flex; gap: 4px; }
        .empty-line:hover .empty-line-actions { opacity: 1; }
        .empty-line-btn { width: 16px; height: 16px; border-radius: 3px; background: #2a2a2a; border: 1px solid #404040; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888; transition: all 0.15s; }
        .empty-line-btn:hover { background: #333; color: #fff; border-color: #555; }
        .task-label { user-select: none; }
        .task-label[contenteditable="true"] { user-select: text; outline: 2px solid #3b82f6; outline-offset: 2px; border-radius: 3px; padding: 2px 4px; margin: -2px -4px; }
        .color-menu, .edit-toolbar { position: absolute; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .color-menu.show, .edit-toolbar.show { display: flex; gap: 4px; }
        .color-swatch { width: 28px; height: 28px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
        .color-swatch:hover { transform: scale(1.1); border-color: #555; }
        .toolbar-btn { padding: 6px 10px; background: transparent; border: none; color: #999; cursor: pointer; border-radius: 4px; font-size: 14px; transition: all 0.15s; }
        .toolbar-btn:hover { background: #2a2a2a; color: #fff; }
        .floating-add-btn { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transition: all 0.2s; z-index: 100; }
        .floating-add-btn:hover { transform: scale(1.1); background: #4f96ff; }
        .quick-add-menu { position: fixed; bottom: 100px; right: 30px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; display: none; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.5); min-width: 200px; }
        .quick-add-menu.show { display: block; }
        .quick-add-option { padding: 10px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: all 0.15s; }
        .quick-add-option:hover { background: #2a2a2a; }
        .habit-card { background: #1a1a1a; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid #252525; }
        .habit-card:hover { border-color: #333; }
        .streak-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .stat-card { background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%); border-radius: 12px; padding: 24px; border: 1px solid #252525; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card:hover { border-color: #333; transform: translateY(-2px); transition: all 0.2s; }
        .chart-container { background: #1a1a1a; border-radius: 12px; padding: 24px; border: 1px solid #252525; margin-bottom: 20px; }
        .insight-card { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #3b82f6; position: relative; overflow: hidden; }
        .insight-card::before { content: 'üí°'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 48px; opacity: 0.2; }
        .progress-bar { width: 100%; height: 6px; background: #1a1a1a; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s; border-radius: 10px; }
        .big-number { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #3b82f6, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .backup-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .backup-modal.show { display: flex; }
        .backup-content { background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; border: 1px solid #333; }
        .backup-btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 14px; }
        .backup-btn-primary { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .backup-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .backup-btn-danger { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
        .backup-btn-danger:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239,68,68,0.4); }
        .backup-btn-secondary { background: #2a2a2a; color: #e5e5e5; }
        .backup-btn-secondary:hover { background: #333; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label { display: block; padding: 12px 24px; background: #2a2a2a; color: #e5e5e5; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px dashed #404040; }
        .file-input-label:hover { background: #333; border-color: #555; }
        .color-default { color: #e5e5e5; } .color-gray { color: #9b9a97; } .color-brown { color: #937264; } .color-orange { color: #f97316; } .color-yellow { color: #f59e0b; } .color-green { color: #10b981; } .color-blue { color: #3b82f6; } .color-purple { color: #9065b0; } .color-pink { color: #c14c8a; } .color-red { color: #ef4444; }
        .task-item.is-habit .task-label { color: #3b82f6 !important; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1600px] mx-auto">
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <img src="logo_flowly.png" alt="Flowly" class="h-10">
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex gap-1 bg-[#0f0f0f] p-1 rounded-lg border border-[#1a1a1a]">
                        <button id="btnToday" class="px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]">Hoje</button>
                        <button id="btnWeek" class="px-5 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-white">Semana</button>
                        <button id="btnHabits" class="px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]">H√°bitos</button>
                        <button id="btnAnalytics" class="px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]">Analytics</button>
                    </div>
                    <button id="btnTogglePeriods" class="px-3 py-2 rounded-md text-xs font-medium transition-all bg-[#0f0f0f] text-gray-500 hover:text-gray-300 border border-[#1a1a1a]" title="Mostrar/Ocultar per√≠odos">‚ãÆ‚ãÆ‚ãÆ</button>
                    <button id="btnBackup" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-[#0f0f0f] text-gray-400 hover:text-white hover:bg-[#1a1a1a] border border-[#1a1a1a]">‚ü≥ Backup</button>
                    <div class="user-menu">
                        <button id="btnUser" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-[#0f0f0f] text-gray-400 hover:text-white hover:bg-[#1a1a1a] border border-[#1a1a1a]">üë§</button>
                        <div id="userDropdown" class="user-dropdown">
                            <div id="userEmail" class="text-xs text-gray-500 mb-2 px-2"></div>
                            <div class="user-dropdown-item" id="btnLogout">Sair</div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-gray-400 text-lg">S√≥ existe o hoje, foco no que traz grana.</p>
        </div>
        <div id="contentArea">
            <div id="weekGrid" class="grid grid-cols-7 gap-0"></div>
            <div id="habitsView" class="hidden"></div>
            <div id="analyticsView" class="hidden"></div>
        </div>
    </div>
    <div id="floatingAddBtn" class="floating-add-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
    <div id="quickAddMenu" class="quick-add-menu"><div class="quick-add-option" data-type="routine">‚Üª Adicionar rotina di√°ria</div><div class="quick-add-option" data-type="custom">+ Nova tarefa customizada</div></div>
    <div id="colorMenu" class="color-menu"><div class="color-swatch" style="background: #6b7280;" data-color="default" title="Padr√£o"></div><div class="color-swatch" style="background: #10b981;" data-color="green" title="F√°cil"></div><div class="color-swatch" style="background: #f59e0b;" data-color="yellow" title="M√©dia"></div><div class="color-swatch" style="background: #f97316;" data-color="orange" title="Alta"></div><div class="color-swatch" style="background: #ef4444;" data-color="red" title="Urgente"></div></div>
    <div id="editToolbar" class="edit-toolbar">
        <button class="toolbar-btn" data-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
        <button class="toolbar-btn" data-action="italic" title="It√°lico (Ctrl+I)"><em>I</em></button>
        <button class="toolbar-btn" data-action="strikethrough" title="Riscado"><s>S</s></button>
        <div style="width: 1px; background: #333; margin: 0 2px;"></div>
        <button class="toolbar-btn" data-action="color" title="Prioridade">‚óè</button>
        <button class="toolbar-btn" data-action="habit" title="Marcar como h√°bito">‚Üª</button>
        <div style="width: 1px; background: #333; margin: 0 2px;"></div>
        <button class="toolbar-btn" data-action="delete" title="Deletar">√ó</button>
    </div>
    
    <!-- Backup Modal -->
    <div id="backupModal" class="backup-modal">
        <div class="backup-content">
            <h2 class="text-2xl font-bold mb-6">‚ü≥ Backup & Dados</h2>
            
            <div class="space-y-4">
                <div>
                    <button id="btnExport" class="backup-btn backup-btn-primary w-full mb-2">
                        ‚Üì Exportar Dados (JSON)
                    </button>
                    <p class="text-xs text-gray-400">Baixa todas as suas tasks e h√°bitos</p>
                </div>
                
                <div>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileImport" accept=".json">
                        <label for="fileImport" class="file-input-label">
                            ‚Üë Importar Backup
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Restaura dados de um arquivo JSON</p>
                </div>
                
                <div class="border-t border-[#333] pt-4 mt-4">
                    <button id="btnClearAll" class="backup-btn backup-btn-danger w-full mb-2">
                        √ó Limpar Todos os Dados
                    </button>
                    <p class="text-xs text-gray-400">Remove tudo e come√ßa do zero</p>
                </div>
            </div>
            
            <button id="btnCloseBackup" class="backup-btn backup-btn-secondary w-full mt-6">Fechar</button>
        </div>
    </div>
    
    
    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal show">
        <div class="auth-content">
            <h2 class="text-2xl font-bold mb-6 text-center">Bem-vindo ao Flowly</h2>
            <div id="authLogin">
                <input type="email" id="loginEmail" class="auth-input" placeholder="Email">
                <input type="password" id="loginPassword" class="auth-input" placeholder="Senha">
                <button id="btnLogin" class="auth-btn auth-btn-primary">Entrar</button>
                <div style="text-align: center; margin: 12px 0; color: #666; font-size: 12px;">ou</div>
                <button id="btnShowSignup" class="auth-btn auth-btn-secondary">Criar nova conta</button>
            </div>
            <div id="authSignup" style="display:none;">
                <input type="email" id="signupEmail" class="auth-input" placeholder="Email">
                <input type="password" id="signupPassword" class="auth-input" placeholder="Senha (m√≠n. 6 caracteres)">
                <button id="btnSignup" class="auth-btn auth-btn-primary">Criar conta</button>
                <button id="btnShowLogin" class="auth-btn auth-btn-secondary">J√° tenho conta</button>
            </div>
            <p id="authMessage" class="text-xs text-center mt-4" style="color: #888;"></p>
        </div>
    </div>

    <script>
// Supabase Config
const SUPABASE_URL='https://cgrosyjtujakkbjjnmml.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncm9zeWp0dWpha2tiampubW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTA0NzcsImV4cCI6MjA4NjU4NjQ3N30.MsDw0nSiLF1jHWMuVGRgTT6gNUeK328RvGBo-YcFG1A';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;

let currentView='week',draggedTask=null,currentEditingTask=null;
const dailyRoutine=[{text:"Ora√ß√£o e Salmo",completed:false,color:"default",isHabit:false},{text:"Venvanse",completed:false,color:"default",isHabit:false},{text:"Ler metas e mantra; celular na gaveta",completed:false,color:"default",isHabit:false}];
const weekData={"Segunda":{},"Ter√ßa":{},"Quarta":{},"Quinta":{},"Sexta":{},"S√°bado":{},"Domingo":{}};
let habitsHistory=JSON.parse(localStorage.getItem('habitsHistory')||'{}');

async function checkAuth(){const{data:{session}}=await supabase.auth.getSession();if(session){currentUser=session.user;document.getElementById('authModal').classList.remove('show');document.getElementById('btnUser').textContent=session.user.email.charAt(0).toUpperCase();document.getElementById('userEmail').textContent=session.user.email;await loadDataFromSupabase();renderView()}else{document.getElementById('authModal').classList.add('show')}}
async function signUp(email,password){const{data,error}=await supabase.auth.signUp({email,password});if(error){showAuthMessage(error.message,'error');return false}showAuthMessage('Conta criada! Fazendo login...','success');await signIn(email,password);return true}
async function signIn(email,password){const{data,error}=await supabase.auth.signInWithPassword({email,password});if(error){showAuthMessage(error.message,'error');return false}currentUser=data.user;document.getElementById('authModal').classList.remove('show');document.getElementById('btnUser').textContent=data.user.email.charAt(0).toUpperCase();document.getElementById('userEmail').textContent=data.user.email;await migrateLocalDataToSupabase();await loadDataFromSupabase();showAuthMessage('','');return true}
async function signOut(){await supabase.auth.signOut();currentUser=null;document.getElementById('authModal').classList.add('show');location.reload()}
function showAuthMessage(msg,type){const el=document.getElementById('authMessage');el.textContent=msg;el.style.color=type==='error'?'#ef4444':'#10b981'}
async function migrateLocalDataToSupabase(){if(!currentUser)return;const localData=localStorage.getItem('weekData');if(!localData)return;const data=JSON.parse(localData);let migrated=0;for(const[day,periods]of Object.entries(data)){for(const[period,tasks]of Object.entries(periods)){for(const task of tasks){const{error}=await supabase.from('tasks').insert({user_id:currentUser.id,day,period,text:task.text,completed:task.completed,color:task.color,is_habit:task.isHabit});if(!error)migrated++}}}if(migrated>0){console.log(`Migrated ${migrated} tasks`);localStorage.removeItem('weekData')}}
async function loadDataFromSupabase(){if(!currentUser)return;const{data:tasks}=await supabase.from('tasks').select('*').eq('user_id',currentUser.id);if(tasks){Object.keys(weekData).forEach(day=>{weekData[day]={}});tasks.forEach(task=>{if(!weekData[task.day][task.period]){weekData[task.day][task.period]=[]}weekData[task.day][task.period].push({text:task.text,completed:task.completed,color:task.color,isHabit:task.is_habit,supabaseId:task.id})});renderView()}const{data:habits}=await supabase.from('habits_history').select('*').eq('user_id',currentUser.id);if(habits){habitsHistory={};habits.forEach(h=>{if(!habitsHistory[h.habit_name]){habitsHistory[h.habit_name]={}}habitsHistory[h.habit_name][h.date]=h.completed})}}
async function syncTaskToSupabase(day,period,task){if(!currentUser)return;if(task.supabaseId){await supabase.from('tasks').update({text:task.text,completed:task.completed,color:task.color,is_habit:task.isHabit,updated_at:new Date().toISOString()}).eq('id',task.supabaseId)}else{const{data}=await supabase.from('tasks').insert({user_id:currentUser.id,day,period,text:task.text,completed:task.completed,color:task.color,is_habit:task.isHabit}).select();if(data&&data[0]){task.supabaseId=data[0].id}}}
async function deleteTaskFromSupabase(task){if(!currentUser||!task.supabaseId)return;await supabase.from('tasks').delete().eq('id',task.supabaseId)}
async function syncHabitToSupabase(habitText,date,completed){if(!currentUser)return;await supabase.from('habits_history').upsert({user_id:currentUser.id,habit_name:habitText,date,completed},{onConflict:'user_id,habit_name,date'})}


function getAllHabits(){const habits=[],habitMap=new Map();Object.entries(weekData).forEach(([day,periods])=>{Object.entries(periods).forEach(([period,tasks])=>{tasks.forEach(task=>{if(task.isHabit&&!habitMap.has(task.text)){habitMap.set(task.text,{text:task.text,color:task.color,completedToday:task.completed})}})})});return Array.from(habitMap.values())}

function getHabitStreak(habitText){if(!habitsHistory[habitText])return 0;const today=new Date();let streak=0,currentDate=new Date(today);while(true){const dateKey=currentDate.toISOString().split('T')[0];if(habitsHistory[habitText][dateKey]){streak++;currentDate.setDate(currentDate.getDate()-1)}else{break}}return streak}

function getHabitCompletionRate(habitText,days=30){if(!habitsHistory[habitText])return 0;const today=new Date();let completed=0;for(let i=0;i<days;i++){const date=new Date(today);date.setDate(date.getDate()-i);const dateKey=date.toISOString().split('T')[0];if(habitsHistory[habitText][dateKey]){completed++}}return Math.round((completed/days)*100)}

function markHabitCompleted(habitText,completed){const today=new Date().toISOString().split('T')[0];if(!habitsHistory[habitText]){habitsHistory[habitText]={}}if(completed){habitsHistory[habitText][today]=true}else{delete habitsHistory[habitText][today]}localStorage.setItem('habitsHistory',JSON.stringify(habitsHistory));syncHabitToSupabase(habitText,today,completed)}

function renderAnalyticsView(){const view=document.getElementById('analyticsView');let totalTasks=0,completedTasks=0,totalHabits=getAllHabits().length,completedHabitsToday=getAllHabits().filter(h=>h.completedToday).length;Object.values(weekData).forEach(periods=>{Object.values(periods).forEach(tasks=>{tasks.forEach(task=>{totalTasks++;if(task.completed)completedTasks++})})});const completionRate=totalTasks>0?Math.round((completedTasks/totalTasks)*100):0;const habitRate=totalHabits>0?Math.round((completedHabitsToday/totalHabits)*100):0;const bestStreak=Math.max(...getAllHabits().map(h=>getHabitStreak(h.text)),0);const insights=[];if(completionRate>70)insights.push("üî• Voc√™ t√° VOANDO! "+completionRate+"% de conclus√£o!");if(bestStreak>=3)insights.push("‚ö° Streak de "+bestStreak+" dias no h√°bito mais forte!");if(habitRate===100)insights.push("üí™ TODOS os h√°bitos feitos hoje! Monstro!");const periodStats={morning:0,afternoon:0,night:0};Object.values(weekData).forEach(periods=>{Object.entries(periods).forEach(([period,tasks])=>{const completed=tasks.filter(t=>t.completed).length;if(period.includes('Manh√£'))periodStats.morning+=completed;else if(period.includes('Tarde'))periodStats.afternoon+=completed;else periodStats.night+=completed})});let bestPeriod='Manh√£';if(periodStats.afternoon>periodStats.morning&&periodStats.afternoon>periodStats.night)bestPeriod='Tarde';if(periodStats.night>periodStats.morning&&periodStats.night>periodStats.afternoon)bestPeriod='Noite';if(periodStats.morning>0||periodStats.afternoon>0||periodStats.night>0)insights.push("‚è∞ Seu melhor per√≠odo √© "+bestPeriod+"!");let html=`<div class="max-w-6xl mx-auto"><h2 class="text-3xl font-bold mb-8">Analytics üìä</h2><div class="grid grid-cols-4 gap-4 mb-8">`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Taxa de Conclus√£o</div><div class="big-number">${completionRate}%</div><div class="text-xs text-gray-500 mt-2">${completedTasks} de ${totalTasks} tasks</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">H√°bitos Hoje</div><div class="big-number">${habitRate}%</div><div class="text-xs text-gray-500 mt-2">${completedHabitsToday} de ${totalHabits} h√°bitos</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Melhor Streak</div><div class="big-number">${bestStreak}</div><div class="text-xs text-gray-500 mt-2">dias seguidos</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Produtividade</div><div class="big-number ${completionRate>=70?'trend-up':'trend-down'}">${completionRate>=70?'Alta':'M√©dia'}</div><div class="text-xs text-gray-500 mt-2">Score geral</div></div>`;html+=`</div>`;if(insights.length>0){html+=`<div class="mb-8"><h3 class="text-xl font-bold mb-4">üí° Insights Inteligentes</h3>`;insights.forEach(insight=>{html+=`<div class="insight-card"><p class="text-white font-medium">${insight}</p></div>`});html+=`</div>`}html+=`<div class="grid grid-cols-2 gap-6"><div class="chart-container"><h3 class="text-lg font-semibold mb-4">Produtividade por Per√≠odo</h3><canvas id="periodChart"></canvas></div><div class="chart-container"><h3 class="text-lg font-semibold mb-4">Status de H√°bitos</h3><canvas id="habitsChart"></canvas></div></div></div>`;view.innerHTML=html;setTimeout(()=>{const periodCtx=document.getElementById('periodChart');if(periodCtx){new Chart(periodCtx,{type:'bar',data:{labels:['Manh√£','Tarde','Noite'],datasets:[{label:'Tasks Conclu√≠das',data:[periodStats.morning,periodStats.afternoon,periodStats.night],backgroundColor:['rgba(59, 130, 246, 0.8)','rgba(96, 165, 250, 0.8)','rgba(167, 139, 250, 0.8)'],borderColor:['rgb(59, 130, 246)','rgb(96, 165, 250)','rgb(167, 139, 250)'],borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}}}})}const habitsCtx=document.getElementById('habitsChart');if(habitsCtx){new Chart(habitsCtx,{type:'doughnut',data:{labels:['Conclu√≠dos','Pendentes'],datasets:[{data:[completedHabitsToday,totalHabits-completedHabitsToday],backgroundColor:['rgba(16, 185, 129, 0.8)','rgba(55, 65, 81, 0.8)'],borderColor:['rgb(16, 185, 129)','rgb(55, 65, 81)'],borderWidth:2}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#9ca3af'}}}}})}},100)}

function renderHabitsView(){const view=document.getElementById('habitsView'),habits=getAllHabits();if(habits.length===0){view.innerHTML='<p class="text-gray-400 text-center py-20">Nenhum h√°bito cadastrado ainda. Marque tasks como h√°bitos clicando com o bot√£o direito!</p>';return}let html=`<div class="max-w-4xl mx-auto"><h2 class="text-2xl font-bold mb-6">Meus H√°bitos üîÑ</h2><div class="grid grid-cols-3 gap-4 mb-8"><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Total de H√°bitos</div><div class="text-3xl font-bold">${habits.length}</div></div><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Conclu√≠dos Hoje</div><div class="text-3xl font-bold text-green-400">${habits.filter(h=>h.completedToday).length}</div></div><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Taxa Hoje</div><div class="text-3xl font-bold text-blue-400">${habits.length>0?Math.round((habits.filter(h=>h.completedToday).length/habits.length)*100):0}%</div></div></div><div class="space-y-3">`;habits.forEach((habit,index)=>{const streak=getHabitStreak(habit.text),completionRate=getHabitCompletionRate(habit.text,30);html+=`<div class="habit-card"><div class="flex items-start justify-between mb-3"><div class="flex items-start gap-3 flex-1"><input type="checkbox" class="checkbox-custom mt-1" ${habit.completedToday?'checked':''} onchange="toggleHabitToday('${habit.text.replace(/'/g,"\\'")}', this.checked)"><div class="flex-1"><div class="color-${habit.color} font-medium mb-2">${habit.text}</div><div class="flex items-center gap-3">${streak>0?`<span class="streak-badge">üî• ${streak} ${streak===1?'dia':'dias'}</span>`:''}<span class="text-xs text-gray-400">${completionRate}% nos √∫ltimos 30 dias</span></div></div></div></div><div class="progress-bar"><div class="progress-fill" style="width: ${completionRate}%"></div></div></div>`});html+=`</div></div>`;view.innerHTML=html}

function toggleHabitToday(habitText,completed){Object.entries(weekData).forEach(([day,periods])=>{Object.entries(periods).forEach(([period,tasks])=>{tasks.forEach(task=>{if(task.isHabit&&task.text===habitText){task.completed=completed}})})});markHabitCompleted(habitText,completed);saveToLocalStorage();renderHabitsView()}

function createTaskElement(day,period,task,index){const container=document.createElement('div');const dropZone=document.createElement('div');dropZone.className='task-drop-zone';dropZone.dataset.day=day;dropZone.dataset.period=period;dropZone.dataset.insertAt=index;dropZone.addEventListener('dragover',(e)=>{e.preventDefault();e.stopPropagation();dropZone.classList.add('show')});dropZone.addEventListener('dragleave',()=>{dropZone.classList.remove('show')});dropZone.addEventListener('drop',(e)=>{e.preventDefault();e.stopPropagation();dropZone.classList.remove('show');if(!draggedTask)return;const targetDay=dropZone.dataset.day;const targetPeriod=dropZone.dataset.period;let insertAt=parseInt(dropZone.dataset.insertAt);if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index===insertAt){return}const originalTasks=weekData[draggedTask.day][draggedTask.period];const taskToMove=originalTasks.splice(draggedTask.index,1)[0];if(!weekData[targetDay][targetPeriod]){weekData[targetDay][targetPeriod]=[]}if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index<insertAt){insertAt--}weekData[targetDay][targetPeriod].splice(insertAt,0,taskToMove);saveToLocalStorage();renderView()});const taskDiv=document.createElement('div');taskDiv.className=`task-item flex items-start gap-2 mb-2 ${task.isHabit?'is-habit':''}`;taskDiv.draggable=true;taskDiv.dataset.day=day;taskDiv.dataset.period=period;taskDiv.dataset.index=index;const dragHandle=document.createElement('div');dragHandle.className='drag-handle';for(let i=0;i<6;i++){const dot=document.createElement('div');dot.className='drag-handle-dot';dragHandle.appendChild(dot)}taskDiv.appendChild(dragHandle);const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.className='checkbox-custom mt-1';checkbox.checked=task.completed;checkbox.addEventListener('change',(e)=>{e.stopPropagation();taskLabel.classList.toggle('task-completed');task.completed=checkbox.checked;if(task.isHabit){markHabitCompleted(task.text,task.completed)}saveToLocalStorage()});const taskLabel=document.createElement('span');taskLabel.className=`task-label text-sm cursor-pointer color-${task.color} ${task.completed?'task-completed':''}`;taskLabel.innerHTML=task.text;taskLabel.addEventListener('click',(e)=>{if(taskLabel.textContent.trim()===''){e.stopPropagation();taskLabel.focus();const handleDelete=(evt)=>{if((evt.key==='Delete'||evt.key==='Backspace')&&taskLabel.textContent.trim()===''){evt.preventDefault();deleteTask(day,period,index);renderView();taskLabel.removeEventListener('keydown',handleDelete)}};taskLabel.addEventListener('keydown',handleDelete);taskLabel.addEventListener('blur',()=>{taskLabel.removeEventListener('keydown',handleDelete)},{once:true})}});taskLabel.addEventListener('dblclick',(e)=>{e.stopPropagation();startEditing(taskLabel,task,taskDiv)});taskLabel.addEventListener('contextmenu',(e)=>{e.preventDefault();e.stopPropagation();showEditToolbar(e,task,taskLabel)});taskLabel.addEventListener('keydown',(e)=>{if(e.ctrlKey||e.metaKey){if(e.key==='b'){e.preventDefault();document.execCommand('bold',false,null)}else if(e.key==='i'){e.preventDefault();document.execCommand('italic',false,null)}}else if((e.key==='Delete'||e.key==='Backspace')&&taskLabel.textContent.trim()===''){e.preventDefault();deleteTask(day,period,index);renderView()}});taskDiv.addEventListener('dragstart',handleDragStart);taskDiv.addEventListener('dragend',handleDragEnd);taskDiv.appendChild(checkbox);taskDiv.appendChild(taskLabel);container.appendChild(dropZone);container.appendChild(taskDiv);return container}

function createAddTaskButton(day,period){const btn=document.createElement('div');btn.className='add-task-btn';btn.innerHTML='<span style="font-size: 16px;">+</span> Adicionar tarefa';btn.addEventListener('click',(e)=>{e.stopPropagation();showTaskInput(btn,day,period)});return btn}

function showTaskInput(button,day,period){const input=document.createElement('input');input.type='text';input.className='task-input';input.placeholder='Digite a tarefa...';button.replaceWith(input);input.focus();const saveTask=()=>{const text=input.value.trim();if(text){if(!weekData[day][period]){weekData[day][period]=[]}weekData[day][period].push({text:text,completed:false,color:'default',isHabit:false});saveToLocalStorage()}renderView()};input.addEventListener('keydown',(e)=>{if(e.key==='Enter'){saveTask()}else if(e.key==='Escape'){renderView()}});input.addEventListener('blur',()=>{setTimeout(()=>saveTask(),100)})}

function addDailyRoutine(day){const morningPeriod="Manh√£ (8h-12h)";if(!weekData[day][morningPeriod]){weekData[day][morningPeriod]=[]}dailyRoutine.forEach(task=>{weekData[day][morningPeriod].push({...task})});saveToLocalStorage();renderView()}

function startEditing(label,task,taskDiv){if(currentEditingTask){finishEditing()}currentEditingTask={label,task,originalText:task.text,taskDiv};label.contentEditable=true;label.focus();const range=document.createRange();range.selectNodeContents(label);const sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);taskDiv.draggable=false;const handleKeyDown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();finishEditing();const day=taskDiv.dataset.day,period=taskDiv.dataset.period,index=parseInt(taskDiv.dataset.index);setTimeout(()=>{if(!weekData[day][period]){weekData[day][period]=[]}weekData[day][period].splice(index+1,0,{text:'',completed:false,color:'default',isHabit:false});saveToLocalStorage();renderView();setTimeout(()=>{const allTasks=document.querySelectorAll('.task-item');const nextTask=allTasks[Array.from(allTasks).findIndex(t=>t===taskDiv)+1];if(nextTask){const nextLabel=nextTask.querySelector('.task-label');if(nextLabel){startEditing(nextLabel,weekData[day][period][index+1],nextTask)}}},50)},10)}else if(e.key==='Escape'){task.text=currentEditingTask.originalText;label.innerHTML=task.text;finishEditing()}else if((e.key==='Backspace'||e.key==='Delete')&&label.textContent.trim()===''){e.preventDefault();const day=taskDiv.dataset.day,period=taskDiv.dataset.period,index=parseInt(taskDiv.dataset.index);deleteTask(day,period,index);finishEditing();renderView()}else if(e.key==='Tab'){e.preventDefault();const currentText=label.textContent;label.textContent='    '+currentText;const range=document.createRange();range.selectNodeContents(label);range.collapse(false);const sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)}};label.addEventListener('keydown',handleKeyDown);label.addEventListener('blur',finishEditing)}

function finishEditing(){if(!currentEditingTask)return;const{label,task}=currentEditingTask;label.contentEditable=false;task.text=label.innerHTML.trim();const taskDiv=label.closest('.task-item');if(taskDiv)taskDiv.draggable=true;saveToLocalStorage();currentEditingTask=null}

function showEditToolbar(e,task,label){const toolbar=document.getElementById('editToolbar'),colorMenu=document.getElementById('colorMenu');colorMenu.classList.remove('show');toolbar.style.left=e.pageX+'px';toolbar.style.top=e.pageY+'px';toolbar.classList.add('show');toolbar.dataset.taskDay=label.closest('.task-item').dataset.day;toolbar.dataset.taskPeriod=label.closest('.task-item').dataset.period;toolbar.dataset.taskIndex=label.closest('.task-item').dataset.index;const isEmpty=label.textContent.trim()==='';const buttons=toolbar.querySelectorAll('.toolbar-btn');const separators=toolbar.querySelectorAll('div[style*="width: 1px"]');buttons.forEach(btn=>{const action=btn.dataset.action;if(isEmpty&&(action==='bold'||action==='italic'||action==='strikethrough'||action==='color'||action==='habit')){btn.style.display='none'}else{btn.style.display=''}btn.onclick=(e)=>{e.stopPropagation();if(action==='bold'){document.execCommand('bold',false,null);label.focus()}else if(action==='italic'){document.execCommand('italic',false,null);label.focus()}else if(action==='strikethrough'){document.execCommand('strikeThrough',false,null);label.focus()}else if(action==='color'){showColorMenu(e,task,label)}else if(action==='habit'){task.isHabit=!task.isHabit;saveToLocalStorage();toolbar.classList.remove('show');renderView()}else if(action==='delete'){deleteTask(toolbar.dataset.taskDay,toolbar.dataset.taskPeriod,toolbar.dataset.taskIndex);toolbar.classList.remove('show');renderView()}}});separators.forEach(sep=>{if(isEmpty){sep.style.display='none'}else{sep.style.display=''}})}

function showColorMenu(e,task,label){const colorMenu=document.getElementById('colorMenu'),toolbar=document.getElementById('editToolbar');const rect=toolbar.getBoundingClientRect();colorMenu.style.left=rect.left+'px';colorMenu.style.top=(rect.bottom+5)+'px';colorMenu.classList.add('show');const swatches=colorMenu.querySelectorAll('.color-swatch');swatches.forEach(swatch=>{swatch.onclick=()=>{const color=swatch.dataset.color;task.color=color;label.className=label.className.replace(/color-\w+/,`color-${color}`);saveToLocalStorage();colorMenu.classList.remove('show');toolbar.classList.remove('show')}})}

function deleteTask(day,period,index){const tasks=weekData[day][period];const task=tasks[index];deleteTaskFromSupabase(task);tasks.splice(index,1);saveToLocalStorage()}

function handleDragStart(e){draggedTask={day:this.dataset.day,period:this.dataset.period,index:parseInt(this.dataset.index),task:weekData[this.dataset.day][this.dataset.period][parseInt(this.dataset.index)]};this.classList.add('dragging');e.dataTransfer.effectAllowed='move'}

function handleDragEnd(e){this.classList.remove('dragging');document.querySelectorAll('.day-column').forEach(col=>{col.classList.remove('drag-over')})}

function handleDragOver(e){if(e.preventDefault){e.preventDefault()}e.dataTransfer.dropEffect='move';return false}

function handleDragEnter(e){this.classList.add('drag-over')}

function handleDragLeave(e){this.classList.remove('drag-over')}

function handleDrop(e){if(e.stopPropagation){e.stopPropagation()}this.classList.remove('drag-over');if(!draggedTask)return;const targetDay=this.dataset.day,targetPeriod=this.dataset.period||Object.keys(weekData[targetDay])[0];if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod){draggedTask=null;return false}const originalTasks=weekData[draggedTask.day][draggedTask.period];originalTasks.splice(draggedTask.index,1);if(!weekData[targetDay][targetPeriod]){weekData[targetDay][targetPeriod]=[]}weekData[targetDay][targetPeriod].push(draggedTask.task);saveToLocalStorage();renderView();draggedTask=null;return false}

function renderWeek(){const grid=document.getElementById('weekGrid');grid.innerHTML='';grid.className='grid grid-cols-7 gap-0';const showPeriods=localStorage.getItem('showPeriods')!=='false';Object.entries(weekData).forEach(([day,periods])=>{const dayColumn=document.createElement('div');dayColumn.className='day-column p-4 min-h-[600px]';dayColumn.dataset.day=day;dayColumn.addEventListener('dragover',handleDragOver);dayColumn.addEventListener('dragenter',handleDragEnter);dayColumn.addEventListener('dragleave',handleDragLeave);dayColumn.addEventListener('drop',handleDrop);const dayHeader=document.createElement('h2');dayHeader.className='text-xl font-bold mb-4';dayHeader.textContent=day;dayColumn.appendChild(dayHeader);Object.entries(periods).forEach(([period,tasks])=>{const periodDiv=document.createElement('div');periodDiv.className=`period-section mb-6 ${!showPeriods?'compact':''}`;periodDiv.dataset.period=period;const periodLabel=document.createElement('div');periodLabel.className='period-badge';periodLabel.textContent=period;periodDiv.appendChild(periodLabel);tasks.forEach((task,index)=>{const taskContainer=createTaskElement(day,period,task,index);periodDiv.appendChild(taskContainer)});const finalDropZone=document.createElement('div');finalDropZone.className='task-drop-zone';finalDropZone.dataset.day=day;finalDropZone.dataset.period=period;finalDropZone.dataset.insertAt=tasks.length;finalDropZone.addEventListener('dragover',(e)=>{e.preventDefault();e.stopPropagation();finalDropZone.classList.add('show')});finalDropZone.addEventListener('dragleave',()=>{finalDropZone.classList.remove('show')});finalDropZone.addEventListener('drop',(e)=>{e.preventDefault();e.stopPropagation();finalDropZone.classList.remove('show');if(!draggedTask)return;const targetDay=finalDropZone.dataset.day;const targetPeriod=finalDropZone.dataset.period;let insertAt=parseInt(finalDropZone.dataset.insertAt);if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index===insertAt-1){return}const originalTasks=weekData[draggedTask.day][draggedTask.period];const taskToMove=originalTasks.splice(draggedTask.index,1)[0];if(!weekData[targetDay][targetPeriod]){weekData[targetDay][targetPeriod]=[]}if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index<insertAt){insertAt--}weekData[targetDay][targetPeriod].splice(insertAt,0,taskToMove);saveToLocalStorage();renderView()});periodDiv.appendChild(finalDropZone);dayColumn.appendChild(periodDiv)});grid.appendChild(dayColumn)})}

function renderToday(){const grid=document.getElementById('weekGrid');grid.innerHTML='';grid.className='max-w-2xl mx-auto';const days=['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'],today=days[new Date().getDay()],todayData=weekData[today];if(!todayData){grid.innerHTML='<p class="text-gray-400 text-center py-20">Nenhuma tarefa para hoje!</p>';return}const dayContainer=document.createElement('div');dayContainer.className='p-6';dayContainer.dataset.day=today;dayContainer.addEventListener('dragover',handleDragOver);dayContainer.addEventListener('drop',handleDrop);const dateStr=new Date().toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),todayHeader=document.createElement('h2');todayHeader.className='text-3xl font-bold mb-2 capitalize';todayHeader.textContent=today;dayContainer.appendChild(todayHeader);const dateSubtitle=document.createElement('p');dateSubtitle.className='text-gray-400 mb-8 capitalize';dateSubtitle.textContent=dateStr;dayContainer.appendChild(dateSubtitle);Object.entries(todayData).forEach(([period,tasks])=>{const periodDiv=document.createElement('div');periodDiv.className='period-section mb-8';periodDiv.dataset.period=period;const periodHeader=document.createElement('h3');periodHeader.className='text-xl font-semibold mb-4 text-gray-300';periodHeader.textContent=period;periodDiv.appendChild(periodHeader);tasks.forEach((task,index)=>{const taskDiv=createTaskElement(today,period,task,index);taskDiv.className=`task-item flex items-start gap-3 mb-3 p-3 bg-[#1a1a1a] rounded-lg hover:bg-[#252525] transition-all ${task.isHabit?'is-habit':''}`;periodDiv.appendChild(taskDiv)});const addBtn=createAddTaskButton(today,period);periodDiv.appendChild(addBtn);dayContainer.appendChild(periodDiv)});grid.appendChild(dayContainer)}

function renderView(){const weekGrid=document.getElementById('weekGrid'),habitsView=document.getElementById('habitsView'),analyticsView=document.getElementById('analyticsView');weekGrid.classList.add('hidden');habitsView.classList.add('hidden');analyticsView.classList.add('hidden');if(currentView==='habits'){habitsView.classList.remove('hidden');renderHabitsView()}else if(currentView==='analytics'){analyticsView.classList.remove('hidden');renderAnalyticsView()}else{weekGrid.classList.remove('hidden');if(currentView==='week'){renderWeek()}else{renderToday()}}}

function setView(view){currentView=view;const btnToday=document.getElementById('btnToday'),btnWeek=document.getElementById('btnWeek'),btnHabits=document.getElementById('btnHabits'),btnAnalytics=document.getElementById('btnAnalytics');btnToday.className='px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]';btnWeek.className='px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]';btnHabits.className='px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]';btnAnalytics.className='px-5 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white hover:bg-[#1a1a1a]';if(view==='today'){btnToday.className='px-5 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-white'}else if(view==='habits'){btnHabits.className='px-5 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-white'}else if(view==='analytics'){btnAnalytics.className='px-5 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-white'}else{btnWeek.className='px-5 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-white'}renderView()}

function saveToLocalStorage(){localStorage.setItem('weekData',JSON.stringify(weekData));if(currentUser){Object.entries(weekData).forEach(([day,periods])=>{Object.entries(periods).forEach(([period,tasks])=>{tasks.forEach(task=>{syncTaskToSupabase(day,period,task)})})})}}

function loadFromLocalStorage(){const saved=localStorage.getItem('weekData');if(saved){const savedData=JSON.parse(saved);Object.keys(weekData).forEach(day=>{if(savedData[day]){weekData[day]=savedData[day]}})}}

document.getElementById('floatingAddBtn').addEventListener('click',()=>{const menu=document.getElementById('quickAddMenu');menu.classList.toggle('show')});document.querySelectorAll('.quick-add-option').forEach(option=>{option.addEventListener('click',()=>{const type=option.dataset.type,days=['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'],today=days[new Date().getDay()];if(type==='routine'){addDailyRoutine(today)}else if(type==='custom'){setTimeout(()=>{const firstAddBtn=document.querySelector('.add-task-btn');if(firstAddBtn)firstAddBtn.click()},100)}document.getElementById('quickAddMenu').classList.remove('show')})});document.addEventListener('click',(e)=>{if(!e.target.closest('#editToolbar')&&!e.target.closest('#colorMenu')){document.getElementById('editToolbar').classList.remove('show');document.getElementById('colorMenu').classList.remove('show')}if(!e.target.closest('#floatingAddBtn')&&!e.target.closest('#quickAddMenu')){document.getElementById('quickAddMenu').classList.remove('show')}});document.getElementById('btnToday').addEventListener('click',()=>setView('today'));document.getElementById('btnWeek').addEventListener('click',()=>setView('week'));document.getElementById('btnHabits').addEventListener('click',()=>setView('habits'));document.getElementById('btnAnalytics').addEventListener('click',()=>setView('analytics'));document.getElementById('btnTogglePeriods').addEventListener('click',()=>{const current=localStorage.getItem('showPeriods')!=='false';localStorage.setItem('showPeriods',(!current).toString());renderView()});

// Backup System
document.getElementById('btnBackup').addEventListener('click',()=>{document.getElementById('backupModal').classList.add('show')});
document.getElementById('btnCloseBackup').addEventListener('click',()=>{document.getElementById('backupModal').classList.remove('show')});
document.getElementById('backupModal').addEventListener('click',(e)=>{if(e.target.id==='backupModal'){document.getElementById('backupModal').classList.remove('show')}});

document.getElementById('btnExport').addEventListener('click',()=>{
    const data={weekData:weekData,habitsHistory:habitsHistory,exportDate:new Date().toISOString(),version:'1.0'};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`flowly-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Backup exportado com sucesso!');
});

document.getElementById('fileImport').addEventListener('change',(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=(event)=>{
        try{
            const data=JSON.parse(event.target.result);
            if(data.weekData&&data.habitsHistory){
                if(confirm('‚ö†Ô∏è Isso vai SUBSTITUIR todos os dados atuais. Tem certeza?')){
                    Object.keys(weekData).forEach(day=>{weekData[day]=data.weekData[day]||{}});
                    habitsHistory=data.habitsHistory;
                    saveToLocalStorage();
                    localStorage.setItem('habitsHistory',JSON.stringify(habitsHistory));
                    alert('‚úÖ Backup importado com sucesso!');
                    document.getElementById('backupModal').classList.remove('show');
                    renderView();
                }
            }else{
                alert('‚ùå Arquivo inv√°lido! Use um backup exportado pelo Flowly.');
            }
        }catch(err){
            alert('‚ùå Erro ao ler arquivo: '+err.message);
        }
        e.target.value='';
    };
    reader.readAsText(file);
});

document.getElementById('btnClearAll').addEventListener('click',()=>{
    if(confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai apagar TUDO permanentemente.\n\nTem certeza absoluta?')){
        if(confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nVoc√™ vai perder todas as tasks e h√°bitos. Continuar?')){
            localStorage.clear();
            habitsHistory={};
            Object.keys(weekData).forEach(day=>{
                weekData[day]={};
            });
            alert('‚úÖ Todos os dados foram removidos!');
            document.getElementById('backupModal').classList.remove('show');
            renderView();
        }
    }
});

// Auth UI - garantir que DOM est√° carregado
document.addEventListener('DOMContentLoaded',()=>{
document.getElementById('btnShowSignup').addEventListener('click',()=>{document.getElementById('authLogin').style.display='none';document.getElementById('authSignup').style.display='block';showAuthMessage('','')});
document.getElementById('btnShowLogin').addEventListener('click',()=>{document.getElementById('authSignup').style.display='none';document.getElementById('authLogin').style.display='block';showAuthMessage('','')});
document.getElementById('btnLogin').addEventListener('click',async()=>{const email=document.getElementById('loginEmail').value;const password=document.getElementById('loginPassword').value;if(!email||!password){showAuthMessage('Preencha email e senha','error');return}await signIn(email,password)});
document.getElementById('btnSignup').addEventListener('click',async()=>{const email=document.getElementById('signupEmail').value;const password=document.getElementById('signupPassword').value;if(!email||!password){showAuthMessage('Preencha email e senha','error');return}if(password.length<6){showAuthMessage('Senha deve ter no m√≠nimo 6 caracteres','error');return}await signUp(email,password)});
document.getElementById('loginPassword').addEventListener('keypress',(e)=>{if(e.key==='Enter')document.getElementById('btnLogin').click()});
document.getElementById('signupPassword').addEventListener('keypress',(e)=>{if(e.key==='Enter')document.getElementById('btnSignup').click()});
document.getElementById('btnUser').addEventListener('click',()=>{document.getElementById('userDropdown').classList.toggle('show')});
document.getElementById('btnLogout').addEventListener('click',signOut);
document.addEventListener('click',(e)=>{if(!e.target.closest('.user-menu')){document.getElementById('userDropdown').classList.remove('show')}});

loadFromLocalStorage();
setTimeout(()=>checkAuth(),100);
});
    </script>
</body>
</html>

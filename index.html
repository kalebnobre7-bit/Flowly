
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowly - To-Do Inteligente</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0a0a0a; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .task-completed { text-decoration: line-through; opacity: 0.5; }
        .day-column { border-right: 1px solid #1a1a1a; }
        .day-column:last-child { border-right: none; }
        .day-column.drag-over { background: #1a1a2a; border: 2px dashed #3b82f6; }
        .period-section { position: relative; }
        .period-section:hover .add-task-btn { opacity: 1; }
        .add-task-btn { opacity: 0; transition: opacity 0.2s; cursor: pointer; padding: 6px 10px; background: #1a1a1a; border: 1px dashed #404040; border-radius: 4px; font-size: 12px; color: #888; display: flex; align-items: center; gap: 6px; margin-top: 4px; }
        .add-task-btn:hover { background: #252525; border-color: #555; color: #aaa; }
        .task-input { background: #1a1a1a; border: 2px solid #3b82f6; border-radius: 4px; padding: 6px 10px; color: #e5e5e5; font-size: 13px; width: 100%; outline: none; margin-top: 4px; }
        .period-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; background: #1a1a1a; display: inline-block; margin-bottom: 8px; }
        .checkbox-custom { appearance: none; width: 18px; height: 18px; border: 2px solid #404040; border-radius: 4px; cursor: pointer; flex-shrink: 0; }
        .checkbox-custom:checked { background: #3b82f6; border-color: #3b82f6; }
        .checkbox-custom:checked::after { content: '‚úì'; color: white; font-size: 12px; display: flex; justify-content: center; align-items: center; }
        .task-item { cursor: grab; transition: all 0.2s; position: relative; }
        .task-item:active { cursor: grabbing; opacity: 0.5; }
        .task-item.dragging { opacity: 0.3; }
        .task-item.is-habit::before { content: 'üîÑ'; position: absolute; left: -20px; font-size: 12px; }
        .drop-indicator { height: 3px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); margin: 2px 0; opacity: 0; transition: opacity 0.15s; border-radius: 2px; }
        .drop-indicator.show { opacity: 1; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }
        .empty-line { min-height: 20px; border-radius: 4px; transition: all 0.2s; position: relative; margin: 2px 0; }
        .empty-line:hover { background: rgba(59, 130, 246, 0.1); }
        .empty-line-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s; display: flex; gap: 4px; }
        .empty-line:hover .empty-line-actions { opacity: 1; }
        .empty-line-btn { width: 16px; height: 16px; border-radius: 3px; background: #2a2a2a; border: 1px solid #404040; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #888; transition: all 0.15s; }
        .empty-line-btn:hover { background: #333; color: #fff; border-color: #555; }
        .task-label { user-select: none; }
        .task-label[contenteditable="true"] { user-select: text; outline: 2px solid #3b82f6; outline-offset: 2px; border-radius: 3px; padding: 2px 4px; margin: -2px -4px; }
        .color-menu, .edit-toolbar { position: absolute; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .color-menu.show, .edit-toolbar.show { display: flex; gap: 4px; }
        .color-swatch { width: 28px; height: 28px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
        .color-swatch:hover { transform: scale(1.1); border-color: #555; }
        .toolbar-btn { padding: 6px 10px; background: transparent; border: none; color: #999; cursor: pointer; border-radius: 4px; font-size: 14px; transition: all 0.15s; }
        .toolbar-btn:hover { background: #2a2a2a; color: #fff; }
        .floating-add-btn { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transition: all 0.2s; z-index: 100; }
        .floating-add-btn:hover { transform: scale(1.1); background: #4f96ff; }
        .quick-add-menu { position: fixed; bottom: 100px; right: 30px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px; display: none; z-index: 999; box-shadow: 0 4px 12px rgba(0,0,0,0.5); min-width: 200px; }
        .quick-add-menu.show { display: block; }
        .quick-add-option { padding: 10px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: all 0.15s; }
        .quick-add-option:hover { background: #2a2a2a; }
        .habit-card { background: #1a1a1a; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid #252525; }
        .habit-card:hover { border-color: #333; }
        .streak-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .stat-card { background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%); border-radius: 12px; padding: 24px; border: 1px solid #252525; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-card:hover { border-color: #333; transform: translateY(-2px); transition: all 0.2s; }
        .chart-container { background: #1a1a1a; border-radius: 12px; padding: 24px; border: 1px solid #252525; margin-bottom: 20px; }
        .insight-card { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #3b82f6; position: relative; overflow: hidden; }
        .insight-card::before { content: 'üí°'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 48px; opacity: 0.2; }
        .progress-bar { width: 100%; height: 8px; background: #252525; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s; }
        .big-number { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #3b82f6, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .backup-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .backup-modal.show { display: flex; }
        .backup-content { background: #1a1a1a; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; border: 1px solid #333; }
        .backup-btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 14px; }
        .backup-btn-primary { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .backup-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .backup-btn-danger { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
        .backup-btn-danger:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239,68,68,0.4); }
        .backup-btn-secondary { background: #2a2a2a; color: #e5e5e5; }
        .backup-btn-secondary:hover { background: #333; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label { display: block; padding: 12px 24px; background: #2a2a2a; color: #e5e5e5; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; border: 2px dashed #404040; }
        .file-input-label:hover { background: #333; border-color: #555; }
        .color-default { color: #e5e5e5; } .color-gray { color: #9b9a97; } .color-brown { color: #937264; } .color-orange { color: #d9730d; } .color-yellow { color: #cb912f; } .color-green { color: #448361; } .color-blue { color: #337ea9; } .color-purple { color: #9065b0; } .color-pink { color: #c14c8a; } .color-red { color: #d44c47; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1600px] mx-auto">
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                    <img src="logo_flowly.png" alt="Flowly" class="h-10">
                    <h1 class="text-4xl font-bold" id="viewTitle">Week</h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex gap-2 bg-[#1a1a1a] p-1 rounded-lg">
                        <button id="btnToday" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Hoje</button>
                        <button id="btnWeek" class="px-6 py-2 rounded-md text-sm font-medium transition-all bg-[#2a2a2a] text-white">Semana</button>
                        <button id="btnHabits" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">H√°bitos</button>
                        <button id="btnAnalytics" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Analytics</button>
                    </div>
                    <button id="btnBackup" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-[#1a1a1a] text-gray-400 hover:text-white hover:bg-[#2a2a2a] border border-[#333]">üíæ Backup</button>
                </div>
            </div>
            <p class="text-gray-400 text-lg">S√≥ existe o hoje, foco no que traz grana.</p>
        </div>
        <div id="contentArea">
            <div id="weekGrid" class="grid grid-cols-7 gap-0"></div>
            <div id="habitsView" class="hidden"></div>
            <div id="analyticsView" class="hidden"></div>
        </div>
    </div>
    <div id="floatingAddBtn" class="floating-add-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
    <div id="quickAddMenu" class="quick-add-menu"><div class="quick-add-option" data-type="routine">üìã Adicionar rotina di√°ria</div><div class="quick-add-option" data-type="custom">‚úèÔ∏è Nova tarefa customizada</div></div>
    <div id="colorMenu" class="color-menu"><div class="color-swatch" style="background: #e5e5e5;" data-color="default"></div><div class="color-swatch" style="background: #9b9a97;" data-color="gray"></div><div class="color-swatch" style="background: #937264;" data-color="brown"></div><div class="color-swatch" style="background: #d9730d;" data-color="orange"></div><div class="color-swatch" style="background: #cb912f;" data-color="yellow"></div><div class="color-swatch" style="background: #448361;" data-color="green"></div><div class="color-swatch" style="background: #337ea9;" data-color="blue"></div><div class="color-swatch" style="background: #9065b0;" data-color="purple"></div><div class="color-swatch" style="background: #c14c8a;" data-color="pink"></div><div class="color-swatch" style="background: #d44c47;" data-color="red"></div></div>
    <div id="editToolbar" class="edit-toolbar">
        <button class="toolbar-btn" data-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
        <button class="toolbar-btn" data-action="italic" title="It√°lico (Ctrl+I)"><em>I</em></button>
        <button class="toolbar-btn" data-action="strikethrough" title="Riscado"><s>S</s></button>
        <div style="width: 1px; background: #333; margin: 0 2px;"></div>
        <button class="toolbar-btn" data-action="color">üé®</button>
        <button class="toolbar-btn" data-action="habit">üîÑ</button>
        <div style="width: 1px; background: #333; margin: 0 2px;"></div>
        <button class="toolbar-btn" data-action="delete">üóëÔ∏è</button>
    </div>
    
    <!-- Backup Modal -->
    <div id="backupModal" class="backup-modal">
        <div class="backup-content">
            <h2 class="text-2xl font-bold mb-6">üíæ Backup & Dados</h2>
            
            <div class="space-y-4">
                <div>
                    <button id="btnExport" class="backup-btn backup-btn-primary w-full mb-2">
                        üì• Exportar Dados (JSON)
                    </button>
                    <p class="text-xs text-gray-400">Baixa todas as suas tasks e h√°bitos</p>
                </div>
                
                <div>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileImport" accept=".json">
                        <label for="fileImport" class="file-input-label">
                            üì§ Importar Backup
                        </label>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Restaura dados de um arquivo JSON</p>
                </div>
                
                <div class="border-t border-[#333] pt-4 mt-4">
                    <button id="btnClearAll" class="backup-btn backup-btn-danger w-full mb-2">
                        üóëÔ∏è Limpar Todos os Dados
                    </button>
                    <p class="text-xs text-gray-400">Remove tudo e come√ßa do zero</p>
                </div>
            </div>
            
            <button id="btnCloseBackup" class="backup-btn backup-btn-secondary w-full mt-6">Fechar</button>
        </div>
    </div>
    
    <script>
let currentView='week',draggedTask=null,currentEditingTask=null;
const dailyRoutine=[{text:"Ora√ß√£o e Salmo",completed:false,color:"default",isHabit:false},{text:"Venvanse",completed:false,color:"default",isHabit:false},{text:"Ler metas e mantra; celular na gaveta",completed:false,color:"default",isHabit:false}];
const weekData={"Segunda":{},"Ter√ßa":{},"Quarta":{},"Quinta":{},"Sexta":{},"S√°bado":{},"Domingo":{}};
let habitsHistory=JSON.parse(localStorage.getItem('habitsHistory')||'{}');

function getAllHabits(){const habits=[],habitMap=new Map();Object.entries(weekData).forEach(([day,periods])=>{Object.entries(periods).forEach(([period,tasks])=>{tasks.forEach(task=>{if(task.isHabit&&!habitMap.has(task.text)){habitMap.set(task.text,{text:task.text,color:task.color,completedToday:task.completed})}})})});return Array.from(habitMap.values())}

function getHabitStreak(habitText){if(!habitsHistory[habitText])return 0;const today=new Date();let streak=0,currentDate=new Date(today);while(true){const dateKey=currentDate.toISOString().split('T')[0];if(habitsHistory[habitText][dateKey]){streak++;currentDate.setDate(currentDate.getDate()-1)}else{break}}return streak}

function getHabitCompletionRate(habitText,days=30){if(!habitsHistory[habitText])return 0;const today=new Date();let completed=0;for(let i=0;i<days;i++){const date=new Date(today);date.setDate(date.getDate()-i);const dateKey=date.toISOString().split('T')[0];if(habitsHistory[habitText][dateKey]){completed++}}return Math.round((completed/days)*100)}

function markHabitCompleted(habitText,completed){const today=new Date().toISOString().split('T')[0];if(!habitsHistory[habitText]){habitsHistory[habitText]={}}if(completed){habitsHistory[habitText][today]=true}else{delete habitsHistory[habitText][today]}localStorage.setItem('habitsHistory',JSON.stringify(habitsHistory))}

function renderAnalyticsView(){const view=document.getElementById('analyticsView');let totalTasks=0,completedTasks=0,totalHabits=getAllHabits().length,completedHabitsToday=getAllHabits().filter(h=>h.completedToday).length;Object.values(weekData).forEach(periods=>{Object.values(periods).forEach(tasks=>{tasks.forEach(task=>{totalTasks++;if(task.completed)completedTasks++})})});const completionRate=totalTasks>0?Math.round((completedTasks/totalTasks)*100):0;const habitRate=totalHabits>0?Math.round((completedHabitsToday/totalHabits)*100):0;const bestStreak=Math.max(...getAllHabits().map(h=>getHabitStreak(h.text)),0);const insights=[];if(completionRate>70)insights.push("üî• Voc√™ t√° VOANDO! "+completionRate+"% de conclus√£o!");if(bestStreak>=3)insights.push("‚ö° Streak de "+bestStreak+" dias no h√°bito mais forte!");if(habitRate===100)insights.push("üí™ TODOS os h√°bitos feitos hoje! Monstro!");const periodStats={morning:0,afternoon:0,night:0};Object.values(weekData).forEach(periods=>{Object.entries(periods).forEach(([period,tasks])=>{const completed=tasks.filter(t=>t.completed).length;if(period.includes('Manh√£'))periodStats.morning+=completed;else if(period.includes('Tarde'))periodStats.afternoon+=completed;else periodStats.night+=completed})});let bestPeriod='Manh√£';if(periodStats.afternoon>periodStats.morning&&periodStats.afternoon>periodStats.night)bestPeriod='Tarde';if(periodStats.night>periodStats.morning&&periodStats.night>periodStats.afternoon)bestPeriod='Noite';if(periodStats.morning>0||periodStats.afternoon>0||periodStats.night>0)insights.push("‚è∞ Seu melhor per√≠odo √© "+bestPeriod+"!");let html=`<div class="max-w-6xl mx-auto"><h2 class="text-3xl font-bold mb-8">Analytics üìä</h2><div class="grid grid-cols-4 gap-4 mb-8">`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Taxa de Conclus√£o</div><div class="big-number">${completionRate}%</div><div class="text-xs text-gray-500 mt-2">${completedTasks} de ${totalTasks} tasks</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">H√°bitos Hoje</div><div class="big-number">${habitRate}%</div><div class="text-xs text-gray-500 mt-2">${completedHabitsToday} de ${totalHabits} h√°bitos</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Melhor Streak</div><div class="big-number">${bestStreak}</div><div class="text-xs text-gray-500 mt-2">dias seguidos</div></div>`;html+=`<div class="stat-card"><div class="text-gray-400 text-sm mb-2">Produtividade</div><div class="big-number ${completionRate>=70?'trend-up':'trend-down'}">${completionRate>=70?'Alta':'M√©dia'}</div><div class="text-xs text-gray-500 mt-2">Score geral</div></div>`;html+=`</div>`;if(insights.length>0){html+=`<div class="mb-8"><h3 class="text-xl font-bold mb-4">üí° Insights Inteligentes</h3>`;insights.forEach(insight=>{html+=`<div class="insight-card"><p class="text-white font-medium">${insight}</p></div>`});html+=`</div>`}html+=`<div class="grid grid-cols-2 gap-6"><div class="chart-container"><h3 class="text-lg font-semibold mb-4">Produtividade por Per√≠odo</h3><canvas id="periodChart"></canvas></div><div class="chart-container"><h3 class="text-lg font-semibold mb-4">Status de H√°bitos</h3><canvas id="habitsChart"></canvas></div></div></div>`;view.innerHTML=html;setTimeout(()=>{const periodCtx=document.getElementById('periodChart');if(periodCtx){new Chart(periodCtx,{type:'bar',data:{labels:['Manh√£','Tarde','Noite'],datasets:[{label:'Tasks Conclu√≠das',data:[periodStats.morning,periodStats.afternoon,periodStats.night],backgroundColor:['rgba(59, 130, 246, 0.8)','rgba(96, 165, 250, 0.8)','rgba(167, 139, 250, 0.8)'],borderColor:['rgb(59, 130, 246)','rgb(96, 165, 250)','rgb(167, 139, 250)'],borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}}}})}const habitsCtx=document.getElementById('habitsChart');if(habitsCtx){new Chart(habitsCtx,{type:'doughnut',data:{labels:['Conclu√≠dos','Pendentes'],datasets:[{data:[completedHabitsToday,totalHabits-completedHabitsToday],backgroundColor:['rgba(16, 185, 129, 0.8)','rgba(55, 65, 81, 0.8)'],borderColor:['rgb(16, 185, 129)','rgb(55, 65, 81)'],borderWidth:2}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#9ca3af'}}}}})}},100)}

function renderHabitsView(){const view=document.getElementById('habitsView'),habits=getAllHabits();if(habits.length===0){view.innerHTML='<p class="text-gray-400 text-center py-20">Nenhum h√°bito cadastrado ainda. Marque tasks como h√°bitos clicando com o bot√£o direito!</p>';return}let html=`<div class="max-w-4xl mx-auto"><h2 class="text-2xl font-bold mb-6">Meus H√°bitos üîÑ</h2><div class="grid grid-cols-3 gap-4 mb-8"><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Total de H√°bitos</div><div class="text-3xl font-bold">${habits.length}</div></div><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Conclu√≠dos Hoje</div><div class="text-3xl font-bold text-green-400">${habits.filter(h=>h.completedToday).length}</div></div><div class="stat-card"><div class="text-gray-400 text-sm mb-1">Taxa Hoje</div><div class="text-3xl font-bold text-blue-400">${habits.length>0?Math.round((habits.filter(h=>h.completedToday).length/habits.length)*100):0}%</div></div></div><div class="space-y-3">`;habits.forEach((habit,index)=>{const streak=getHabitStreak(habit.text),completionRate=getHabitCompletionRate(habit.text,30);html+=`<div class="habit-card"><div class="flex items-start justify-between mb-3"><div class="flex items-start gap-3 flex-1"><input type="checkbox" class="checkbox-custom mt-1" ${habit.completedToday?'checked':''} onchange="toggleHabitToday('${habit.text.replace(/'/g,"\\'")}', this.checked)"><div class="flex-1"><div class="color-${habit.color} font-medium mb-2">${habit.text}</div><div class="flex items-center gap-3">${streak>0?`<span class="streak-badge">üî• ${streak} ${streak===1?'dia':'dias'}</span>`:''}<span class="text-xs text-gray-400">${completionRate}% nos √∫ltimos 30 dias</span></div></div></div></div><div class="progress-bar"><div class="progress-fill" style="width: ${completionRate}%"></div></div></div>`});html+=`</div></div>`;view.innerHTML=html}

function toggleHabitToday(habitText,completed){Object.entries(weekData).forEach(([day,periods])=>{Object.entries(periods).forEach(([period,tasks])=>{tasks.forEach(task=>{if(task.isHabit&&task.text===habitText){task.completed=completed}})})});markHabitCompleted(habitText,completed);saveToLocalStorage();renderHabitsView()}

function createTaskElement(day,period,task,index){const wrapper=document.createElement('div');const dropIndicator=document.createElement('div');dropIndicator.className='drop-indicator';dropIndicator.dataset.day=day;dropIndicator.dataset.period=period;dropIndicator.dataset.insertIndex=index;dropIndicator.addEventListener('dragover',(e)=>{e.preventDefault();dropIndicator.classList.add('show')});dropIndicator.addEventListener('dragleave',()=>{dropIndicator.classList.remove('show')});dropIndicator.addEventListener('drop',(e)=>{e.preventDefault();e.stopPropagation();dropIndicator.classList.remove('show');if(!draggedTask)return;if(draggedTask.day===day&&draggedTask.period===period&&draggedTask.index===index){return}const originalTasks=weekData[draggedTask.day][draggedTask.period];const taskToMove=originalTasks.splice(draggedTask.index,1)[0];if(!weekData[day][period]){weekData[day][period]=[]}let insertIdx=parseInt(dropIndicator.dataset.insertIndex);if(draggedTask.day===day&&draggedTask.period===period&&draggedTask.index<insertIdx){insertIdx--}weekData[day][period].splice(insertIdx,0,taskToMove);saveToLocalStorage();renderView()});const taskDiv=document.createElement('div');taskDiv.className=`task-item flex items-start gap-2 mb-2 ${task.isHabit?'is-habit':''}`;taskDiv.draggable=true;taskDiv.dataset.day=day;taskDiv.dataset.period=period;taskDiv.dataset.index=index;const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.className='checkbox-custom mt-1';checkbox.checked=task.completed;checkbox.addEventListener('change',(e)=>{e.stopPropagation();taskLabel.classList.toggle('task-completed');task.completed=checkbox.checked;if(task.isHabit){markHabitCompleted(task.text,task.completed)}saveToLocalStorage()});const taskLabel=document.createElement('span');taskLabel.className=`task-label text-sm cursor-pointer color-${task.color} ${task.completed?'task-completed':''}`;taskLabel.innerHTML=task.text;taskLabel.addEventListener('dblclick',(e)=>{e.stopPropagation();startEditing(taskLabel,task,taskDiv)});taskLabel.addEventListener('contextmenu',(e)=>{e.preventDefault();e.stopPropagation();showEditToolbar(e,task,taskLabel)});taskLabel.addEventListener('keydown',(e)=>{if(e.ctrlKey||e.metaKey){if(e.key==='b'){e.preventDefault();document.execCommand('bold',false,null)}else if(e.key==='i'){e.preventDefault();document.execCommand('italic',false,null)}}});taskDiv.addEventListener('dragstart',handleDragStart);taskDiv.addEventListener('dragend',handleDragEnd);taskDiv.appendChild(checkbox);taskDiv.appendChild(taskLabel);wrapper.appendChild(dropIndicator);wrapper.appendChild(taskDiv);return wrapper}

function createAddTaskButton(day,period){const btn=document.createElement('div');btn.className='add-task-btn';btn.innerHTML='<span style="font-size: 16px;">+</span> Adicionar tarefa';btn.addEventListener('click',(e)=>{e.stopPropagation();showTaskInput(btn,day,period)});return btn}

function showTaskInput(button,day,period){const input=document.createElement('input');input.type='text';input.className='task-input';input.placeholder='Digite a tarefa...';button.replaceWith(input);input.focus();const saveTask=()=>{const text=input.value.trim();if(text){if(!weekData[day][period]){weekData[day][period]=[]}weekData[day][period].push({text:text,completed:false,color:'default',isHabit:false});saveToLocalStorage()}renderView()};input.addEventListener('keydown',(e)=>{if(e.key==='Enter'){saveTask()}else if(e.key==='Escape'){renderView()}});input.addEventListener('blur',()=>{setTimeout(()=>saveTask(),100)})}

function addDailyRoutine(day){const morningPeriod="Manh√£ (8h-12h)";if(!weekData[day][morningPeriod]){weekData[day][morningPeriod]=[]}dailyRoutine.forEach(task=>{weekData[day][morningPeriod].push({...task})});saveToLocalStorage();renderView()}

function startEditing(label,task,taskDiv){if(currentEditingTask){finishEditing()}currentEditingTask={label,task,originalText:task.text,taskDiv};label.contentEditable=true;label.focus();const range=document.createRange();range.selectNodeContents(label);const sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);taskDiv.draggable=false;const handleKeyDown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();finishEditing();const day=taskDiv.dataset.day,period=taskDiv.dataset.period,index=parseInt(taskDiv.dataset.index);setTimeout(()=>{if(!weekData[day][period]){weekData[day][period]=[]}weekData[day][period].splice(index+1,0,{text:'',completed:false,color:'default',isHabit:false});saveToLocalStorage();renderView();setTimeout(()=>{const allTasks=document.querySelectorAll('.task-item');const nextTask=allTasks[Array.from(allTasks).findIndex(t=>t===taskDiv)+1];if(nextTask){const nextLabel=nextTask.querySelector('.task-label');if(nextLabel){startEditing(nextLabel,weekData[day][period][index+1],nextTask)}}},50)},10)}else if(e.key==='Escape'){task.text=currentEditingTask.originalText;label.innerHTML=task.text;finishEditing()}else if((e.key==='Backspace'||e.key==='Delete')&&label.textContent.trim()===''){e.preventDefault();const day=taskDiv.dataset.day,period=taskDiv.dataset.period,index=parseInt(taskDiv.dataset.index);deleteTask(day,period,index);finishEditing();renderView()}else if(e.key==='Tab'){e.preventDefault();const currentText=label.textContent;label.textContent='    '+currentText;const range=document.createRange();range.selectNodeContents(label);range.collapse(false);const sel=window.getSelection();sel.removeAllRanges();sel.addRange(range)}};label.addEventListener('keydown',handleKeyDown);label.addEventListener('blur',finishEditing)}

function finishEditing(){if(!currentEditingTask)return;const{label,task}=currentEditingTask;label.contentEditable=false;task.text=label.innerHTML.trim();const taskDiv=label.closest('.task-item');if(taskDiv)taskDiv.draggable=true;saveToLocalStorage();currentEditingTask=null}

function showEditToolbar(e,task,label){const toolbar=document.getElementById('editToolbar'),colorMenu=document.getElementById('colorMenu');colorMenu.classList.remove('show');toolbar.style.left=e.pageX+'px';toolbar.style.top=e.pageY+'px';toolbar.classList.add('show');toolbar.dataset.taskDay=label.closest('.task-item').dataset.day;toolbar.dataset.taskPeriod=label.closest('.task-item').dataset.period;toolbar.dataset.taskIndex=label.closest('.task-item').dataset.index;const buttons=toolbar.querySelectorAll('.toolbar-btn');buttons.forEach(btn=>{btn.onclick=(e)=>{e.stopPropagation();const action=btn.dataset.action;if(action==='bold'){document.execCommand('bold',false,null);label.focus()}else if(action==='italic'){document.execCommand('italic',false,null);label.focus()}else if(action==='strikethrough'){document.execCommand('strikeThrough',false,null);label.focus()}else if(action==='color'){showColorMenu(e,task,label)}else if(action==='habit'){task.isHabit=!task.isHabit;saveToLocalStorage();toolbar.classList.remove('show');renderView()}else if(action==='delete'){deleteTask(toolbar.dataset.taskDay,toolbar.dataset.taskPeriod,toolbar.dataset.taskIndex);toolbar.classList.remove('show');renderView()}}})}

function showColorMenu(e,task,label){const colorMenu=document.getElementById('colorMenu'),toolbar=document.getElementById('editToolbar');const rect=toolbar.getBoundingClientRect();colorMenu.style.left=rect.left+'px';colorMenu.style.top=(rect.bottom+5)+'px';colorMenu.classList.add('show');const swatches=colorMenu.querySelectorAll('.color-swatch');swatches.forEach(swatch=>{swatch.onclick=()=>{const color=swatch.dataset.color;task.color=color;label.className=label.className.replace(/color-\w+/,`color-${color}`);saveToLocalStorage();colorMenu.classList.remove('show');toolbar.classList.remove('show')}})}

function deleteTask(day,period,index){const tasks=weekData[day][period];tasks.splice(index,1);saveToLocalStorage()}

function handleDragStart(e){draggedTask={day:this.dataset.day,period:this.dataset.period,index:parseInt(this.dataset.index),task:weekData[this.dataset.day][this.dataset.period][parseInt(this.dataset.index)]};this.classList.add('dragging');e.dataTransfer.effectAllowed='move'}

function handleDragEnd(e){this.classList.remove('dragging');document.querySelectorAll('.day-column').forEach(col=>{col.classList.remove('drag-over')})}

function handleDragOver(e){if(e.preventDefault){e.preventDefault()}e.dataTransfer.dropEffect='move';return false}

function handleDragEnter(e){this.classList.add('drag-over')}

function handleDragLeave(e){this.classList.remove('drag-over')}

function handleDrop(e){if(e.stopPropagation){e.stopPropagation()}this.classList.remove('drag-over');if(!draggedTask)return;const targetDay=this.dataset.day,targetPeriod=this.dataset.period||Object.keys(weekData[targetDay])[0];if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod){draggedTask=null;return false}const originalTasks=weekData[draggedTask.day][draggedTask.period];originalTasks.splice(draggedTask.index,1);if(!weekData[targetDay][targetPeriod]){weekData[targetDay][targetPeriod]=[]}weekData[targetDay][targetPeriod].push(draggedTask.task);saveToLocalStorage();renderView();draggedTask=null;return false}

function renderWeek(){const grid=document.getElementById('weekGrid');grid.innerHTML='';grid.className='grid grid-cols-7 gap-0';Object.entries(weekData).forEach(([day,periods])=>{const dayColumn=document.createElement('div');dayColumn.className='day-column p-4 min-h-[600px]';dayColumn.dataset.day=day;dayColumn.addEventListener('dragover',handleDragOver);dayColumn.addEventListener('dragenter',handleDragEnter);dayColumn.addEventListener('dragleave',handleDragLeave);dayColumn.addEventListener('drop',handleDrop);const dayHeader=document.createElement('h2');dayHeader.className='text-xl font-bold mb-4';dayHeader.textContent=day;dayColumn.appendChild(dayHeader);Object.entries(periods).forEach(([period,tasks])=>{const periodDiv=document.createElement('div');periodDiv.className='period-section mb-6';periodDiv.dataset.period=period;const periodLabel=document.createElement('div');periodLabel.className='period-badge';periodLabel.textContent=period;periodDiv.appendChild(periodLabel);const tasksContainer=document.createElement('div');tasks.forEach((task,index)=>{const taskWrapper=createTaskElement(day,period,task,index);tasksContainer.appendChild(taskWrapper)});const finalDropIndicator=document.createElement('div');finalDropIndicator.className='drop-indicator';finalDropIndicator.dataset.day=day;finalDropIndicator.dataset.period=period;finalDropIndicator.dataset.insertIndex=tasks.length;finalDropIndicator.addEventListener('dragover',(e)=>{e.preventDefault();finalDropIndicator.classList.add('show')});finalDropIndicator.addEventListener('dragleave',()=>{finalDropIndicator.classList.remove('show')});finalDropIndicator.addEventListener('drop',(e)=>{e.preventDefault();e.stopPropagation();finalDropIndicator.classList.remove('show');if(!draggedTask)return;const targetDay=finalDropIndicator.dataset.day;const targetPeriod=finalDropIndicator.dataset.period;const insertIdx=parseInt(finalDropIndicator.dataset.insertIndex);if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index===insertIdx-1){return}const originalTasks=weekData[draggedTask.day][draggedTask.period];const taskToMove=originalTasks.splice(draggedTask.index,1)[0];if(!weekData[targetDay][targetPeriod]){weekData[targetDay][targetPeriod]=[]}let finalInsertIdx=insertIdx;if(draggedTask.day===targetDay&&draggedTask.period===targetPeriod&&draggedTask.index<insertIdx){finalInsertIdx--}weekData[targetDay][targetPeriod].splice(finalInsertIdx,0,taskToMove);saveToLocalStorage();renderView()});tasksContainer.appendChild(finalDropIndicator);periodDiv.appendChild(tasksContainer);const addBtn=createAddTaskButton(day,period);periodDiv.appendChild(addBtn);dayColumn.appendChild(periodDiv)});grid.appendChild(dayColumn)})}

function renderToday(){const grid=document.getElementById('weekGrid');grid.innerHTML='';grid.className='max-w-2xl mx-auto';const days=['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'],today=days[new Date().getDay()],todayData=weekData[today];if(!todayData){grid.innerHTML='<p class="text-gray-400 text-center py-20">Nenhuma tarefa para hoje!</p>';return}const dayContainer=document.createElement('div');dayContainer.className='p-6';dayContainer.dataset.day=today;dayContainer.addEventListener('dragover',handleDragOver);dayContainer.addEventListener('drop',handleDrop);const dateStr=new Date().toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}),todayHeader=document.createElement('h2');todayHeader.className='text-3xl font-bold mb-2 capitalize';todayHeader.textContent=today;dayContainer.appendChild(todayHeader);const dateSubtitle=document.createElement('p');dateSubtitle.className='text-gray-400 mb-8 capitalize';dateSubtitle.textContent=dateStr;dayContainer.appendChild(dateSubtitle);Object.entries(todayData).forEach(([period,tasks])=>{const periodDiv=document.createElement('div');periodDiv.className='period-section mb-8';periodDiv.dataset.period=period;const periodHeader=document.createElement('h3');periodHeader.className='text-xl font-semibold mb-4 text-gray-300';periodHeader.textContent=period;periodDiv.appendChild(periodHeader);tasks.forEach((task,index)=>{const taskDiv=createTaskElement(today,period,task,index);taskDiv.className=`task-item flex items-start gap-3 mb-3 p-3 bg-[#1a1a1a] rounded-lg hover:bg-[#252525] transition-all ${task.isHabit?'is-habit':''}`;periodDiv.appendChild(taskDiv)});const addBtn=createAddTaskButton(today,period);periodDiv.appendChild(addBtn);dayContainer.appendChild(periodDiv)});grid.appendChild(dayContainer)}

function renderView(){const weekGrid=document.getElementById('weekGrid'),habitsView=document.getElementById('habitsView'),analyticsView=document.getElementById('analyticsView');weekGrid.classList.add('hidden');habitsView.classList.add('hidden');analyticsView.classList.add('hidden');if(currentView==='habits'){habitsView.classList.remove('hidden');renderHabitsView()}else if(currentView==='analytics'){analyticsView.classList.remove('hidden');renderAnalyticsView()}else{weekGrid.classList.remove('hidden');if(currentView==='week'){renderWeek()}else{renderToday()}}}

function setView(view){currentView=view;const btnToday=document.getElementById('btnToday'),btnWeek=document.getElementById('btnWeek'),btnHabits=document.getElementById('btnHabits'),btnAnalytics=document.getElementById('btnAnalytics'),viewTitle=document.getElementById('viewTitle');btnToday.className='px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white';btnWeek.className='px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white';btnHabits.className='px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white';btnAnalytics.className='px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white';if(view==='today'){btnToday.className='px-6 py-2 rounded-md text-sm font-medium transition-all bg-[#2a2a2a] text-white';viewTitle.textContent='Hoje'}else if(view==='habits'){btnHabits.className='px-6 py-2 rounded-md text-sm font-medium transition-all bg-[#2a2a2a] text-white';viewTitle.textContent='H√°bitos'}else if(view==='analytics'){btnAnalytics.className='px-6 py-2 rounded-md text-sm font-medium transition-all bg-[#2a2a2a] text-white';viewTitle.textContent='Analytics'}else{btnWeek.className='px-6 py-2 rounded-md text-sm font-medium transition-all bg-[#2a2a2a] text-white';viewTitle.textContent='Week'}renderView()}

function saveToLocalStorage(){localStorage.setItem('weekData',JSON.stringify(weekData))}

function loadFromLocalStorage(){const saved=localStorage.getItem('weekData');if(saved){const savedData=JSON.parse(saved);Object.keys(weekData).forEach(day=>{if(savedData[day]){weekData[day]=savedData[day]}})}}

document.getElementById('floatingAddBtn').addEventListener('click',()=>{const menu=document.getElementById('quickAddMenu');menu.classList.toggle('show')});document.querySelectorAll('.quick-add-option').forEach(option=>{option.addEventListener('click',()=>{const type=option.dataset.type,days=['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'],today=days[new Date().getDay()];if(type==='routine'){addDailyRoutine(today)}else if(type==='custom'){setTimeout(()=>{const firstAddBtn=document.querySelector('.add-task-btn');if(firstAddBtn)firstAddBtn.click()},100)}document.getElementById('quickAddMenu').classList.remove('show')})});document.addEventListener('click',(e)=>{if(!e.target.closest('#editToolbar')&&!e.target.closest('#colorMenu')){document.getElementById('editToolbar').classList.remove('show');document.getElementById('colorMenu').classList.remove('show')}if(!e.target.closest('#floatingAddBtn')&&!e.target.closest('#quickAddMenu')){document.getElementById('quickAddMenu').classList.remove('show')}});document.getElementById('btnToday').addEventListener('click',()=>setView('today'));document.getElementById('btnWeek').addEventListener('click',()=>setView('week'));document.getElementById('btnHabits').addEventListener('click',()=>setView('habits'));document.getElementById('btnAnalytics').addEventListener('click',()=>setView('analytics'));

// Backup System
document.getElementById('btnBackup').addEventListener('click',()=>{document.getElementById('backupModal').classList.add('show')});
document.getElementById('btnCloseBackup').addEventListener('click',()=>{document.getElementById('backupModal').classList.remove('show')});
document.getElementById('backupModal').addEventListener('click',(e)=>{if(e.target.id==='backupModal'){document.getElementById('backupModal').classList.remove('show')}});

document.getElementById('btnExport').addEventListener('click',()=>{
    const data={weekData:weekData,habitsHistory:habitsHistory,exportDate:new Date().toISOString(),version:'1.0'};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`flowly-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Backup exportado com sucesso!');
});

document.getElementById('fileImport').addEventListener('change',(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=(event)=>{
        try{
            const data=JSON.parse(event.target.result);
            if(data.weekData&&data.habitsHistory){
                if(confirm('‚ö†Ô∏è Isso vai SUBSTITUIR todos os dados atuais. Tem certeza?')){
                    Object.keys(weekData).forEach(day=>{weekData[day]=data.weekData[day]||{}});
                    habitsHistory=data.habitsHistory;
                    saveToLocalStorage();
                    localStorage.setItem('habitsHistory',JSON.stringify(habitsHistory));
                    alert('‚úÖ Backup importado com sucesso!');
                    document.getElementById('backupModal').classList.remove('show');
                    renderView();
                }
            }else{
                alert('‚ùå Arquivo inv√°lido! Use um backup exportado pelo Flowly.');
            }
        }catch(err){
            alert('‚ùå Erro ao ler arquivo: '+err.message);
        }
        e.target.value='';
    };
    reader.readAsText(file);
});

document.getElementById('btnClearAll').addEventListener('click',()=>{
    if(confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai apagar TUDO permanentemente.\n\nTem certeza absoluta?')){
        if(confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nVoc√™ vai perder todas as tasks e h√°bitos. Continuar?')){
            localStorage.clear();
            habitsHistory={};
            Object.keys(weekData).forEach(day=>{
                weekData[day]={};
            });
            alert('‚úÖ Todos os dados foram removidos!');
            document.getElementById('backupModal').classList.remove('show');
            renderView();
        }
    }
});

loadFromLocalStorage();renderWeek();
    </script>
</body>
</html>

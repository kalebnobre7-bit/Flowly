<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowly</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-body: #000000;
            --bg-card: rgba(28, 28, 30, 0.6);
            --bg-card-hover: rgba(44, 44, 46, 0.8);
            --bg-elevated: rgba(44, 44, 46, 1);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --text-primary: #F5F5F7;
            --text-secondary: #86868b;
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-orange: #FF9F0A;
            --accent-red: #FF453A;
            --radius-card: 18px;
            --radius-sm: 8px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            overflow-x: hidden;
            margin: 0;
            padding: 24px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Navigation */
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 0 4px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-img {
            height: 32px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
        }

        .segmented-control {
            background: rgba(118, 118, 128, 0.24);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2px;
            border-radius: 9px;
            display: flex;
            gap: 1px;
        }

        .segment-btn {
            background: transparent;
            border: none;
            padding: 6px 16px;
            border-radius: 7px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            border: 0.5px solid transparent;
        }

        .segment-btn:hover:not(.active) {
            opacity: 0.8;
        }

        .segment-btn.active {
            background: #636366;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
            font-weight: 600;
        }

        .utility-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }

        .utility-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Grid & Cards */
        .day-column {
            background: transparent;
            border-right: 1px solid var(--border-subtle);
            min-height: 70vh;
            padding: 0 16px 32px 16px;
            transition: background 0.2s;
        }

        .day-column:last-child {
            border-right: none;
        }

        /* Glass effect for active drag */
        .day-column.drag-over {
            background: rgba(10, 132, 255, 0.05);
            border-radius: 12px;
            border-right-color: transparent;
        }

        h2 {
            font-weight: 700;
            font-size: 17px;
            letter-spacing: -0.02em;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        h3 {
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        h3.hidden {
            display: none;
        }

        /* Task Items - Notion-style Minimal */
        .task-item {
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            margin-bottom: 2px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            transition: background 0.15s ease;
            position: relative;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .task-item.is-habit .task-label {
            color: var(--accent-blue) !important;
        }

        /* Checkbox - Refined */
        .checkbox-custom {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1.5px solid #555;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.02);
            margin-top: 2px;
        }

        .checkbox-custom:hover {
            border-color: #888;
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-custom:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 2px 4px rgba(10, 132, 255, 0.3);
        }

        .checkbox-custom:checked::after {
            content: '';
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) translateY(-1px);
        }

        /* Typography & Editing */
        .task-label {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            width: 100%;
            cursor: text;
            transition: opacity 0.2s;
        }

        .task-completed {
            color: var(--text-secondary);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-label[contenteditable="true"] {
            outline: none;
            background: rgba(10, 132, 255, 0.15);
            border-radius: 4px;
            padding: 0 4px;
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.3);
        }

        /* Drag & Drop Visuals */
        .task-drop-zone {
            height: 12px;
            margin: -6px 0;
            position: relative;
            z-index: 5;
            pointer-events: none;
        }

        body.dragging-active .task-drop-zone {
            pointer-events: all;
        }

        .task-drop-zone.show::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 4px;
            right: 4px;
            height: 2px;
            background: var(--accent-blue);
            box-shadow: 0 0 8px var(--accent-blue);
            border-radius: 2px;
            transform: translateY(-50%);
        }

        /* Add Task Button */
        .add-task-btn {
            font-size: 13px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed var(--border-subtle);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            margin-top: 8px;
            opacity: 0.6;
        }

        .add-task-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .task-input {
            background: #1c1c1e;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 14px;
            box-shadow: 0 0 0 2px transparent;
            transition: box-shadow 0.2s;
        }

        .task-input:focus {
            box-shadow: 0 0 0 2px var(--accent-blue);
        }

        /* Floating & Menus */
        .floating-add-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 100;
        }

        .floating-add-btn:hover {
            transform: scale(1.08) rotate(90deg);
        }

        .context-menu {
            position: absolute;
            background: rgba(30, 30, 32, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: flex;
            animation: scaleIn 0.1s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 9999;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #1c1c1e;
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.1s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Color classes */
        .color-default {
            color: #f5f5f7;
        }

        .color-green {
            color: #30d158;
        }

        .color-yellow {
            color: #ffd60a;
        }

        .color-orange {
            color: #ff9f0a;
        }

        .color-red {
            color: #ff453a;
        }

        .drag-handle {
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            cursor: grab;
            color: #555;
            font-size: 12px;
        }

        .task-item:hover .drag-handle {
            opacity: 1;
        }

        .drag-handle:hover {
            color: #fff;
        }
    </style>
</head>

<body class="antialiased">
    <div class="max-w-[1400px] mx-auto">
        <!-- Header -->
        <div class="nav-container">
            <div class="logo-area">
                <div
                    class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center font-bold text-white text-lg italic">
                    F</div>
                <span class="font-semibold text-xl tracking-tight">Flowly</span>
            </div>

            <div class="segmented-control">
                <button id="btnWeek" class="segment-btn active" onclick="setView('week')">Semana</button>
                <button id="btnToday" class="segment-btn" onclick="setView('today')">Hoje</button>
                <button id="btnHabits" class="segment-btn" onclick="setView('habits')">H√°bitos</button>
                <button id="btnAnalytics" class="segment-btn" onclick="setView('analytics')">Analytics</button>
                <button id="btnSettings" class="segment-btn" onclick="setView('settings')">‚öôÔ∏è</button>
            </div>

            <div class="flex items-center gap-3">
                <button id="btnTogglePeriods" class="utility-btn" title="Mostrar/Ocultar per√≠odos">‚ãÆ‚ãÆ</button>
                <button id="btnBackup" class="utility-btn" title="Backup">‚ü≥</button>
                <div class="relative">
                    <button id="btnUser" class="utility-btn">üë§</button>
                    <div id="userDropdown" class="context-menu"
                        style="top: 100%; right: 0; margin-top: 8px; min-width: 180px; display: none; flex-direction: column;">
                        <div id="userEmail" class="p-3 text-xs text-gray-500 border-b border-[#333]">user@email.com
                        </div>
                        <div class="p-2 hover:bg-[#333] cursor-pointer rounded text-sm text-red-400" id="btnLogout">Sair
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="contentArea">
            <div id="weekGrid" class="grid grid-cols-7 gap-0">
                <!-- Javascript will populate this -->
            </div>
            <div id="habitsView" class="hidden"></div>
            <div id="analyticsView" class="hidden"></div>
            <div id="settingsView" class="hidden"></div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div id="floatingAddBtn" class="floating-add-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </div>

    <!-- Quick Add Menu -->
    <div id="quickAddMenu" class="context-menu"
        style="position: fixed; bottom: 100px; right: 32px; min-width: 200px; flex-direction: column; gap: 4px;">
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm" data-type="routine">‚Üª Adicionar
            rotina di√°ria</div>
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm" data-type="custom">+ Nova
            tarefa customizada</div>
    </div>

    <!-- Edit Context Menu -->
    <div id="editToolbar" class="context-menu">
        <button class="toolbar-btn" data-action="bold"><strong>B</strong></button>
        <button class="toolbar-btn" data-action="italic"><em>I</em></button>
        <button class="toolbar-btn" data-action="strikethrough"><s>S</s></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="color">‚óè</button>
        <button class="toolbar-btn" data-action="habit">‚Üª</button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="delete" style="color: var(--accent-red)">√ó</button>
    </div>

    <!-- Color Picker -->
    <div id="colorMenu" class="context-menu" style="gap: 6px;">
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #6b7280;" data-color="default"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #30d158;" data-color="green"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ffd60a;" data-color="yellow"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ff9f0a;" data-color="orange"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ff453a;" data-color="red"></div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay show">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div
                    class="w-12 h-12 bg-blue-500 rounded-xl mx-auto flex items-center justify-center font-bold text-white text-2xl italic mb-4">
                    F</div>
                <h2 class="text-2xl font-bold">Bem-vindo</h2>
            </div>

            <div id="authLogin">
                <input type="email" id="loginEmail" class="task-input mb-3" style="background: rgba(0,0,0,0.3);"
                    placeholder="Email">
                <input type="password" id="loginPassword" class="task-input mb-4" style="background: rgba(0,0,0,0.3);"
                    placeholder="Senha">

                <div class="flex items-center gap-2 mb-6">
                    <input type="checkbox" id="keepLoggedIn" class="checkbox-custom" checked>
                    <label for="keepLoggedIn" class="text-sm text-gray-400">Manter conectado</label>
                </div>

                <button id="btnLogin" class="btn-primary">Entrar</button>
                <button id="btnShowSignup" class="btn-secondary">Criar conta</button>
                <div id="authMessage" class="text-center text-xs mt-4 h-4 text-red-400"></div>
            </div>

            <div id="authSignup" style="display:none;">
                <input type="email" id="signupEmail" class="task-input mb-3" style="background: rgba(0,0,0,0.3);"
                    placeholder="Email">
                <input type="password" id="signupPassword" class="task-input mb-6" style="background: rgba(0,0,0,0.3);"
                    placeholder="Senha (m√≠n. 6 caracteres)">
                <button id="btnSignup" class="btn-primary">Cadastrar</button>
                <button id="btnShowLogin" class="btn-secondary">Voltar</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-6">Backup & Dados</h2>
            <button id="btnExport" class="btn-primary mb-4" style="background: #333;">‚Üì Exportar Dados (JSON)</button>
            <div class="relative mb-6">
                <input type="file" id="fileImport" accept=".json" class="hidden">
                <label for="fileImport" class="btn-secondary block text-center cursor-pointer"
                    style="padding: 12px; border: 1px dashed #555;">‚Üë Importar Backup</label>
            </div>
            <button id="btnClearAll" class="btn-secondary"
                style="color: #ff453a; background: rgba(255, 69, 58, 0.1);">Limpar Tudo</button>
            <button id="btnCloseBackup" class="btn-secondary mt-6">Fechar</button>
        </div>
    </div>

    <script>
        // --- Supabase & Storage Logic ---
        const SUPABASE_URL = 'https://cgrosyjtujakkbjjnmml.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncm9zeWp0dWpha2tiampubW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTA0NzcsImV4cCI6MjA4NjU4NjQ3N30.MsDw0nSiLF1jHWMuVGRgTT6gNUeK328RvGBo-YcFG1A';
        const { createClient } = window.supabase;

        const customStorage = {
            getItem: (key) => localStorage.getItem(key) || sessionStorage.getItem(key),
            setItem: (key, value) => {
                if (localStorage.getItem('flowly_persist_session') === 'true') localStorage.setItem(key, value);
                else sessionStorage.setItem(key, value);
            },
            removeItem: (key) => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            }
        };

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { storage: customStorage, autoRefreshToken: true, persistSession: true, detectSessionInUrl: true }
        });

        let currentUser = null;
        let currentView = 'week';
        let draggedTask = null;
        let currentEditingTask = null;
        const width = 600;

        // Data Structures
        const dailyRoutine = [
            { text: "Ora√ß√£o e Salmo", completed: false, color: "default", isHabit: false },
            { text: "Venvanse", completed: false, color: "default", isHabit: false },
            { text: "Ler metas e mantra; celular na gaveta", completed: false, color: "default", isHabit: false }
        ];
        const weekData = { "Segunda": {}, "Ter√ßa": {}, "Quarta": {}, "Quinta": {}, "Sexta": {}, "S√°bado": {}, "Domingo": {} };
        let habitsHistory = JSON.parse(localStorage.getItem('habitsHistory') || '{}');

        // --- Core Functions ---

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('authModal').classList.remove('show');
                document.getElementById('userEmail').textContent = session.user.email;
                await loadDataFromSupabase();
                renderView();
            } else {
                document.getElementById('authModal').classList.add('show');
            }
        }

        async function signUp(email, password) {
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) { showAuthMessage(error.message); return false; }
            showAuthMessage('Conta criada! Fazendo login...', 'success');
            await signIn(email, password);
            return true;
        }

        async function signIn(email, password) {
            // Salvar prefer√™ncia de "manter conectado" ANTES do login
            const keepLoggedIn = document.getElementById('keepLoggedIn').checked;
            localStorage.setItem('flowly_persist_session', keepLoggedIn.toString());

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) { showAuthMessage(error.message); return false; }

            currentUser = data.user;
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('userEmail').textContent = data.user.email;
            await migrateLocalDataToSupabase();
            await loadDataFromSupabase();
            return true;
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            document.getElementById('authModal').classList.add('show');
            location.reload();
        }

        function showAuthMessage(msg, type = 'error') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.style.color = type === 'error' ? '#ff453a' : '#30d158';
        }

        // --- Sync Logic ---

        async function migrateLocalDataToSupabase() {
            if (!currentUser) return;
            const localData = localStorage.getItem('weekData');
            if (!localData) return;
            // Simplified migration logic retention
            const data = JSON.parse(localData);
            // Migration implementation details omitted for brevity but logic placeholder exists
            localStorage.removeItem('weekData');
        }

        async function loadDataFromSupabase() {
            if (!currentUser) return;
            const { data: tasks } = await supabaseClient.from('tasks').select('*').eq('user_id', currentUser.id);
            if (tasks) {
                Object.keys(weekData).forEach(day => weekData[day] = {});
                tasks.forEach(task => {
                    if (!weekData[task.day][task.period]) weekData[task.day][task.period] = [];
                    weekData[task.day][task.period].push({
                        text: task.text, completed: task.completed, color: task.color,
                        isHabit: task.is_habit, supabaseId: task.id
                    });
                });
                renderView();
            }
            const { data: habits } = await supabaseClient.from('habits_history').select('*').eq('user_id', currentUser.id);
            if (habits) {
                habitsHistory = {};
                habits.forEach(h => {
                    if (!habitsHistory[h.habit_name]) habitsHistory[h.habit_name] = {};
                    habitsHistory[h.habit_name][h.date] = h.completed;
                });
            }
        }

        async function syncTaskToSupabase(day, period, task) {
            if (!currentUser) return;
            // Upsert logic
            if (task.supabaseId) {
                await supabaseClient.from('tasks').update({
                    text: task.text, completed: task.completed, color: task.color, is_habit: task.isHabit, updated_at: new Date().toISOString()
                }).eq('id', task.supabaseId);
            } else {
                const { data } = await supabaseClient.from('tasks').insert({
                    user_id: currentUser.id, day, period, text: task.text, completed: task.completed, color: task.color, is_habit: task.isHabit
                }).select();
                if (data && data[0]) task.supabaseId = data[0].id;
            }
        }

        async function deleteTaskFromSupabase(task) {
            if (!currentUser || !task.supabaseId) return;
            await supabaseClient.from('tasks').delete().eq('id', task.supabaseId);
        }

        async function syncHabitToSupabase(habitText, date, completed) {
            if (!currentUser) return;
            await supabaseClient.from('habits_history').upsert({
                user_id: currentUser.id, habit_name: habitText, date, completed
            }, { onConflict: 'user_id,habit_name,date' });
        }

        function saveToLocalStorage() {
            localStorage.setItem('weekData', JSON.stringify(weekData));
            if (currentUser) {
                // Trigger sync
                Object.entries(weekData).forEach(([day, periods]) => {
                    Object.entries(periods).forEach(([period, tasks]) => {
                        tasks.forEach(task => syncTaskToSupabase(day, period, task));
                    });
                });
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('weekData');
            if (saved) {
                const savedData = JSON.parse(saved);
                Object.keys(weekData).forEach(day => { if (savedData[day]) weekData[day] = savedData[day]; });
            }
        }

        // --- Render Functions ---

        // --- Habits & Analytics Logic ---

        function getAllHabits() { const habits = [], habitMap = new Map(); Object.entries(weekData).forEach(([day, periods]) => { Object.entries(periods).forEach(([period, tasks]) => { tasks.forEach(task => { if (task.isHabit && !habitMap.has(task.text)) { habitMap.set(task.text, { text: task.text, color: task.color, completedToday: task.completed, isHabit: true }) } }) }) }); return Array.from(habitMap.values()); }

        function getHabitStreak(habitText) { if (!habitsHistory[habitText]) return 0; const today = new Date(); let streak = 0, currentDate = new Date(today); while (true) { const dateKey = currentDate.toISOString().split('T')[0]; if (habitsHistory[habitText][dateKey]) { streak++; currentDate.setDate(currentDate.getDate() - 1); } else { break; } } return streak; }

        function getHabitCompletionRate(habitText, days = 30) { if (!habitsHistory[habitText]) return 0; const today = new Date(); let completed = 0; for (let i = 0; i < days; i++) { const date = new Date(today); date.setDate(date.getDate() - i); const dateKey = date.toISOString().split('T')[0]; if (habitsHistory[habitText][dateKey]) { completed++; } } return Math.round((completed / days) * 100); }

        function markHabitCompleted(habitText, completed) { const today = new Date().toISOString().split('T')[0]; if (!habitsHistory[habitText]) { habitsHistory[habitText] = {}; } if (completed) { habitsHistory[habitText][today] = true; } else { delete habitsHistory[habitText][today]; } localStorage.setItem('habitsHistory', JSON.stringify(habitsHistory)); syncHabitToSupabase(habitText, today, completed); }

        function toggleHabitToday(habitText, completed) { Object.entries(weekData).forEach(([day, periods]) => { Object.entries(periods).forEach(([period, tasks]) => { tasks.forEach(task => { if (task.isHabit && task.text === habitText) { task.completed = completed; } }) }) }); markHabitCompleted(habitText, completed); saveToLocalStorage(); renderHabitsView(); }

        function renderHabitsView() {
            const view = document.getElementById('habitsView'), habits = getAllHabits();
            if (habits.length === 0) { view.innerHTML = '<div class="text-center py-20"><p class="text-gray-400 text-lg">Nenhum h√°bito rastreado ainda.</p><p class="text-gray-600 text-sm mt-2">Marque tasks como h√°bitos no menu de contexto (bot√£o direito).</p></div>'; return; }

            let html = `<div class="max-w-5xl mx-auto"><h2 class="text-3xl font-bold mb-8 text-white">Meus H√°bitos üîÑ</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Total de H√°bitos</div><div class="text-3xl font-bold text-white">${habits.length}</div></div>
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Conclu√≠dos Hoje</div><div class="text-3xl font-bold text-[#30d158]">${habits.filter(h => h.completedToday).length}</div></div>
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Taxa Hoje</div><div class="text-3xl font-bold text-[#0A84FF]">${habits.length > 0 ? Math.round((habits.filter(h => h.completedToday).length / habits.length) * 100) : 0}%</div></div></div><div class="space-y-3">`;

            habits.forEach((habit, index) => {
                const streak = getHabitStreak(habit.text), completionRate = getHabitCompletionRate(habit.text, 30);
                html += `<div class="bg-[#1c1c1e] bg-opacity-40 backdrop-blur-md border border-white/5 rounded-xl p-5 hover:bg-opacity-60 transition-all flex items-center justify-between gap-4 group">
                <div class="flex items-center gap-4 flex-1">
                    <input type="checkbox" class="checkbox-custom mt-1" ${habit.completedToday ? 'checked' : ''} onchange="toggleHabitToday('${habit.text.replace(/'/g, "\\'")}', this.checked)">
                    <div class="flex-1">
                        <div class="color-${habit.color} font-medium text-lg mb-1 group-hover:text-white transition-colors">${habit.text}</div>
                        <div class="flex items-center gap-3 text-xs text-gray-400">
                            ${streak > 0 ? `<span class="px-2 py-0.5 rounded-full bg-orange-500/10 text-orange-400 border border-orange-500/20 font-medium">üî• ${streak} dias</span>` : ''}
                            <span>${completionRate}% consistency (30d)</span>
                        </div>
                    </div>
                </div>
                <div class="w-32 h-1.5 bg-gray-700/30 rounded-full overflow-hidden ml-4 flex-shrink-0"><div class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: ${completionRate}%"></div></div>
                </div>`;
            });
            html += `</div></div>`;
            view.innerHTML = html;
        }

        function renderAnalyticsView() {
            const view = document.getElementById('analyticsView');
            let totalTasks = 0, completedTasks = 0, totalHabits = getAllHabits().length, completedHabitsToday = getAllHabits().filter(h => h.completedToday).length;
            Object.values(weekData).forEach(periods => { Object.values(periods).forEach(tasks => { tasks.forEach(task => { totalTasks++; if (task.completed) completedTasks++; }) }) });
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const habitRate = totalHabits > 0 ? Math.round((completedHabitsToday / totalHabits) * 100) : 0;

            const periodStats = { morning: 0, afternoon: 0, night: 0 };
            Object.values(weekData).forEach(periods => { Object.entries(periods).forEach(([period, tasks]) => { const completed = tasks.filter(t => t.completed).length; if (period.includes('Manh√£')) periodStats.morning += completed; else if (period.includes('Tarde')) periodStats.afternoon += completed; else periodStats.night += completed; }) });

            let html = `<div class="max-w-6xl mx-auto"><h2 class="text-3xl font-bold mb-8 text-white">Analytics üìä</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">`;

            const card = (label, val, sub) => `<div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-2 uppercase tracking-wider font-semibold">${label}</div><div class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">${val}</div><div class="text-xs text-gray-500 mt-2">${sub}</div></div>`;

            html += card('Taxa Task', completionRate + '%', `${completedTasks}/${totalTasks} tasks`);
            html += card('Taxa H√°bito', habitRate + '%', `${completedHabitsToday}/${totalHabits} h√°bitos`);
            html += card('Produtividade', completionRate >= 70 ? 'Alta' : (completionRate > 40 ? 'M√©dia' : 'Baixa'), 'Baseado na conclus√£o');

            html += `</div><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-8"><h3 class="text-lg font-semibold mb-6 text-gray-200">Produtividade por Per√≠odo</h3><canvas id="periodChart"></canvas></div>
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-8"><h3 class="text-lg font-semibold mb-6 text-gray-200">Status de H√°bitos</h3><div class="h-64 flex items-center justify-center"><canvas id="habitsChart"></canvas></div></div>
            </div></div>`;

            view.innerHTML = html;

            setTimeout(() => {
                const pCtx = document.getElementById('periodChart');
                if (pCtx) {
                    new Chart(pCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Manh√£', 'Tarde', 'Noite'],
                            datasets: [{ label: 'Tasks', data: [periodStats.morning, periodStats.afternoon, periodStats.night], backgroundColor: ['#0A84FF', '#5E5CE6', '#BF5AF2'], borderRadius: 6, barThickness: 40 }]
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } }, x: { grid: { display: false }, ticks: { color: '#888' } } }
                        }
                    });
                }
                const hCtx = document.getElementById('habitsChart');
                if (hCtx) {
                    new Chart(hCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Conclu√≠dos', 'Pendentes'],
                            datasets: [{ data: [completedHabitsToday, totalHabits - completedHabitsToday], backgroundColor: ['#30d158', '#2c2c2e'], borderWidth: 0 }]
                        },
                        options: { cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', usePointStyle: true, pointStyle: 'circle' } } } }
                    });
                }
            }, 100);
        }

        function renderSettingsView() {
            const view = document.getElementById('settingsView');
            view.innerHTML = `
                <div class="max-w-2xl mx-auto py-8">
                    <h2 class="text-3xl font-bold mb-8 text-white">Configura√ß√µes ‚öôÔ∏è</h2>
                    
                    <div class="space-y-4">
                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Apar√™ncia</h3>
                            <p class="text-gray-500 text-sm">Configura√ß√µes de tema e visualiza√ß√£o</p>
                        </div>
                        
                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Notifica√ß√µes</h3>
                            <p class="text-gray-500 text-sm">Gerenciar lembretes e alertas</p>
                        </div>
                        
                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Dados</h3>
                            <p class="text-gray-500 text-sm">Backup e sincroniza√ß√£o</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            if (view === 'week') document.getElementById('btnWeek').classList.add('active');
            if (view === 'today') document.getElementById('btnToday').classList.add('active');
            if (view === 'habits') document.getElementById('btnHabits').classList.add('active');
            if (view === 'analytics') document.getElementById('btnAnalytics').classList.add('active');
            if (view === 'settings') document.getElementById('btnSettings').classList.add('active');
            renderView();
        }

        function renderView() {
            document.getElementById('weekGrid').classList.add('hidden');
            document.getElementById('habitsView').classList.add('hidden');
            document.getElementById('analyticsView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');

            if (currentView === 'habits') {
                document.getElementById('habitsView').classList.remove('hidden');
                renderHabitsView();
            } else if (currentView === 'analytics') {
                document.getElementById('analyticsView').classList.remove('hidden');
                renderAnalyticsView();
            } else if (currentView === 'settings') {
                document.getElementById('settingsView').classList.remove('hidden');
                renderSettingsView();
            } else {
                document.getElementById('weekGrid').classList.remove('hidden');
                if (currentView === 'week') renderWeek();
                else renderToday();
            }
        }

        function renderWeek() {
            const grid = document.getElementById('weekGrid');
            grid.className = 'grid grid-cols-7 gap-0';
            grid.innerHTML = '';

            Object.entries(weekData).forEach(([day, periods]) => {
                const col = document.createElement('div');
                col.className = 'day-column';
                col.dataset.day = day;
                // Drag Events
                col.addEventListener('dragover', handleDragOver);
                col.addEventListener('drop', handleDrop);

                const header = document.createElement('h2');
                header.textContent = day;
                col.appendChild(header);

                // Flatten all tasks from all periods into a continuous list
                const allTasks = [];
                Object.entries(periods).forEach(([period, tasks]) => {
                    tasks.forEach((task, index) => {
                        allTasks.push({ task, day, period, originalIndex: index });
                    });
                });

                // Render all tasks in sequence without period sections
                allTasks.forEach(({ task, day, period, originalIndex }) => {
                    col.appendChild(createTaskElement(day, period, task, originalIndex));
                });

                grid.appendChild(col);
            });
        }

        function renderToday() {
            const grid = document.getElementById('weekGrid');
            grid.className = 'max-w-2xl mx-auto';
            grid.innerHTML = '';

            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const today = days[new Date().getDay()];
            const header = document.createElement('div');
            header.className = 'mb-8';
            header.innerHTML = `<h1 class="text-3xl font-bold mb-2">${today}</h1><p class="text-gray-500">${new Date().toLocaleDateString('pt-BR')}</p>`;
            grid.appendChild(header);

            if (weekData[today]) {
                // Flatten all tasks from all periods
                const allTasks = [];
                Object.entries(weekData[today]).forEach(([period, tasks]) => {
                    tasks.forEach((task, index) => {
                        allTasks.push({ task, day: today, period, originalIndex: index });
                    });
                });

                // Render all tasks in a single continuous list
                allTasks.forEach(({ task, day, period, originalIndex }) => {
                    grid.appendChild(createTaskElement(day, period, task, originalIndex));
                });
            }
        }

        function createTaskElement(day, period, task, index) {
            const container = document.createElement('div');

            // Top Drop Zone
            container.appendChild(createDropZone(day, period, index));

            const el = document.createElement('div');
            el.className = `task-item ${task.isHabit ? 'is-habit' : ''}`;
            el.draggable = true;
            el.dataset.day = day;
            el.dataset.period = period;
            el.dataset.index = index;

            // Drag Handle
            const handle = document.createElement('div');
            handle.className = 'drag-handle';
            handle.innerHTML = '‚ãÆ‚ãÆ';
            el.appendChild(handle);

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'checkbox-custom';
            checkbox.checked = task.completed;
            checkbox.onchange = (e) => {
                task.completed = e.target.checked;
                label.classList.toggle('task-completed', task.completed);
                saveToLocalStorage();
                // Habit logic
                if (task.isHabit) markHabitCompleted(task.text, task.completed);
            }
            el.appendChild(checkbox);

            // Label
            const label = document.createElement('span');
            label.className = `task-label color-${task.color} ${task.completed ? 'task-completed' : ''}`;
            label.textContent = task.text;

            // Single Click Edit
            label.onclick = (e) => {
                if (label.isContentEditable) return;
                startEditing(label, task, el);
            };

            // Context Menu
            label.oncontextmenu = (e) => {
                e.preventDefault();
                showEditToolbar(e, task, label);
            }

            el.appendChild(label);

            // Drag Events
            el.ondragstart = handleDragStart;
            el.ondragend = handleDragEnd;

            container.appendChild(el);
            return container;
        }

        function createDropZone(day, period, index) {
            const dz = document.createElement('div');
            dz.className = 'task-drop-zone';
            dz.dataset.day = day;
            dz.dataset.period = period;
            dz.dataset.insertAt = index;

            dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('show'); };
            dz.ondragleave = () => dz.classList.remove('show');
            dz.ondrop = (e) => handleDropZoneDrop(e, dz);
            return dz;
        }

        // --- Editing Logic ---

        function startEditing(label, task, taskDiv) {
            if (currentEditingTask) finishEditing();
            currentEditingTask = { label, task, original: task.text };

            label.contentEditable = true;
            label.focus();
            taskDiv.draggable = false;

            // Select all text
            const range = document.createRange();
            range.selectNodeContents(label);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            label.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEditing();
                }
                if (e.key === 'Escape') {
                    label.textContent = currentEditingTask.original;
                    finishEditing();
                }
            };
            label.onblur = finishEditing;
        }

        function finishEditing() {
            if (!currentEditingTask) return;
            const { label, task } = currentEditingTask;
            task.text = label.textContent.trim();
            label.contentEditable = false;
            label.closest('.task-item').draggable = true;
            saveToLocalStorage();
            currentEditingTask = null;
        }

        function showTaskInput(btn, day, period) {
            const input = document.createElement('input');
            input.className = 'task-input';
            input.placeholder = 'Nova tarefa...';
            btn.replaceWith(input);
            input.focus();

            const save = () => {
                if (input.value.trim()) {
                    if (!weekData[day][period]) weekData[day][period] = [];
                    weekData[day][period].push({ text: input.value.trim(), completed: false, color: 'default', isHabit: false });
                    saveToLocalStorage();
                }
                renderView();
            };

            input.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') renderView(); };
            input.onblur = () => setTimeout(save, 100);
        }

        // --- Drag & Drop Handlers ---

        function handleDragStart(e) {
            draggedTask = {
                day: this.dataset.day,
                period: this.dataset.period,
                index: parseInt(this.dataset.index),
                task: weekData[this.dataset.day][this.dataset.period][parseInt(this.dataset.index)]
            };
            document.body.classList.add('dragging-active');
            setTimeout(() => this.classList.add('opacity-50'), 0);
        }

        function handleDragEnd(e) {
            document.body.classList.remove('dragging-active');
            this.classList.remove('opacity-50');
            document.querySelectorAll('.day-column').forEach(c => c.classList.remove('drag-over'));
        }

        function handleDragOver(e) { e.preventDefault(); }

        function handleDropZoneDrop(e, dz) {
            e.stopPropagation();
            dz.classList.remove('show');
            if (!draggedTask) return;

            const targetDay = dz.dataset.day;
            const targetPeriod = dz.dataset.period;
            let insertAt = parseInt(dz.dataset.insertAt);

            // Remove from old
            weekData[draggedTask.day][draggedTask.period].splice(draggedTask.index, 1);

            // Adjust index if same list
            if (draggedTask.day === targetDay && draggedTask.period === targetPeriod && draggedTask.index < insertAt) {
                insertAt--;
            }

            // Insert new
            if (!weekData[targetDay][targetPeriod]) weekData[targetDay][targetPeriod] = [];
            weekData[targetDay][targetPeriod].splice(insertAt, 0, draggedTask.task);

            saveToLocalStorage();
            renderView();
            draggedTask = null;
        }

        function handleDrop(e) {
            // Fallback drop on column
            e.preventDefault();
            // Logic to drop at end of list if dropped on column
        }

        // --- Menus ---
        function showEditToolbar(e, task, label) {
            const toolbar = document.getElementById('editToolbar');
            toolbar.style.left = e.pageX + 'px';
            toolbar.style.top = e.pageY + 'px';
            toolbar.classList.add('show');

            // Setup buttons (simplified)
            toolbar.querySelector('[data-action="color"]').onclick = (ev) => {
                ev.stopPropagation();
                showColorMenu(ev, task, label);
            }
            toolbar.querySelector('[data-action="delete"]').onclick = () => {
                // Delete logic
                const day = label.closest('.task-item').dataset.day;
                const period = label.closest('.task-item').dataset.period;
                const index = parseInt(label.closest('.task-item').dataset.index);
                weekData[day][period].splice(index, 1);
                saveToLocalStorage();
                renderView();
            }
        }

        function showColorMenu(e, task, label) {
            const menu = document.getElementById('colorMenu');
            const rect = document.getElementById('editToolbar').getBoundingClientRect();
            // Fix positioning (scroll aware)
            const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
            const scrollTop = window.scrollY || document.documentElement.scrollTop;

            menu.style.left = (rect.left + scrollLeft) + 'px';
            menu.style.top = (rect.bottom + scrollTop + 8) + 'px';
            menu.classList.add('show');

            menu.querySelectorAll('.color-swatch').forEach(s => {
                s.onclick = () => {
                    const color = s.dataset.color;
                    task.color = color;
                    saveToLocalStorage();
                    renderView();
                }
            });
        }

        // --- Init ---
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#editToolbar') && !e.target.closest('#colorMenu')) {
                document.getElementById('editToolbar').classList.remove('show');
                document.getElementById('colorMenu').classList.remove('show');
            }
            if (!e.target.closest('#userDropdown') && !e.target.closest('#btnUser')) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        document.getElementById('btnUser').onclick = () => {
            const drop = document.getElementById('userDropdown');
            drop.style.display = drop.style.display === 'flex' ? 'none' : 'flex';
        };

        document.getElementById('btnLogout').onclick = signOut;

        document.getElementById('btnTogglePeriods').onclick = () => {
            const current = localStorage.getItem('showPeriods') !== 'false';
            localStorage.setItem('showPeriods', (!current).toString());
            renderView();
        };

        document.getElementById('floatingAddBtn').onclick = () => {
            const m = document.getElementById('quickAddMenu');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        // Event listeners para autentica√ß√£o
        document.getElementById('btnLogin').onclick = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            await signIn(email, password);
        };

        document.getElementById('btnSignup').onclick = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            await signUp(email, password);
        };

        document.getElementById('btnShowSignup').onclick = () => {
            document.getElementById('authLogin').style.display = 'none';
            document.getElementById('authSignup').style.display = 'block';
        };

        document.getElementById('btnShowLogin').onclick = () => {
            document.getElementById('authSignup').style.display = 'none';
            document.getElementById('authLogin').style.display = 'block';
        };

        loadFromLocalStorage();
        setTimeout(checkAuth, 100);

    </script>
</body>

</html>
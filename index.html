<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowly</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-body: #000000;
            --bg-card: rgba(28, 28, 30, 0.6);
            --bg-card-hover: rgba(44, 44, 46, 0.8);
            --bg-elevated: rgba(44, 44, 46, 1);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --text-primary: #F5F5F7;
            --text-secondary: #86868b;
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-orange: #FF9F0A;
            --accent-red: #FF453A;
            --radius-card: 18px;
            --radius-sm: 8px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            overflow-x: hidden;
            margin: 0;
            padding: 24px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Navigation */
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 0 4px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-img {
            height: 32px;
        }

        .segmented-control {
            background: rgba(118, 118, 128, 0.24);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2px;
            border-radius: 9px;
            display: flex;
            gap: 1px;
        }

        .segment-btn {
            background: transparent;
            border: none;
            padding: 6px 16px;
            border-radius: 7px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            border: 0.5px solid transparent;
        }

        .segment-btn:hover:not(.active) {
            opacity: 0.8;
        }

        .segment-btn.active {
            background: #636366;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 3px 1px rgba(0, 0, 0, 0.04);
            font-weight: 600;
        }

        .utility-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }

        .utility-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Grid & Cards */
        .day-column {
            background: transparent;
            border-right: 1px solid var(--border-subtle);
            min-height: 70vh;
            padding: 0 16px 32px 16px;
            transition: background 0.2s;
            cursor: text;
        }

        .day-column:last-child {
            border-right: none;
        }

        /* Glass effect for active drag */
        .day-column.drag-over {
            background: rgba(10, 132, 255, 0.05);
            border-radius: 12px;
            border-right-color: transparent;
        }

        h2 {
            font-weight: 700;
            font-size: 17px;
            letter-spacing: -0.02em;
            margin-bottom: 24px;
            opacity: 0.9;
        }

        h3 {
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6b7280;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        h3.hidden {
            display: none;
        }

        /* Task Items - Notion-style Minimal */
        .task-item {
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            margin-bottom: 2px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            transition: background 0.15s ease;
            position: relative;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .task-item.is-habit .task-label {
            color: var(--accent-blue) !important;
        }

        /* Checkbox - Refined */
        .checkbox-custom {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1.5px solid #555;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.02);
            margin-top: 2px;
        }

        .checkbox-custom:hover {
            border-color: #888;
            background: rgba(255, 255, 255, 0.1);
        }

        .checkbox-custom:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            box-shadow: 0 2px 4px rgba(10, 132, 255, 0.3);
        }

        .checkbox-custom:checked::after {
            content: '';
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) translateY(-1px);
        }

        /* Typography & Editing */
        .task-label {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            width: 100%;
            cursor: text;
            transition: opacity 0.2s;
        }

        .task-completed {
            color: var(--text-secondary);
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-label[contenteditable="true"] {
            outline: none;
            background: rgba(10, 132, 255, 0.15);
            border-radius: 4px;
            padding: 0 4px;
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.3);
        }

        /* Drag & Drop Visuals */
        .task-drop-zone {
            height: 12px;
            margin: -6px 0;
            position: relative;
            z-index: 5;
            pointer-events: none;
        }

        body.dragging-active .task-drop-zone {
            pointer-events: all;
        }

        .task-drop-zone.show::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 4px;
            right: 4px;
            height: 2px;
            background: var(--accent-blue);
            box-shadow: 0 0 8px var(--accent-blue);
            border-radius: 2px;
            transform: translateY(-50%);
        }

        /* Add Task Button */
        .add-task-btn {
            font-size: 13px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed var(--border-subtle);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            margin-top: 8px;
            opacity: 0.6;
        }

        .add-task-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .task-input {
            background: #1c1c1e;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 14px;
            box-shadow: 0 0 0 2px transparent;
            transition: box-shadow 0.2s;
        }

        .task-input:focus {
            box-shadow: 0 0 0 2px var(--accent-blue);
        }

        .quick-task-input {
            background: transparent;
            border: none;
            padding: 6px 8px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 14px;
            font-family: inherit;
        }

        .quick-task-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .quick-task-container {
            background: transparent;
            border-radius: 4px;
            padding: 0;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s ease;
        }

        .quick-task-container:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Floating & Menus */
        .floating-add-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 100;
        }

        .floating-add-btn:hover {
            transform: scale(1.08) rotate(90deg);
        }

        .context-menu {
            position: absolute;
            background: rgba(30, 30, 32, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: flex;
            animation: scaleIn 0.1s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 9999;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #1c1c1e;
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.1s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Color classes */
        .color-default {
            color: #f5f5f7;
        }

        .color-green {
            color: #30d158;
        }

        .color-yellow {
            color: #ffd60a;
        }

        .color-orange {
            color: #ff9f0a;
        }

        .color-red {
            color: #ff453a;
        }

        .drag-handle {
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            cursor: grab;
            color: #555;
            font-size: 12px;
        }

        .task-item:hover .drag-handle {
            opacity: 1;
        }

        .drag-handle:hover {
            color: #fff;
        }
    </style>
</head>

<body class="antialiased">
    <div class="max-w-[1400px] mx-auto">
        <!-- Header -->
        <div class="nav-container">
            <div class="logo-area">
                <img src="logo_flowly.png" alt="Flowly" class="logo-img">
            </div>

            <div class="segmented-control">
                <button id="btnMonth" class="segment-btn" onclick="setView('month')">M√™s</button>
                <button id="btnWeek" class="segment-btn active" onclick="setView('week')">Semana</button>
                <button id="btnToday" class="segment-btn" onclick="setView('today')">Hoje</button>
                <button id="btnRoutine" class="segment-btn" onclick="setView('routine')">Rotina</button>
                <button id="btnHabits" class="segment-btn" onclick="setView('habits')">H√°bitos</button>
                <button id="btnAnalytics" class="segment-btn" onclick="setView('analytics')">Analytics</button>
                <button id="btnSettings" class="segment-btn" onclick="setView('settings')"><i data-lucide="settings" style="width: 16px; height: 16px;"></i></button>
            </div>

            <div class="flex items-center gap-3">
                <button id="btnTogglePeriods" class="utility-btn" title="Mostrar/Ocultar per√≠odos"><i data-lucide="list" style="width: 18px; height: 18px;"></i></button>
                <button id="btnBackup" class="utility-btn" title="Backup"><i data-lucide="database" style="width: 18px; height: 18px;"></i></button>
                <div class="relative">
                    <button id="btnUser" class="utility-btn"><i data-lucide="user" style="width: 18px; height: 18px;"></i></button>
                    <div id="userDropdown" class="context-menu"
                        style="top: 100%; right: 0; margin-top: 8px; min-width: 180px; display: none; flex-direction: column;">
                        <div id="userEmail" class="p-3 text-xs text-gray-500 border-b border-[#333]">user@email.com
                        </div>
                        <div class="p-2 hover:bg-[#333] cursor-pointer rounded text-sm text-red-400" id="btnLogout">Sair
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Week Navigation -->
        <div id="weekNav" class="hidden flex items-center justify-center gap-4 mb-6">
            <button id="btnPrevWeek" class="utility-btn" onclick="changeWeek(-1)"><i data-lucide="chevron-left" style="width: 18px; height: 18px;"></i></button>
            <div class="text-sm text-gray-400" id="weekLabel">Semana Atual</div>
            <button id="btnNextWeek" class="utility-btn" onclick="changeWeek(1)"><i data-lucide="chevron-right" style="width: 18px; height: 18px;"></i></button>
            <button id="btnCurrentWeek" class="btn-secondary text-xs px-3 py-1 ml-4" onclick="goToCurrentWeek()" style="width: auto; padding: 6px 12px;">Semana Atual</button>
        </div>

        <!-- Main Content -->
        <div id="contentArea">
            <div id="monthView" class="hidden"></div>
            <div id="weekGrid" class="grid grid-cols-7 gap-0">
                <!-- Javascript will populate this -->
            </div>
            <div id="routineView" class="hidden"></div>
            <div id="habitsView" class="hidden"></div>
            <div id="analyticsView" class="hidden"></div>
            <div id="settingsView" class="hidden"></div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div id="floatingAddBtn" class="floating-add-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </div>

    <!-- Quick Add Menu -->
    <div id="quickAddMenu" class="context-menu"
        style="position: fixed; bottom: 100px; right: 32px; min-width: 200px; flex-direction: column; gap: 4px;">
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm flex items-center gap-2" data-type="routine"><i data-lucide="repeat" style="width: 16px; height: 16px;"></i> Adicionar rotina di√°ria</div>
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm flex items-center gap-2" data-type="custom"><i data-lucide="plus" style="width: 16px; height: 16px;"></i> Nova tarefa customizada</div>
    </div>

    <!-- Edit Context Menu -->
    <div id="editToolbar" class="context-menu">
        <button class="toolbar-btn" data-action="bold"><i data-lucide="bold" style="width: 16px; height: 16px;"></i></button>
        <button class="toolbar-btn" data-action="italic"><i data-lucide="italic" style="width: 16px; height: 16px;"></i></button>
        <button class="toolbar-btn" data-action="strikethrough"><i data-lucide="strikethrough" style="width: 16px; height: 16px;"></i></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="color"><i data-lucide="palette" style="width: 16px; height: 16px;"></i></button>
        <button class="toolbar-btn" data-action="habit"><i data-lucide="repeat" style="width: 16px; height: 16px;"></i></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="delete" style="color: var(--accent-red)"><i data-lucide="trash-2" style="width: 16px; height: 16px;"></i></button>
    </div>

    <!-- Color Picker -->
    <div id="colorMenu" class="context-menu" style="gap: 6px;">
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #6b7280;" data-color="default"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #30d158;" data-color="green"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ffd60a;" data-color="yellow"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ff9f0a;" data-color="orange"></div>
        <div class="color-swatch w-6 h-6 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform"
            style="background: #ff453a;" data-color="red"></div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay show">
        <div class="modal-content">
            <div class="text-center mb-6">
                <img src="logo_flowly.png" alt="Flowly" class="h-16 mx-auto mb-4">
                <h2 class="text-2xl font-bold">Bem-vindo</h2>
            </div>

            <div id="authLogin">
                <input type="email" id="loginEmail" class="task-input mb-3" style="background: rgba(0,0,0,0.3);"
                    placeholder="Email">
                <input type="password" id="loginPassword" class="task-input mb-4" style="background: rgba(0,0,0,0.3);"
                    placeholder="Senha">

                <div class="flex items-center gap-2 mb-6">
                    <input type="checkbox" id="keepLoggedIn" class="checkbox-custom" checked>
                    <label for="keepLoggedIn" class="text-sm text-gray-400">Manter conectado</label>
                </div>

                <button id="btnLogin" class="btn-primary">Entrar</button>
                <button id="btnShowSignup" class="btn-secondary">Criar conta</button>
                <div id="authMessage" class="text-center text-xs mt-4 h-4 text-red-400"></div>
            </div>

            <div id="authSignup" style="display:none;">
                <input type="email" id="signupEmail" class="task-input mb-3" style="background: rgba(0,0,0,0.3);"
                    placeholder="Email">
                <input type="password" id="signupPassword" class="task-input mb-6" style="background: rgba(0,0,0,0.3);"
                    placeholder="Senha (m√≠n. 6 caracteres)">
                <button id="btnSignup" class="btn-primary">Cadastrar</button>
                <button id="btnShowLogin" class="btn-secondary">Voltar</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><i data-lucide="database" style="width: 22px; height: 22px;"></i> Backup & Dados</h2>
            <button id="btnExport" class="btn-primary mb-4 flex items-center justify-center gap-2" style="background: #333;"><i data-lucide="download" style="width: 18px; height: 18px;"></i> Exportar Dados (JSON)</button>
            <div class="relative mb-6">
                <input type="file" id="fileImport" accept=".json" class="hidden">
                <label for="fileImport" class="btn-secondary block text-center cursor-pointer flex items-center justify-center gap-2"
                    style="padding: 12px; border: 1px dashed #555;"><i data-lucide="upload" style="width: 18px; height: 18px;"></i> Importar Backup</label>
            </div>
            <button id="btnClearAll" class="btn-secondary flex items-center justify-center gap-2"
                style="color: #ff453a; background: rgba(255, 69, 58, 0.1);"><i data-lucide="trash-2" style="width: 18px; height: 18px;"></i> Limpar Tudo</button>
            <button id="btnCloseBackup" class="btn-secondary mt-6">Fechar</button>
        </div>
    </div>

    <script>
        // --- Supabase & Storage Logic ---
        const SUPABASE_URL = 'https://cgrosyjtujakkbjjnmml.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNncm9zeWp0dWpha2tiampubW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTA0NzcsImV4cCI6MjA4NjU4NjQ3N30.MsDw0nSiLF1jHWMuVGRgTT6gNUeK328RvGBo-YcFG1A';
        const { createClient } = window.supabase;

        const customStorage = {
            getItem: (key) => localStorage.getItem(key) || sessionStorage.getItem(key),
            setItem: (key, value) => {
                if (localStorage.getItem('flowly_persist_session') === 'true') localStorage.setItem(key, value);
                else sessionStorage.setItem(key, value);
            },
            removeItem: (key) => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            }
        };

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { storage: customStorage, autoRefreshToken: true, persistSession: true, detectSessionInUrl: true }
        });

        let currentUser = null;
        let currentView = 'week';
        let draggedTask = null;
        let currentEditingTask = null;
        const width = 600;
        let currentWeekOffset = 0; // 0 = semana atual, -1 = semana passada, +1 = pr√≥xima semana
        let currentMonthOffset = 0; // 0 = m√™s atual

        // Data Structures
        let dailyRoutine = JSON.parse(localStorage.getItem('dailyRoutine') || JSON.stringify([
            { text: "Ora√ß√£o e Salmo", completed: false, color: "default", isHabit: true },
            { text: "Venvanse", completed: false, color: "default", isHabit: true },
            { text: "Ler metas e mantra; celular na gaveta", completed: false, color: "default", isHabit: true }
        ]));

        // Estrutura expandida: armazena tarefas por data ISO (YYYY-MM-DD) e per√≠odo
        let allTasksData = JSON.parse(localStorage.getItem('allTasksData') || '{}');

        // Compatibilidade: estrutura antiga para a semana atual
        const weekData = { "Segunda": {}, "Ter√ßa": {}, "Quarta": {}, "Quinta": {}, "Sexta": {}, "S√°bado": {}, "Domingo": {} };
        let habitsHistory = JSON.parse(localStorage.getItem('habitsHistory') || '{}');

        // Fun√ß√µes auxiliares de data
        function getWeekDates(weekOffset = 0) {
            const today = new Date();
            const currentDay = today.getDay(); // 0 = Domingo
            const diff = currentDay === 0 ? -6 : 1 - currentDay; // Ajustar para segunda-feira

            const monday = new Date(today);
            monday.setDate(today.getDate() + diff + (weekOffset * 7));
            monday.setHours(0, 0, 0, 0);

            const dates = [];
            const dayNames = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push({
                    name: dayNames[i],
                    date: date,
                    dateStr: date.toISOString().split('T')[0]
                });
            }

            return dates;
        }

        function getMonthDates(monthOffset = 0) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + monthOffset;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            return { firstDay, lastDay, month: firstDay.getMonth(), year: firstDay.getFullYear() };
        }

        function getWeekLabel(weekOffset) {
            const dates = getWeekDates(weekOffset);
            const firstDate = dates[0].date;
            const lastDate = dates[6].date;

            if (weekOffset === 0) return 'Semana Atual';

            const format = (d) => d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
            return `${format(firstDate)} - ${format(lastDate)}`;
        }

        function changeWeek(direction) {
            currentWeekOffset += direction;
            renderView();
        }

        function goToCurrentWeek() {
            currentWeekOffset = 0;
            renderView();
        }

        // --- Core Functions ---

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('authModal').classList.remove('show');
                document.getElementById('userEmail').textContent = session.user.email;
                await loadDataFromSupabase();
                renderView();
            } else {
                document.getElementById('authModal').classList.add('show');
            }
        }

        async function signUp(email, password) {
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) { showAuthMessage(error.message); return false; }
            showAuthMessage('Conta criada! Fazendo login...', 'success');
            await signIn(email, password);
            return true;
        }

        async function signIn(email, password) {
            // Salvar prefer√™ncia de "manter conectado" ANTES do login
            const keepLoggedIn = document.getElementById('keepLoggedIn').checked;
            localStorage.setItem('flowly_persist_session', keepLoggedIn.toString());

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) { showAuthMessage(error.message); return false; }

            currentUser = data.user;
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('userEmail').textContent = data.user.email;
            await migrateLocalDataToSupabase();
            await loadDataFromSupabase();
            return true;
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            document.getElementById('authModal').classList.add('show');
            location.reload();
        }

        function showAuthMessage(msg, type = 'error') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.style.color = type === 'error' ? '#ff453a' : '#30d158';
        }

        // --- Sync Logic ---

        async function migrateLocalDataToSupabase() {
            if (!currentUser) return;
            const localData = localStorage.getItem('weekData');
            if (!localData) return;
            // Simplified migration logic retention
            const data = JSON.parse(localData);
            // Migration implementation details omitted for brevity but logic placeholder exists
            localStorage.removeItem('weekData');
        }

        async function loadDataFromSupabase() {
            if (!currentUser) return;
            const { data: tasks } = await supabaseClient.from('tasks').select('*').eq('user_id', currentUser.id);
            if (tasks) {
                Object.keys(weekData).forEach(day => weekData[day] = {});
                tasks.forEach(task => {
                    if (!weekData[task.day][task.period]) weekData[task.day][task.period] = [];
                    weekData[task.day][task.period].push({
                        text: task.text, completed: task.completed, color: task.color,
                        isHabit: task.is_habit, supabaseId: task.id
                    });
                });
                renderView();
            }
            const { data: habits } = await supabaseClient.from('habits_history').select('*').eq('user_id', currentUser.id);
            if (habits) {
                habitsHistory = {};
                habits.forEach(h => {
                    if (!habitsHistory[h.habit_name]) habitsHistory[h.habit_name] = {};
                    habitsHistory[h.habit_name][h.date] = h.completed;
                });
            }
        }

        async function syncTaskToSupabase(day, period, task) {
            if (!currentUser) return;
            // Upsert logic
            if (task.supabaseId) {
                await supabaseClient.from('tasks').update({
                    text: task.text, completed: task.completed, color: task.color, is_habit: task.isHabit, updated_at: new Date().toISOString()
                }).eq('id', task.supabaseId);
            } else {
                const { data } = await supabaseClient.from('tasks').insert({
                    user_id: currentUser.id, day, period, text: task.text, completed: task.completed, color: task.color, is_habit: task.isHabit
                }).select();
                if (data && data[0]) task.supabaseId = data[0].id;
            }
        }

        async function deleteTaskFromSupabase(task) {
            if (!currentUser || !task.supabaseId) return;
            await supabaseClient.from('tasks').delete().eq('id', task.supabaseId);
        }

        async function syncHabitToSupabase(habitText, date, completed) {
            if (!currentUser) return;
            await supabaseClient.from('habits_history').upsert({
                user_id: currentUser.id, habit_name: habitText, date, completed
            }, { onConflict: 'user_id,habit_name,date' });
        }

        function saveToLocalStorage() {
            localStorage.setItem('allTasksData', JSON.stringify(allTasksData));
            localStorage.setItem('weekData', JSON.stringify(weekData));
            if (currentUser) {
                // Trigger sync
                Object.entries(allTasksData).forEach(([dateStr, periods]) => {
                    Object.entries(periods).forEach(([period, tasks]) => {
                        if (Array.isArray(tasks)) {
                            tasks.forEach(task => syncTaskToSupabase(dateStr, period, task));
                        }
                    });
                });
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('weekData');
            if (saved) {
                const savedData = JSON.parse(saved);
                Object.keys(weekData).forEach(day => { if (savedData[day]) weekData[day] = savedData[day]; });
            }
        }

        // --- Render Functions ---

        // --- Habits & Analytics Logic ---

        function getAllHabits() {
            const habits = [], habitMap = new Map();
            const today = new Date().toISOString().split('T')[0];
            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const todayName = days[new Date().getDay()];
            const dateKey = `${todayName}_${today}`;
            const routineStates = JSON.parse(localStorage.getItem('routineStates') || '{}');

            // Adicionar tarefas da rotina di√°ria
            dailyRoutine.forEach(task => {
                if (task.isHabit && !habitMap.has(task.text)) {
                    const isCompleted = routineStates[task.text] && routineStates[task.text][dateKey] || false;
                    habitMap.set(task.text, {
                        text: task.text,
                        color: task.color,
                        completedToday: isCompleted,
                        isHabit: true
                    });
                }
            });

            // Adicionar outras tarefas marcadas como h√°bitos
            Object.entries(weekData).forEach(([day, periods]) => {
                Object.entries(periods).forEach(([period, tasks]) => {
                    tasks.forEach(task => {
                        if (task.isHabit && !habitMap.has(task.text)) {
                            habitMap.set(task.text, {
                                text: task.text,
                                color: task.color,
                                completedToday: task.completed,
                                isHabit: true
                            });
                        }
                    });
                });
            });

            return Array.from(habitMap.values());
        }

        function getHabitStreak(habitText) { if (!habitsHistory[habitText]) return 0; const today = new Date(); let streak = 0, currentDate = new Date(today); while (true) { const dateKey = currentDate.toISOString().split('T')[0]; if (habitsHistory[habitText][dateKey]) { streak++; currentDate.setDate(currentDate.getDate() - 1); } else { break; } } return streak; }

        function getHabitCompletionRate(habitText, days = 30) { if (!habitsHistory[habitText]) return 0; const today = new Date(); let completed = 0; for (let i = 0; i < days; i++) { const date = new Date(today); date.setDate(date.getDate() - i); const dateKey = date.toISOString().split('T')[0]; if (habitsHistory[habitText][dateKey]) { completed++; } } return Math.round((completed / days) * 100); }

        function markHabitCompleted(habitText, completed) { const today = new Date().toISOString().split('T')[0]; if (!habitsHistory[habitText]) { habitsHistory[habitText] = {}; } if (completed) { habitsHistory[habitText][today] = true; } else { delete habitsHistory[habitText][today]; } localStorage.setItem('habitsHistory', JSON.stringify(habitsHistory)); syncHabitToSupabase(habitText, today, completed); }

        function toggleHabitToday(habitText, completed) { Object.entries(weekData).forEach(([day, periods]) => { Object.entries(periods).forEach(([period, tasks]) => { tasks.forEach(task => { if (task.isHabit && task.text === habitText) { task.completed = completed; } }) }) }); markHabitCompleted(habitText, completed); saveToLocalStorage(); renderHabitsView(); }

        function renderHabitsView() {
            const view = document.getElementById('habitsView'), habits = getAllHabits();
            if (habits.length === 0) { view.innerHTML = '<div class="text-center py-20"><p class="text-gray-400 text-lg">Nenhum h√°bito rastreado ainda.</p><p class="text-gray-600 text-sm mt-2">Marque tasks como h√°bitos no menu de contexto (bot√£o direito).</p></div>'; return; }

            let html = `<div class="max-w-5xl mx-auto"><h2 class="text-3xl font-bold mb-8 text-white flex items-center gap-3"><i data-lucide="repeat" style="width: 28px; height: 28px;"></i> Meus H√°bitos</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Total de H√°bitos</div><div class="text-3xl font-bold text-white">${habits.length}</div></div>
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Conclu√≠dos Hoje</div><div class="text-3xl font-bold text-[#30d158]">${habits.filter(h => h.completedToday).length}</div></div>
            <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6"><div class="text-gray-400 text-sm mb-1 uppercase tracking-wider font-semibold">Taxa Hoje</div><div class="text-3xl font-bold text-[#0A84FF]">${habits.length > 0 ? Math.round((habits.filter(h => h.completedToday).length / habits.length) * 100) : 0}%</div></div></div><div class="space-y-3">`;

            habits.forEach((habit, index) => {
                const streak = getHabitStreak(habit.text), completionRate = getHabitCompletionRate(habit.text, 30);
                html += `<div class="bg-[#1c1c1e] bg-opacity-40 backdrop-blur-md border border-white/5 rounded-xl p-5 hover:bg-opacity-60 transition-all flex items-center justify-between gap-4 group">
                <div class="flex items-center gap-4 flex-1">
                    <input type="checkbox" class="checkbox-custom mt-1" ${habit.completedToday ? 'checked' : ''} onchange="toggleHabitToday('${habit.text.replace(/'/g, "\\'")}', this.checked)">
                    <div class="flex-1">
                        <div class="color-${habit.color} font-medium text-lg mb-1 group-hover:text-white transition-colors">${habit.text}</div>
                        <div class="flex items-center gap-3 text-xs text-gray-400">
                            ${streak > 0 ? `<span class="px-2 py-0.5 rounded-full bg-orange-500/10 text-orange-400 border border-orange-500/20 font-medium flex items-center gap-1"><i data-lucide="flame" style="width: 14px; height: 14px;"></i> ${streak} dias</span>` : ''}
                            <span>${completionRate}% consistency (30d)</span>
                        </div>
                    </div>
                </div>
                <div class="w-32 h-1.5 bg-gray-700/30 rounded-full overflow-hidden ml-4 flex-shrink-0"><div class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: ${completionRate}%"></div></div>
                </div>`;
            });
            html += `</div></div>`;
            view.innerHTML = html;
        }

        function renderAnalyticsView() {
            const view = document.getElementById('analyticsView');

            // Calcular dados da semana atual
            const weekDates = getWeekDates(0);
            let totalTasksWeek = 0, completedTasksWeek = 0;
            let totalTasksToday = 0, completedTasksToday = 0;
            const today = new Date().toISOString().split('T')[0];

            // Estat√≠sticas por dia da semana
            const dayStats = {};

            // Contar tarefas de toda a semana
            weekDates.forEach(({ name, dateStr }) => {
                const dayTasks = allTasksData[dateStr] || {};
                let dayTotal = 0, dayCompleted = 0;

                Object.values(dayTasks).forEach(tasks => {
                    if (Array.isArray(tasks)) {
                        tasks.forEach(task => {
                            dayTotal++;
                            totalTasksWeek++;
                            if (task.completed) {
                                dayCompleted++;
                                completedTasksWeek++;
                            }

                            if (dateStr === today) {
                                totalTasksToday++;
                                if (task.completed) completedTasksToday++;
                            }
                        });
                    }
                });

                dayStats[name] = { total: dayTotal, completed: dayCompleted };
            });

            // Adicionar rotina di√°ria
            const totalHabits = getAllHabits().length;
            const completedHabitsToday = getAllHabits().filter(h => h.completedToday).length;
            totalTasksToday += dailyRoutine.length;
            completedTasksToday += completedHabitsToday;

            const todayRate = totalTasksToday > 0 ? Math.round((completedTasksToday / totalTasksToday) * 100) : 0;
            const weekRate = totalTasksWeek > 0 ? Math.round((completedTasksWeek / totalTasksWeek) * 100) : 0;
            const habitRate = totalHabits > 0 ? Math.round((completedHabitsToday / totalHabits) * 100) : 0;

            // Calcular streak (dias consecutivos com todas as tarefas completas)
            let currentStreak = 0;
            const checkDate = new Date();
            for (let i = 0; i < 30; i++) {
                const dateStr = checkDate.toISOString().split('T')[0];
                const dayTasks = allTasksData[dateStr] || {};
                let dayTotal = 0;
                let dayCompleted = 0;

                Object.values(dayTasks).forEach(tasks => {
                    if (Array.isArray(tasks)) {
                        dayTotal += tasks.length;
                        dayCompleted += tasks.filter(t => t.completed).length;
                    }
                });

                if (dayTotal > 0 && dayCompleted === dayTotal) {
                    currentStreak++;
                } else if (i > 0 || (i === 0 && dayTotal > 0)) {
                    break;
                }
                checkDate.setDate(checkDate.getDate() - 1);
            }

            let html = `<div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold mb-2 text-white flex items-center gap-3">
                    <i data-lucide="bar-chart-3" style="width: 28px; height: 28px;"></i> Analytics
                </h2>
                <p class="text-gray-400 text-sm mb-8">Acompanhe sua produtividade e evolu√ß√£o</p>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">`;

            // Card customizado com cores din√¢micas
            const card = (label, val, sub, gradient = 'from-blue-400 to-indigo-400', icon = '') => {
                return `<div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                    <div class="text-gray-400 text-sm mb-2 uppercase tracking-wider font-semibold">${label}</div>
                    <div class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r ${gradient}">${icon}${val}</div>
                    <div class="text-xs text-gray-500 mt-2">${sub}</div>
                </div>`;
            };

            // Cards com cores din√¢micas
            const todayGradient = todayRate >= 70 ? 'from-green-400 to-emerald-400' : todayRate >= 40 ? 'from-orange-400 to-yellow-400' : 'from-red-400 to-pink-400';
            const todayIcon = todayRate >= 70 ? 'üî• ' : todayRate >= 40 ? '‚ö° ' : 'üí§ ';

            // Calcular semana passada para compara√ß√£o
            const lastWeekDates = getWeekDates(-1);
            let lastWeekTotal = 0, lastWeekCompleted = 0;
            lastWeekDates.forEach(({ dateStr }) => {
                const dayTasks = allTasksData[dateStr] || {};
                Object.values(dayTasks).forEach(tasks => {
                    if (Array.isArray(tasks)) {
                        lastWeekTotal += tasks.length;
                        lastWeekCompleted += tasks.filter(t => t.completed).length;
                    }
                });
            });
            const lastWeekRate = lastWeekTotal > 0 ? Math.round((lastWeekCompleted / lastWeekTotal) * 100) : 0;
            const weekDiff = weekRate - lastWeekRate;
            const weekTrend = weekDiff > 0 ? 'üìà' : weekDiff < 0 ? 'üìâ' : '‚û°Ô∏è';
            const weekCompare = weekDiff !== 0 ? `${weekTrend} ${Math.abs(weekDiff)}% vs semana anterior` : 'Mesmo que semana anterior';

            // Melhor e pior dia
            const dayRates = Object.entries(dayStats).map(([name, stats]) => ({
                name,
                rate: stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0,
                total: stats.total
            })).filter(d => d.total > 0);

            const bestDay = dayRates.reduce((best, day) => day.rate > best.rate ? day : best, { name: '-', rate: 0 });
            const worstDay = dayRates.reduce((worst, day) => day.rate < worst.rate ? day : worst, { name: '-', rate: 100 });

            html += card('Hoje', `${todayIcon}${todayRate}%`, `${completedTasksToday}/${totalTasksToday} tarefas`, todayGradient);
            html += card('Semana', `${weekRate}%`, weekCompare, weekDiff > 0 ? 'from-green-400 to-emerald-400' : weekDiff < 0 ? 'from-red-400 to-pink-400' : 'from-blue-400 to-indigo-400');
            html += card('H√°bitos', `${habitRate}%`, `${completedHabitsToday}/${totalHabits} conclu√≠dos`, habitRate === 100 && totalHabits > 0 ? 'from-green-400 to-emerald-400' : 'from-purple-400 to-pink-400');
            html += card('Streak', currentStreak > 0 ? `${currentStreak} ${currentStreak === 1 ? 'dia' : 'dias'}` : '0', currentStreak > 0 ? 'üî• Dias perfeitos' : 'Complete 100% hoje!', currentStreak >= 7 ? 'from-orange-400 to-red-400' : 'from-gray-400 to-gray-500');

            html += `</div>

            <!-- Gr√°ficos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-8">
                    <h3 class="text-lg font-semibold mb-6 text-gray-200 flex items-center gap-2">
                        <i data-lucide="calendar-days" style="width: 20px; height: 20px;"></i>
                        Progresso da Semana
                    </h3>
                    <canvas id="weekChart"></canvas>
                </div>
                <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-8">
                    <h3 class="text-lg font-semibold mb-6 text-gray-200 flex items-center gap-2">
                        <i data-lucide="target" style="width: 20px; height: 20px;"></i>
                        Status de H√°bitos
                    </h3>
                    <div class="h-64 flex items-center justify-center"><canvas id="habitsChart"></canvas></div>
                </div>
            </div>

            <!-- Melhor e Pior Dia da Semana -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                    <h3 class="text-sm font-semibold mb-3 text-gray-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="trophy" style="width: 16px; height: 16px;"></i>
                        Melhor Dia da Semana
                    </h3>
                    ${bestDay.name !== '-' ? `
                        <div class="flex items-center justify-between">
                            <div class="text-2xl font-bold text-green-400">${bestDay.name}</div>
                            <div class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-400">
                                ${bestDay.rate}%
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Maior taxa de conclus√£o esta semana</p>
                    ` : '<p class="text-gray-500 text-sm">Aguardando dados...</p>'}
                </div>
                <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                    <h3 class="text-sm font-semibold mb-3 text-gray-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>
                        Dia que Precisa de Aten√ß√£o
                    </h3>
                    ${worstDay.name !== '-' && dayRates.length > 1 ? `
                        <div class="flex items-center justify-between">
                            <div class="text-2xl font-bold text-orange-400">${worstDay.name}</div>
                            <div class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-400">
                                ${worstDay.rate}%
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Menor taxa de conclus√£o esta semana</p>
                    ` : '<p class="text-gray-500 text-sm">Aguardando dados...</p>'}
                </div>
            </div>

            <!-- Ranking de H√°bitos -->
            <div class="mt-6 bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-200 flex items-center gap-2">
                    <i data-lucide="award" style="width: 20px; height: 20px;"></i>
                    Ranking de H√°bitos (30 dias)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${(() => {
                        const habits = getAllHabits();
                        const habitRanking = habits.map(h => ({
                            text: h.text,
                            rate: getHabitCompletionRate(h.text, 30),
                            streak: getHabitStreak(h.text)
                        })).sort((a, b) => b.rate - a.rate);

                        if (habitRanking.length === 0) {
                            return '<p class="text-gray-500 text-sm col-span-2">Nenhum h√°bito rastreado ainda.</p>';
                        }

                        return habitRanking.slice(0, 6).map((habit, index) => {
                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
                            const color = habit.rate >= 80 ? 'text-green-400' : habit.rate >= 60 ? 'text-blue-400' : 'text-gray-400';
                            return `
                                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all">
                                    <div class="flex items-center gap-3 flex-1 min-w-0">
                                        <span class="text-xl">${medal}</span>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium truncate">${habit.text}</div>
                                            <div class="text-xs text-gray-500">
                                                ${habit.streak > 0 ? `üî• ${habit.streak} dias` : 'Sem streak'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xl font-bold ${color}">${habit.rate}%</div>
                                </div>
                            `;
                        }).join('');
                    })()}
                </div>
            </div>

            <!-- Heatmap Mensal -->
            <div class="mt-6 bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-200 flex items-center gap-2">
                    <i data-lucide="calendar-heart" style="width: 20px; height: 20px;"></i>
                    Heatmap de Produtividade (√öltimos 30 Dias)
                </h3>
                <div id="heatmapContainer" class="grid grid-cols-7 gap-2">
                    ${(() => {
                        let heatmapHtml = '';
                        const endDate = new Date();
                        const startDate = new Date();
                        startDate.setDate(endDate.getDate() - 29);

                        const currentDate = new Date(startDate);
                        for (let i = 0; i < 30; i++) {
                            const dateStr = currentDate.toISOString().split('T')[0];
                            const dayTasks = allTasksData[dateStr] || {};
                            let total = 0, completed = 0;

                            Object.values(dayTasks).forEach(tasks => {
                                if (Array.isArray(tasks)) {
                                    total += tasks.length;
                                    completed += tasks.filter(t => t.completed).length;
                                }
                            });

                            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                            const intensity = rate >= 80 ? 'bg-green-500' : rate >= 60 ? 'bg-blue-500' : rate >= 40 ? 'bg-orange-500' : rate > 0 ? 'bg-red-500' : 'bg-gray-700';
                            const dayNum = currentDate.getDate();
                            const isToday = dateStr === new Date().toISOString().split('T')[0];

                            heatmapHtml += `
                                <div class="relative group">
                                    <div class="${intensity} ${isToday ? 'ring-2 ring-blue-400' : ''} aspect-square rounded-lg flex items-center justify-center text-xs font-bold hover:scale-110 transition-all cursor-pointer"
                                         title="${dateStr}: ${rate}% (${completed}/${total})">
                                        ${dayNum}
                                    </div>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-black/90 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">
                                        ${dateStr}<br>${rate}% (${completed}/${total})
                                    </div>
                                </div>
                            `;

                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        return heatmapHtml;
                    })()}
                </div>
                <div class="mt-4 flex items-center justify-center gap-4 text-xs text-gray-500">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-700 rounded"></div>
                        <span>Sem dados</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-red-500 rounded"></div>
                        <span>&lt;40%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-orange-500 rounded"></div>
                        <span>40-60%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-blue-500 rounded"></div>
                        <span>60-80%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                        <span>‚â•80%</span>
                    </div>
                </div>
            </div>

            <!-- Insights -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                ${totalTasksToday > 0 && completedTasksToday === totalTasksToday ? `
                    <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4">
                        <div class="flex items-center gap-2 text-green-400 font-semibold mb-1">
                            <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                            Dia Perfeito!
                        </div>
                        <p class="text-sm text-green-300/80">Voc√™ completou todas as tarefas de hoje! üéâ</p>
                    </div>
                ` : ''}
                ${currentStreak >= 3 ? `
                    <div class="bg-orange-500/10 border border-orange-500/20 rounded-xl p-4">
                        <div class="flex items-center gap-2 text-orange-400 font-semibold mb-1">
                            <i data-lucide="flame" style="width: 18px; height: 18px;"></i>
                            Streak Ativo!
                        </div>
                        <p class="text-sm text-orange-300/80">${currentStreak} dias consecutivos! Continue assim!</p>
                    </div>
                ` : ''}
                ${habitRate === 100 && totalHabits > 0 ? `
                    <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-4">
                        <div class="flex items-center gap-2 text-purple-400 font-semibold mb-1">
                            <i data-lucide="sparkles" style="width: 18px; height: 18px;"></i>
                            H√°bitos 100%
                        </div>
                        <p class="text-sm text-purple-300/80">Todos os h√°bitos completados hoje!</p>
                    </div>
                ` : ''}
            </div>
            </div>`;

            view.innerHTML = html;

            setTimeout(() => {
                // Gr√°fico de progresso semanal
                const weekCtx = document.getElementById('weekChart');
                if (weekCtx) {
                    const dayNames = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
                    const dayData = weekDates.map(({ name }) => {
                        const stats = dayStats[name] || { total: 0, completed: 0 };
                        return stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                    });

                    new Chart(weekCtx, {
                        type: 'line',
                        data: {
                            labels: dayNames,
                            datasets: [{
                                label: 'Taxa de Conclus√£o (%)',
                                data: dayData,
                                borderColor: '#0A84FF',
                                backgroundColor: 'rgba(10, 132, 255, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#0A84FF'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: '#888', callback: (value) => value + '%' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#888' }
                                }
                            }
                        }
                    });
                }

                // Gr√°fico de h√°bitos
                const hCtx = document.getElementById('habitsChart');
                if (hCtx) {
                    new Chart(hCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Conclu√≠dos', 'Pendentes'],
                            datasets: [{
                                data: [completedHabitsToday, totalHabits - completedHabitsToday],
                                backgroundColor: ['#30d158', '#2c2c2e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            cutout: '75%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#9ca3af',
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 15
                                    }
                                }
                            }
                        }
                    });
                }

                lucide.createIcons();
            }, 100);
        }

        function renderMonth() {
            const view = document.getElementById('monthView');
            const { firstDay, lastDay, month, year } = getMonthDates(currentMonthOffset);

            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            let html = `
                <div class="max-w-[1400px] mx-auto">
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <button onclick="currentMonthOffset--; renderView();" class="utility-btn">
                            <i data-lucide="chevron-left" style="width: 18px; height: 18px;"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-white min-w-[200px] text-center">
                            ${monthNames[month]} ${year}
                        </h2>
                        <button onclick="currentMonthOffset++; renderView();" class="utility-btn">
                            <i data-lucide="chevron-right" style="width: 18px; height: 18px;"></i>
                        </button>
                        <button onclick="currentMonthOffset = 0; renderView();" class="btn-secondary text-xs px-3 py-1 ml-4" style="width: auto; padding: 6px 12px;">
                            M√™s Atual
                        </button>
                    </div>

                    <!-- Cabe√ßalho dos dias da semana -->
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Seg</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Ter</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Qua</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Qui</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Sex</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">S√°b</div>
                        <div class="text-center text-xs font-semibold text-gray-500 uppercase">Dom</div>
                    </div>

                    <!-- Grid do calend√°rio -->
                    <div class="grid grid-cols-7 gap-2">
            `;

            // Calcular o primeiro dia da semana (segunda = 0)
            const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            // Preencher dias vazios antes do primeiro dia
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += `<div class="min-h-[120px] bg-[#1c1c1e] bg-opacity-30 rounded-lg"></div>`;
            }

            // Preencher os dias do m√™s
            const today = new Date().toISOString().split('T')[0];
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today;

                const dayTasks = allTasksData[dateStr] || {};
                let totalTasks = 0;
                let completedTasks = 0;

                Object.values(dayTasks).forEach(tasks => {
                    if (Array.isArray(tasks)) {
                        totalTasks += tasks.length;
                        completedTasks += tasks.filter(t => t.completed).length;
                    }
                });

                // Adicionar tarefas da rotina di√°ria
                totalTasks += dailyRoutine.length;
                const routineStates = JSON.parse(localStorage.getItem('routineStates') || '{}');
                const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                const dayName = dayNames[date.getDay()];
                const routineKey = `${dayName}_${dateStr}`;

                dailyRoutine.forEach(task => {
                    if (routineStates[task.text] && routineStates[task.text][routineKey]) {
                        completedTasks++;
                    }
                });

                const completionPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                html += `
                    <div class="min-h-[120px] bg-[#1c1c1e] bg-opacity-40 rounded-lg p-3 hover:bg-opacity-60 transition-all cursor-pointer border ${isToday ? 'border-blue-500' : 'border-white/5'}"
                         onclick="goToDate('${dateStr}')">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm font-semibold ${isToday ? 'text-blue-400' : 'text-white'}">${day}</div>
                            ${totalTasks > 0 ? `
                                <div class="text-xs text-gray-500">
                                    ${completedTasks}/${totalTasks}
                                </div>
                            ` : ''}
                        </div>

                        ${totalTasks > 0 ? `
                            <div class="w-full h-1 bg-gray-700/30 rounded-full overflow-hidden mb-2">
                                <div class="h-full bg-blue-500 rounded-full transition-all" style="width: ${completionPercent}%"></div>
                            </div>
                        ` : ''}

                        <div class="text-xs text-gray-600 space-y-1">
                            ${totalTasks === 0 ? '<div class="text-center py-4 text-gray-700">Sem tarefas</div>' : ''}
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            view.innerHTML = html;
        }

        function goToDate(dateStr) {
            // Calcular qual semana essa data est√°
            const targetDate = new Date(dateStr);
            const today = new Date();
            const diffTime = targetDate - today;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            currentWeekOffset = Math.floor(diffDays / 7);

            // Mudar para view semanal
            setView('week');
        }

        function renderRoutineView() {
            const view = document.getElementById('routineView');

            let html = `
                <div class="max-w-3xl mx-auto py-8">
                    <h2 class="text-3xl font-bold mb-4 text-white flex items-center gap-3">
                        <i data-lucide="calendar-check" style="width: 28px; height: 28px;"></i> Rotina Di√°ria
                    </h2>
                    <p class="text-gray-400 mb-8">Essas tarefas aparecem automaticamente todos os dias da semana</p>

                    <div class="space-y-3 mb-6">
            `;

            dailyRoutine.forEach((task, index) => {
                html += `
                    <div class="bg-[#1c1c1e] bg-opacity-60 backdrop-blur-xl border border-white/10 rounded-xl p-4 flex items-center justify-between group hover:bg-opacity-80 transition-all">
                        <div class="flex items-center gap-4 flex-1">
                            <i data-lucide="grip-vertical" class="text-gray-600" style="width: 18px; height: 18px;"></i>
                            <div class="flex-1">
                                <div class="color-${task.color} font-medium text-base">${task.text}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${task.isHabit ? '<span class="text-blue-400">‚Ä¢ Marcado como h√°bito</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteRoutineTask(${index})" class="opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-red-500/20 rounded-lg">
                            <i data-lucide="trash-2" class="text-red-400" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                `;
            });

            html += `
                    </div>

                    <div id="addRoutineTaskContainer" class="bg-[#1c1c1e] bg-opacity-40 border border-dashed border-white/20 rounded-xl p-4 hover:border-blue-500/50 hover:bg-opacity-60 transition-all cursor-pointer" onclick="showAddRoutineTask()">
                        <div class="flex items-center justify-center gap-2 text-gray-400 hover:text-white transition-colors">
                            <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                            <span>Adicionar nova tarefa √† rotina</span>
                        </div>
                    </div>

                    <div class="mt-8 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="text-blue-400 mt-0.5" style="width: 18px; height: 18px;"></i>
                            <div class="text-sm text-blue-200">
                                <p class="font-semibold mb-1">Como funciona?</p>
                                <p class="text-blue-300/80">As tarefas da rotina di√°ria aparecem automaticamente em todos os dias da semana. Marque-as como h√°bitos para rastrear no painel de Analytics!</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            view.innerHTML = html;
        }

        function showAddRoutineTask() {
            const container = document.getElementById('addRoutineTaskContainer');
            container.innerHTML = `
                <div class="flex gap-2">
                    <input type="text" id="newRoutineTaskInput" class="task-input flex-1" placeholder="Nome da tarefa..." autofocus>
                    <button onclick="addRoutineTask()" class="btn-primary px-6" style="width: auto;">Adicionar</button>
                    <button onclick="renderRoutineView(); setTimeout(() => lucide.createIcons(), 0);" class="btn-secondary px-4" style="width: auto;">Cancelar</button>
                </div>
            `;
            document.getElementById('newRoutineTaskInput').focus();
            document.getElementById('newRoutineTaskInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addRoutineTask();
                if (e.key === 'Escape') { renderRoutineView(); setTimeout(() => lucide.createIcons(), 0); }
            });
        }

        function addRoutineTask() {
            const input = document.getElementById('newRoutineTaskInput');
            if (!input || !input.value.trim()) return;

            dailyRoutine.push({
                text: input.value.trim(),
                completed: false,
                color: 'default',
                isHabit: true  // Tarefas da rotina s√£o automaticamente h√°bitos
            });

            localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
            renderRoutineView();
            setTimeout(() => lucide.createIcons(), 0);
        }

        function deleteRoutineTask(index) {
            if (!confirm('Remover esta tarefa da rotina di√°ria?')) return;
            dailyRoutine.splice(index, 1);
            localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
            renderRoutineView();
            setTimeout(() => lucide.createIcons(), 0);
        }

        function renderSettingsView() {
            const view = document.getElementById('settingsView');
            view.innerHTML = `
                <div class="max-w-2xl mx-auto py-8">
                    <h2 class="text-3xl font-bold mb-8 text-white flex items-center gap-3"><i data-lucide="settings" style="width: 28px; height: 28px;"></i> Configura√ß√µes</h2>

                    <div class="space-y-4">
                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Apar√™ncia</h3>
                            <p class="text-gray-500 text-sm">Configura√ß√µes de tema e visualiza√ß√£o</p>
                        </div>

                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Notifica√ß√µes</h3>
                            <p class="text-gray-500 text-sm">Gerenciar lembretes e alertas</p>
                        </div>

                        <div class="bg-[#1a1a1a] rounded-lg p-6 border border-white/5">
                            <h3 class="text-lg font-semibold mb-2 text-white">Dados</h3>
                            <p class="text-gray-500 text-sm">Backup e sincroniza√ß√£o</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            if (view === 'month') document.getElementById('btnMonth').classList.add('active');
            if (view === 'week') document.getElementById('btnWeek').classList.add('active');
            if (view === 'today') document.getElementById('btnToday').classList.add('active');
            if (view === 'routine') document.getElementById('btnRoutine').classList.add('active');
            if (view === 'habits') document.getElementById('btnHabits').classList.add('active');
            if (view === 'analytics') document.getElementById('btnAnalytics').classList.add('active');
            if (view === 'settings') document.getElementById('btnSettings').classList.add('active');
            renderView();
        }

        function renderView() {
            // Ocultar todas as views
            document.getElementById('monthView').classList.add('hidden');
            document.getElementById('weekGrid').classList.add('hidden');
            document.getElementById('routineView').classList.add('hidden');
            document.getElementById('habitsView').classList.add('hidden');
            document.getElementById('analyticsView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');
            document.getElementById('weekNav').classList.add('hidden');

            // Mostrar navega√ß√£o de semana apenas na view semanal
            if (currentView === 'week') {
                document.getElementById('weekNav').classList.remove('hidden');
            }

            if (currentView === 'month') {
                document.getElementById('monthView').classList.remove('hidden');
                renderMonth();
            } else if (currentView === 'routine') {
                document.getElementById('routineView').classList.remove('hidden');
                renderRoutineView();
            } else if (currentView === 'habits') {
                document.getElementById('habitsView').classList.remove('hidden');
                renderHabitsView();
            } else if (currentView === 'analytics') {
                document.getElementById('analyticsView').classList.remove('hidden');
                renderAnalyticsView();
            } else if (currentView === 'settings') {
                document.getElementById('settingsView').classList.remove('hidden');
                renderSettingsView();
            } else {
                document.getElementById('weekGrid').classList.remove('hidden');
                if (currentView === 'week') renderWeek();
                else renderToday();
            }

            // Renderizar √≠cones ap√≥s atualizar a view
            setTimeout(() => lucide.createIcons(), 0);
        }

        function renderWeek() {
            const grid = document.getElementById('weekGrid');
            grid.className = 'grid grid-cols-7 gap-0';
            grid.innerHTML = '';

            // Atualizar label da semana
            document.getElementById('weekLabel').textContent = getWeekLabel(currentWeekOffset);

            const weekDates = getWeekDates(currentWeekOffset);

            weekDates.forEach(({ name: day, dateStr }) => {
                // Buscar tarefas para esta data espec√≠fica
                const dayTasks = allTasksData[dateStr] || {};
                const periods = dayTasks;
                const col = document.createElement('div');
                col.className = 'day-column';
                col.dataset.day = day;
                // Drag Events
                col.addEventListener('dragover', handleDragOver);
                col.addEventListener('drop', handleDrop);

                const header = document.createElement('h2');
                header.textContent = day;
                col.appendChild(header);

                // Flatten all tasks from all periods into a continuous list
                const allTasks = [];

                // Adicionar tarefas de rotina di√°ria primeiro (em azul)
                if (dailyRoutine.length > 0) {
                    dailyRoutine.forEach((routineTask, rIndex) => {
                        allTasks.push({
                            task: routineTask,
                            day,
                            period: 'routine',
                            originalIndex: rIndex,
                            isRoutine: true
                        });
                    });
                }

                // Adicionar tarefas normais
                Object.entries(periods).forEach(([period, tasks]) => {
                    tasks.forEach((task, index) => {
                        allTasks.push({ task, day, period, originalIndex: index, isRoutine: false });
                    });
                });

                // Render all tasks in sequence without period sections
                allTasks.forEach(({ task, day, period, originalIndex, isRoutine }) => {
                    if (isRoutine) {
                        col.appendChild(createRoutineTaskElement(day, task, originalIndex));
                    } else {
                        col.appendChild(createTaskElement(day, period, task, originalIndex));
                    }
                });

                // Adicionar √°rea clic√°vel para nova tarefa (estilo Notion)
                col.addEventListener('click', (e) => {
                    // S√≥ adicionar se clicar na √°rea vazia (n√£o em tasks ou inputs existentes)
                    if (e.target === col || e.target.tagName === 'H2' || e.target.tagName === 'H3') {
                        addQuickTaskInput(col, day);
                    }
                });

                grid.appendChild(col);
            });
        }

        function renderToday() {
            const grid = document.getElementById('weekGrid');
            grid.className = 'max-w-2xl mx-auto';
            grid.innerHTML = '';

            const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const today = days[new Date().getDay()];
            const header = document.createElement('div');
            header.className = 'mb-8';
            header.innerHTML = `<h1 class="text-3xl font-bold mb-2">${today}</h1><p class="text-gray-500">${new Date().toLocaleDateString('pt-BR')}</p>`;
            grid.appendChild(header);

            // Flatten all tasks into a continuous list
            const allTasks = [];

            // Adicionar tarefas de rotina di√°ria primeiro (em azul)
            if (dailyRoutine.length > 0) {
                dailyRoutine.forEach((routineTask, rIndex) => {
                    allTasks.push({
                        task: routineTask,
                        day: today,
                        period: 'routine',
                        originalIndex: rIndex,
                        isRoutine: true
                    });
                });
            }

            // Adicionar tarefas normais
            if (weekData[today]) {
                Object.entries(weekData[today]).forEach(([period, tasks]) => {
                    tasks.forEach((task, index) => {
                        allTasks.push({ task, day: today, period, originalIndex: index, isRoutine: false });
                    });
                });
            }

            // Render all tasks in a single continuous list
            allTasks.forEach(({ task, day, period, originalIndex, isRoutine }) => {
                if (isRoutine) {
                    grid.appendChild(createRoutineTaskElement(day, task, originalIndex));
                } else {
                    grid.appendChild(createTaskElement(day, period, task, originalIndex));
                }
            });

            // Adicionar √°rea clic√°vel para nova tarefa (estilo Notion)
            grid.style.cursor = 'text';
            grid.style.minHeight = '60vh';
            grid.addEventListener('click', (e) => {
                // S√≥ adicionar se clicar na √°rea vazia
                if (e.target === grid || e.target.classList.contains('mb-8')) {
                    addQuickTaskInputToday(grid, today);
                }
            });
        }

        function addQuickTaskInputToday(container, day) {
            // Verificar se j√° existe um input ativo
            const existingInput = container.querySelector('.quick-task-input');
            if (existingInput) {
                existingInput.focus();
                return;
            }

            const inputContainer = document.createElement('div');
            inputContainer.className = 'quick-task-container';

            // Checkbox placeholder
            const checkboxPlaceholder = document.createElement('div');
            checkboxPlaceholder.style.width = '18px';
            checkboxPlaceholder.style.height = '18px';
            checkboxPlaceholder.style.borderRadius = '6px';
            checkboxPlaceholder.style.border = '1.5px solid #555';
            checkboxPlaceholder.style.flexShrink = '0';
            checkboxPlaceholder.style.marginTop = '2px';
            inputContainer.appendChild(checkboxPlaceholder);

            // Input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'quick-task-input';
            input.placeholder = 'Digite para adicionar tarefa...';
            inputContainer.appendChild(input);

            container.appendChild(inputContainer);
            input.focus();

            // Salvar ao pressionar Enter
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    e.preventDefault();

                    const dateStr = new Date().toISOString().split('T')[0];
                    const period = 'Tarefas';

                    if (!allTasksData[dateStr]) allTasksData[dateStr] = {};
                    if (!allTasksData[dateStr][period]) allTasksData[dateStr][period] = [];

                    const newTask = {
                        text: input.value.trim(),
                        completed: false,
                        color: 'default',
                        isHabit: false
                    };

                    allTasksData[dateStr][period].push(newTask);

                    await syncTaskToSupabase(dateStr, period, newTask);
                    saveToLocalStorage();

                    renderView();
                }

                if (e.key === 'Escape') {
                    inputContainer.remove();
                }
            });

            input.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!input.value.trim()) {
                        inputContainer.remove();
                    }
                }, 100);
            });
        }

        function addQuickTaskInput(column, day) {
            // Verificar se j√° existe um input ativo
            const existingInput = column.querySelector('.quick-task-input');
            if (existingInput) {
                existingInput.focus();
                return;
            }

            const container = document.createElement('div');
            container.className = 'quick-task-container';

            // Checkbox placeholder (desabilitado)
            const checkboxPlaceholder = document.createElement('div');
            checkboxPlaceholder.style.width = '18px';
            checkboxPlaceholder.style.height = '18px';
            checkboxPlaceholder.style.borderRadius = '6px';
            checkboxPlaceholder.style.border = '1.5px solid #555';
            checkboxPlaceholder.style.flexShrink = '0';
            checkboxPlaceholder.style.marginTop = '2px';
            container.appendChild(checkboxPlaceholder);

            // Input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'quick-task-input';
            input.placeholder = 'Digite para adicionar tarefa...';
            container.appendChild(input);

            // Adicionar ao final da coluna
            column.appendChild(container);
            input.focus();

            // Salvar ao pressionar Enter
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    e.preventDefault();

                    // Encontrar a data correspondente ao dia da coluna
                    const weekDates = getWeekDates(currentWeekOffset);
                    const dayInfo = weekDates.find(d => d.name === day);
                    if (!dayInfo) return;

                    const dateStr = dayInfo.dateStr;
                    const period = 'Tarefas';

                    if (!allTasksData[dateStr]) allTasksData[dateStr] = {};
                    if (!allTasksData[dateStr][period]) allTasksData[dateStr][period] = [];

                    const newTask = {
                        text: input.value.trim(),
                        completed: false,
                        color: 'default',
                        isHabit: false
                    };

                    allTasksData[dateStr][period].push(newTask);

                    // Salvar e sincronizar
                    await syncTaskToSupabase(dateStr, period, newTask);
                    saveToLocalStorage();

                    // Re-renderizar a view
                    renderView();
                }

                // Cancelar ao pressionar Escape
                if (e.key === 'Escape') {
                    container.remove();
                }
            });

            // Remover se perder o foco e estiver vazio
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!input.value.trim()) {
                        container.remove();
                    }
                }, 100);
            });
        }

        function createRoutineTaskElement(day, task, routineIndex) {
            const today = new Date().toISOString().split('T')[0];
            const dateKey = `${day}_${today}`;

            // Recuperar estado do checkbox para hoje
            const routineStates = JSON.parse(localStorage.getItem('routineStates') || '{}');
            if (!routineStates[task.text]) routineStates[task.text] = {};
            const isCompleted = routineStates[task.text][dateKey] || false;

            const container = document.createElement('div');

            // Top Drop Zone
            container.appendChild(createDropZone(day, 'routine', routineIndex));

            const el = document.createElement('div');
            el.className = `task-item ${task.isHabit ? 'is-habit' : ''}`;
            el.draggable = true;
            el.dataset.day = day;
            el.dataset.period = 'routine';
            el.dataset.index = routineIndex;
            el.style.background = 'rgba(10, 132, 255, 0.12)';
            el.style.borderLeft = '2px solid var(--accent-blue)';

            // Drag Handle
            const handle = document.createElement('div');
            handle.className = 'drag-handle';
            handle.innerHTML = '‚ãÆ‚ãÆ';
            el.appendChild(handle);

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'checkbox-custom';
            checkbox.checked = isCompleted;
            checkbox.onchange = (e) => {
                const routineStates = JSON.parse(localStorage.getItem('routineStates') || '{}');
                if (!routineStates[task.text]) routineStates[task.text] = {};
                routineStates[task.text][dateKey] = e.target.checked;
                localStorage.setItem('routineStates', JSON.stringify(routineStates));

                label.classList.toggle('task-completed', e.target.checked);

                // Marcar como h√°bito completado
                if (task.isHabit) {
                    markHabitCompleted(task.text, e.target.checked);
                }
            };
            el.appendChild(checkbox);

            // Label
            const label = document.createElement('span');
            label.className = `task-label color-${task.color} ${isCompleted ? 'task-completed' : ''}`;
            label.textContent = task.text;

            // Single Click Edit
            label.onclick = (e) => {
                if (label.isContentEditable) return;
                startEditingRoutine(label, task, el, routineIndex);
            };

            // Context Menu
            label.oncontextmenu = (e) => {
                e.preventDefault();
                showEditToolbarRoutine(e, task, label, routineIndex);
            }

            el.appendChild(label);

            // Drag Events
            el.ondragstart = handleDragStart;
            el.ondragend = handleDragEnd;

            container.appendChild(el);
            return container;
        }

        function createTaskElement(day, period, task, index) {
            const container = document.createElement('div');

            // Top Drop Zone
            container.appendChild(createDropZone(day, period, index));

            const el = document.createElement('div');
            el.className = `task-item ${task.isHabit ? 'is-habit' : ''}`;
            el.draggable = true;
            el.dataset.day = day;
            el.dataset.period = period;
            el.dataset.index = index;

            // Drag Handle
            const handle = document.createElement('div');
            handle.className = 'drag-handle';
            handle.innerHTML = '‚ãÆ‚ãÆ';
            el.appendChild(handle);

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'checkbox-custom';
            checkbox.checked = task.completed;
            checkbox.onchange = (e) => {
                task.completed = e.target.checked;
                label.classList.toggle('task-completed', task.completed);
                saveToLocalStorage();
                // Habit logic
                if (task.isHabit) markHabitCompleted(task.text, task.completed);
            }
            el.appendChild(checkbox);

            // Label
            const label = document.createElement('span');
            label.className = `task-label color-${task.color} ${task.completed ? 'task-completed' : ''}`;
            label.textContent = task.text;

            // Single Click Edit
            label.onclick = (e) => {
                if (label.isContentEditable) return;
                startEditing(label, task, el);
            };

            // Context Menu
            label.oncontextmenu = (e) => {
                e.preventDefault();
                showEditToolbar(e, task, label);
            }

            el.appendChild(label);

            // Drag Events
            el.ondragstart = handleDragStart;
            el.ondragend = handleDragEnd;

            container.appendChild(el);
            return container;
        }

        function createDropZone(day, period, index) {
            const dz = document.createElement('div');
            dz.className = 'task-drop-zone';
            dz.dataset.day = day;
            dz.dataset.period = period;
            dz.dataset.insertAt = index;

            dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('show'); };
            dz.ondragleave = () => dz.classList.remove('show');
            dz.ondrop = (e) => handleDropZoneDrop(e, dz);
            return dz;
        }

        // --- Editing Logic ---

        function startEditing(label, task, taskDiv) {
            if (currentEditingTask) finishEditing();
            currentEditingTask = { label, task, original: task.text };

            label.contentEditable = true;
            label.focus();
            taskDiv.draggable = false;

            // Select all text
            const range = document.createRange();
            range.selectNodeContents(label);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            label.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEditing();
                }
                if (e.key === 'Escape') {
                    label.textContent = currentEditingTask.original;
                    finishEditing();
                }
            };
            label.onblur = finishEditing;
        }

        function finishEditing() {
            if (!currentEditingTask) return;
            const { label, task } = currentEditingTask;
            task.text = label.textContent.trim();
            label.contentEditable = false;
            label.closest('.task-item').draggable = true;
            saveToLocalStorage();
            currentEditingTask = null;
        }

        function startEditingRoutine(label, task, taskDiv, routineIndex) {
            if (currentEditingTask) finishEditingRoutine();
            currentEditingTask = { label, task, original: task.text, routineIndex };

            label.contentEditable = true;
            label.focus();
            taskDiv.draggable = false;

            // Select all text
            const range = document.createRange();
            range.selectNodeContents(label);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            label.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEditingRoutine();
                }
                if (e.key === 'Escape') {
                    label.textContent = currentEditingTask.original;
                    finishEditingRoutine();
                }
            };
            label.onblur = finishEditingRoutine;
        }

        function finishEditingRoutine() {
            if (!currentEditingTask) return;
            const { label, task, routineIndex } = currentEditingTask;
            task.text = label.textContent.trim();
            label.contentEditable = false;
            label.closest('.task-item').draggable = true;

            // Salvar na rotina di√°ria
            dailyRoutine[routineIndex].text = task.text;
            localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));

            currentEditingTask = null;
        }

        function showEditToolbarRoutine(e, task, label, routineIndex) {
            const toolbar = document.createElement('div');
            toolbar.className = 'context-menu';
            toolbar.style.left = e.pageX + 'px';
            toolbar.style.top = e.pageY + 'px';

            const actions = [
                { icon: 'palette', label: 'Cor', action: 'color' },
                { icon: task.isHabit ? 'x-circle' : 'check-circle', label: task.isHabit ? 'Remover H√°bito' : 'Marcar como H√°bito', action: 'habit' },
                { icon: 'trash-2', label: 'Deletar', action: 'delete' }
            ];

            actions.forEach(({ icon, label: actionLabel, action }) => {
                const btn = document.createElement('button');
                btn.innerHTML = `<i data-lucide="${icon}"></i> ${actionLabel}`;
                btn.onclick = () => {
                    if (action === 'color') showColorPicker(task, label, toolbar);
                    if (action === 'habit') {
                        task.isHabit = !task.isHabit;
                        dailyRoutine[routineIndex] = task;
                        localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
                        renderView();
                    }
                    if (action === 'delete') {
                        dailyRoutine.splice(routineIndex, 1);
                        localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
                        renderView();
                    }
                };
                toolbar.appendChild(btn);
            });

            document.body.appendChild(toolbar);
            lucide.createIcons();

            setTimeout(() => {
                const close = () => { toolbar.remove(); document.removeEventListener('click', close); };
                document.addEventListener('click', close);
            }, 100);
        }

        function showTaskInput(btn, day, period) {
            const input = document.createElement('input');
            input.className = 'task-input';
            input.placeholder = 'Nova tarefa...';
            btn.replaceWith(input);
            input.focus();

            const save = () => {
                if (input.value.trim()) {
                    if (!weekData[day][period]) weekData[day][period] = [];
                    weekData[day][period].push({ text: input.value.trim(), completed: false, color: 'default', isHabit: false });
                    saveToLocalStorage();
                }
                renderView();
            };

            input.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') renderView(); };
            input.onblur = () => setTimeout(save, 100);
        }

        // --- Drag & Drop Handlers ---

        function handleDragStart(e) {
            const period = this.dataset.period;
            const index = parseInt(this.dataset.index);

            if (period === 'routine') {
                draggedTask = {
                    day: this.dataset.day,
                    period: 'routine',
                    index: index,
                    task: dailyRoutine[index],
                    isRoutine: true
                };
            } else {
                draggedTask = {
                    day: this.dataset.day,
                    period: period,
                    index: index,
                    task: weekData[this.dataset.day][period][index],
                    isRoutine: false
                };
            }

            document.body.classList.add('dragging-active');
            setTimeout(() => this.classList.add('opacity-50'), 0);
        }

        function handleDragEnd(e) {
            document.body.classList.remove('dragging-active');
            this.classList.remove('opacity-50');
            document.querySelectorAll('.day-column').forEach(c => c.classList.remove('drag-over'));
        }

        function handleDragOver(e) { e.preventDefault(); }

        function handleDropZoneDrop(e, dz) {
            e.stopPropagation();
            dz.classList.remove('show');
            if (!draggedTask) return;

            const targetDay = dz.dataset.day;
            const targetPeriod = dz.dataset.period;
            let insertAt = parseInt(dz.dataset.insertAt);

            // Remove from old location
            if (draggedTask.isRoutine) {
                // Se for rotina, remover da rotina
                dailyRoutine.splice(draggedTask.index, 1);
                localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));

                // Se o destino for rotina tamb√©m
                if (targetPeriod === 'routine') {
                    dailyRoutine.splice(insertAt, 0, draggedTask.task);
                    localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
                } else {
                    // Mover para tarefa normal
                    if (!weekData[targetDay][targetPeriod]) weekData[targetDay][targetPeriod] = [];
                    weekData[targetDay][targetPeriod].splice(insertAt, 0, draggedTask.task);
                    saveToLocalStorage();
                }
            } else {
                // Tarefa normal
                weekData[draggedTask.day][draggedTask.period].splice(draggedTask.index, 1);

                // Ajustar index se for a mesma lista
                if (draggedTask.day === targetDay && draggedTask.period === targetPeriod && draggedTask.index < insertAt) {
                    insertAt--;
                }

                // Se o destino for rotina
                if (targetPeriod === 'routine') {
                    dailyRoutine.splice(insertAt, 0, draggedTask.task);
                    localStorage.setItem('dailyRoutine', JSON.stringify(dailyRoutine));
                } else {
                    // Inserir em tarefa normal
                    if (!weekData[targetDay][targetPeriod]) weekData[targetDay][targetPeriod] = [];
                    weekData[targetDay][targetPeriod].splice(insertAt, 0, draggedTask.task);
                }

                saveToLocalStorage();
            }

            renderView();
            draggedTask = null;
        }

        function handleDrop(e) {
            // Fallback drop on column
            e.preventDefault();
            // Logic to drop at end of list if dropped on column
        }

        // --- Menus ---
        function showEditToolbar(e, task, label) {
            const toolbar = document.getElementById('editToolbar');
            toolbar.style.left = e.pageX + 'px';
            toolbar.style.top = e.pageY + 'px';
            toolbar.classList.add('show');

            // Setup buttons (simplified)
            toolbar.querySelector('[data-action="color"]').onclick = (ev) => {
                ev.stopPropagation();
                showColorMenu(ev, task, label);
            }
            toolbar.querySelector('[data-action="delete"]').onclick = async () => {
                // Delete logic
                const day = label.closest('.task-item').dataset.day;
                const period = label.closest('.task-item').dataset.period;
                const index = parseInt(label.closest('.task-item').dataset.index);
                const taskToDelete = weekData[day][period][index];

                // Deletar do Supabase primeiro
                await deleteTaskFromSupabase(taskToDelete);

                // Depois deletar localmente
                weekData[day][period].splice(index, 1);
                saveToLocalStorage();
                renderView();
            }
        }

        function showColorMenu(e, task, label) {
            const menu = document.getElementById('colorMenu');
            const rect = document.getElementById('editToolbar').getBoundingClientRect();
            // Fix positioning (scroll aware)
            const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
            const scrollTop = window.scrollY || document.documentElement.scrollTop;

            menu.style.left = (rect.left + scrollLeft) + 'px';
            menu.style.top = (rect.bottom + scrollTop + 8) + 'px';
            menu.classList.add('show');

            menu.querySelectorAll('.color-swatch').forEach(s => {
                s.onclick = () => {
                    const color = s.dataset.color;
                    task.color = color;
                    saveToLocalStorage();
                    renderView();
                }
            });
        }

        // --- Init ---
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#editToolbar') && !e.target.closest('#colorMenu')) {
                document.getElementById('editToolbar').classList.remove('show');
                document.getElementById('colorMenu').classList.remove('show');
            }
            if (!e.target.closest('#userDropdown') && !e.target.closest('#btnUser')) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });

        document.getElementById('btnUser').onclick = () => {
            const drop = document.getElementById('userDropdown');
            drop.style.display = drop.style.display === 'flex' ? 'none' : 'flex';
        };

        document.getElementById('btnLogout').onclick = signOut;

        document.getElementById('btnTogglePeriods').onclick = () => {
            const current = localStorage.getItem('showPeriods') !== 'false';
            localStorage.setItem('showPeriods', (!current).toString());
            renderView();
        };

        document.getElementById('floatingAddBtn').onclick = () => {
            const m = document.getElementById('quickAddMenu');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        // Event listeners para autentica√ß√£o
        document.getElementById('btnLogin').onclick = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            await signIn(email, password);
        };

        document.getElementById('btnSignup').onclick = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            await signUp(email, password);
        };

        document.getElementById('btnShowSignup').onclick = () => {
            document.getElementById('authLogin').style.display = 'none';
            document.getElementById('authSignup').style.display = 'block';
        };

        document.getElementById('btnShowLogin').onclick = () => {
            document.getElementById('authSignup').style.display = 'none';
            document.getElementById('authLogin').style.display = 'block';
        };

        // Event listeners para o modal de backup
        document.getElementById('btnBackup').onclick = () => {
            document.getElementById('backupModal').classList.add('show');
        };

        document.getElementById('btnCloseBackup').onclick = () => {
            document.getElementById('backupModal').classList.remove('show');
        };

        document.getElementById('btnExport').onclick = () => {
            const data = {
                weekData: weekData,
                habitsHistory: habitsHistory,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flowly-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        document.getElementById('fileImport').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.weekData) {
                        Object.keys(weekData).forEach(day => {
                            if (data.weekData[day]) weekData[day] = data.weekData[day];
                        });
                    }
                    if (data.habitsHistory) {
                        habitsHistory = data.habitsHistory;
                        localStorage.setItem('habitsHistory', JSON.stringify(habitsHistory));
                    }
                    saveToLocalStorage();
                    renderView();
                    alert('Backup importado com sucesso!');
                } catch (error) {
                    alert('Erro ao importar backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        };

        document.getElementById('btnClearAll').onclick = async () => {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!')) {
                // Salvar dados de autentica√ß√£o antes de limpar
                const authKeys = Object.keys(localStorage).filter(key =>
                    key.startsWith('sb-') || key === 'flowly_persist_session'
                );
                const authData = {};
                authKeys.forEach(key => {
                    authData[key] = localStorage.getItem(key);
                });

                // Limpar do Supabase
                if (currentUser) {
                    await supabaseClient.from('tasks').delete().eq('user_id', currentUser.id);
                    await supabaseClient.from('habits_history').delete().eq('user_id', currentUser.id);
                }

                // Limpar localmente
                Object.keys(weekData).forEach(day => weekData[day] = {});
                habitsHistory = {};
                localStorage.clear();

                // Restaurar dados de autentica√ß√£o
                Object.entries(authData).forEach(([key, value]) => {
                    localStorage.setItem(key, value);
                });

                saveToLocalStorage();
                renderView();
                alert('Todos os dados foram limpos!');
                document.getElementById('backupModal').classList.remove('show');
            }
        };

        loadFromLocalStorage();
        setTimeout(checkAuth, 100);

        // Inicializar √≠cones Lucide
        lucide.createIcons();

    </script>
</body>

</html>
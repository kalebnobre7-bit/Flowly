<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flowly</title>
    <meta name="theme-color" content="#1c1c1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flowly">
    <link rel="apple-touch-icon" href="lightning.svg">
    <link rel="manifest" href="manifest.json?v=3">
    <link rel="icon" type="image/svg+xml" href="lightning.svg">

    <!-- ... scripts ... -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            // Se der erro crítico, alertar (ajuda a debugar telas pretas no mobile)
            // Mas apenas se o app container estiver vazio após carregamento
            setTimeout(() => {
                if (document.getElementById('weekGrid').innerHTML === '' && document.getElementById('todayView').innerHTML === '') {
                    console.error("Critical Error:", msg);
                    // alert("Erro ao carregar app: " + msg); // Opcional, remove se atrapalhar
                }
            }, 2000);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css?v=4">
    <style>
        /* Only apply Tailwind utilities where explicitly needed, let styles.css handle defaults */
        .md\:hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .md\:hidden {
                display: block;
            }

            .hidden-mobile {
                display: none !important;
            }
        }

        @media (min-width: 769px) {
            .md\:flex {
                display: flex;
            }
        }
    </style>
</head>

<body class="safe-area-bottom">
    <div class="max-w-[1600px] mx-auto">
        <!-- Header Original (Desktop Focus) -->
        <div class="nav-container hidden-mobile">
            <div class="logo-area">
                <img src="logo_flowly.png" alt="Flowly" class="logo-img" style="height: 40px;">
            </div>

            <div class="segmented-control">
                <button id="btnMonth" class="segment-btn" onclick="setView('month')">Mês</button>
                <button id="btnWeek" class="segment-btn active" onclick="setView('week')">Semana</button>
                <button id="btnToday" class="segment-btn" onclick="setView('today')">Hoje</button>
                <button id="btnRoutine" class="segment-btn" onclick="setView('routine')">Rotina</button>
                <button id="btnAnalytics" class="segment-btn" onclick="setView('analytics')">Analytics</button>
                <button id="btnSettings" class="segment-btn" onclick="setView('settings')"><i data-lucide="settings"
                        style="width: 16px; height: 16px;"></i></button>
            </div>

            <div class="utility-btns flex items-center gap-3">
                <button id="btnTogglePeriods" class="utility-btn" title="Mostrar/Ocultar períodos"><i data-lucide="list"
                        style="width: 18px; height: 18px;"></i></button>
                <button id="btnUser" class="utility-btn"><i data-lucide="user"
                        style="width: 18px; height: 18px;"></i></button>
                <!-- User Dropdown -->
                <div id="userDropdown" class="context-menu"
                    style="top: 100%; right: 0; margin-top: 8px; min-width: 180px; display: none; flex-direction: column;">
                    <div id="userEmail" class="p-3 text-xs text-gray-500 border-b border-[#333]">user@email.com
                    </div>
                    <div class="p-2 hover:bg-[#333] cursor-pointer rounded text-sm text-red-400" id="btnLogout">Sair
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Header (Minimal) -->
        <div class="md:hidden flex items-center justify-between p-4 mb-4">
            <div class="logo-area">
                <img src="logo_flowly.png" alt="Flowly" style="height: 32px;">
            </div>
            <button id="btnUserMobile" class="utility-btn ml-auto"
                onclick="document.getElementById('btnUser').click()"><i data-lucide="user"
                    style="width: 18px; height: 18px;"></i></button>
        </div>

        <!-- Week Navigation (Controls) -->
        <div id="weekNav" class="hidden flex items-center justify-center gap-4 mb-6">
            <button id="btnPrevWeek" class="utility-btn" onclick="changeWeek(-1)"><i data-lucide="chevron-left"
                    style="width: 18px; height: 18px;"></i></button>
            <div class="text-sm text-gray-400" id="weekLabel">Semana Atual</div>
            <button id="btnNextWeek" class="utility-btn" onclick="changeWeek(1)"><i data-lucide="chevron-right"
                    style="width: 18px; height: 18px;"></i></button>
            <button id="btnCurrentWeek" class="btn-secondary text-xs px-3 py-1 ml-4" onclick="goToCurrentWeek()"
                style="width: auto; padding: 6px 12px;">Atual</button>
        </div>

        <!-- Main Content -->
        <div id="contentArea">
            <div id="monthView" class="hidden"></div>
            <!-- Week Grid: Original structure was grid-cols-7, handled by CSS -->
            <div id="weekGrid" class="grid grid-cols-7 gap-0"></div>
            <div id="routineView" class="hidden"></div>
            <div id="analyticsView" class="hidden"></div>
            <div id="settingsView" class="hidden"></div>
            <div id="todayView" class="hidden"></div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation (New Feature - Kept) -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-[#1c1c1e]/95 backdrop-blur-xl border-t border-white/10 pb-[env(safe-area-inset-bottom)]">
        <div class="flex justify-around items-center h-16 px-2">
            <button class="flex flex-col items-center gap-1 w-14 text-gray-500 active:text-blue-500 transition-colors"
                onclick="setView('week')">
                <i data-lucide="calendar" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Semana</span>
            </button>
            <button class="flex flex-col items-center gap-1 w-14 text-gray-500 active:text-blue-500 transition-colors"
                onclick="setView('routine')">
                <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Rotina</span>
            </button>

            <!-- SPACE FOR FAB -->
            <div class="w-16"></div>

            <button class="flex flex-col items-center gap-1 w-14 text-gray-500 active:text-blue-500 transition-colors"
                onclick="setView('today')">
                <i data-lucide="sun" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Hoje</span>
            </button>
            <button class="flex flex-col items-center gap-1 w-14 text-gray-500 active:text-blue-500 transition-colors"
                onclick="setView('settings')">
                <i data-lucide="settings-2" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">Ajustes</span>
            </button>
        </div>
    </nav>

    <!-- Floating Action Button (FAB) - Enhanced for Mobile -->
    <button id="floatingAddBtn"
        class="fixed bottom-6 left-1/2 -translate-x-1/2 w-14 h-14 bg-blue-600 rounded-full shadow-[0_4px_20px_rgba(37,99,235,0.5)] flex items-center justify-center text-white z-50 hover:scale-110 active:scale-95 transition-all md:bottom-8 md:right-8 md:left-auto md:translate-x-0">
        <i data-lucide="zap" class="w-7 h-7 fill-current"></i>
    </button>

    <!-- Original Quick Menu (Restored Structure) -->
    <div id="quickAddMenu" class="context-menu"
        style="position: fixed; bottom: 100px; right: 32px; min-width: 200px; flex-direction: column; gap: 4px; display: none;">
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm flex items-center gap-2"
            data-type="routine"><i data-lucide="repeat" style="width: 16px; height: 16px;"></i> Rotina Diária
        </div>
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm flex items-center gap-2"
            data-type="weekly"><i data-lucide="calendar" style="width: 16px; height: 16px;"></i> Tarefa Semanal
        </div>
        <div class="quick-add-option p-2 hover:bg-[#333] rounded cursor-pointer text-sm flex items-center gap-2"
            data-type="custom"><i data-lucide="plus" style="width: 16px; height: 16px;"></i> Tarefa Avulsa
        </div>
    </div>

    <!-- Modals (Restored original Auth structure for app.js compatibility) -->
    <div id="authModal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 400px;" id="authBox">
            <h2 class="text-xl font-bold mb-4 text-center">Login / Cadastro</h2>

            <div id="authLogin">
                <input type="email" id="loginEmail" class="task-input mb-3" placeholder="Email">
                <input type="password" id="loginPassword" class="task-input mb-4" placeholder="Senha">
                <button id="btnLogin" class="btn-primary mb-3">Entrar</button>
                <button id="btnShowSignup" class="btn-secondary">Criar conta</button>
            </div>

            <div id="authSignup" style="display:none;">
                <input type="email" id="signupEmail" class="task-input mb-3" placeholder="Email">
                <input type="password" id="signupPassword" class="task-input mb-4"
                    placeholder="Senha (mín. 6 caracteres)">
                <button id="btnSignup" class="btn-primary mb-3">Cadastrar</button>
                <button id="btnShowLogin" class="btn-secondary">Voltar</button>
            </div>

            <button onclick="document.getElementById('authModal').classList.remove('show')"
                class="absolute top-4 right-4 p-2 text-gray-500 hover:text-white"><i data-lucide="x"
                    class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- Weekly Task Modal -->
    <div id="weeklyModal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 420px;">
            <h2 class="text-xl font-bold mb-1 flex items-center gap-2">
                <i data-lucide="calendar-repeat" style="width: 22px; height: 22px; color: #0A84FF;"></i>
                Tarefa Semanal
            </h2>
            <p class="text-gray-500 text-sm mb-5">Recorrente nos dias selecionados</p>

            <input type="text" id="weeklyTaskText" class="task-input mb-5" placeholder="Ex: Reunião, Academia..."
                style="background: rgba(255,255,255,0.05);" autocomplete="off">

            <p class="text-xs text-gray-400 mb-3 uppercase tracking-wider font-semibold">Dias da semana</p>
            <div class="flex gap-2 mb-6" style="justify-content: space-between;">
                <button class="weekly-day-btn" data-day="0">Dom</button>
                <button class="weekly-day-btn" data-day="1">Seg</button>
                <button class="weekly-day-btn" data-day="2">Ter</button>
                <button class="weekly-day-btn" data-day="3">Qua</button>
                <button class="weekly-day-btn" data-day="4">Qui</button>
                <button class="weekly-day-btn" data-day="5">Sex</button>
                <button class="weekly-day-btn" data-day="6">Sáb</button>
            </div>

            <button id="btnSaveWeekly" class="btn-primary mb-3">Salvar</button>
            <button id="btnCancelWeekly" class="btn-secondary">Cancelar</button>
        </div>
    </div>

    <!-- Edit Context Menu (Restored) -->
    <div id="editToolbar" class="context-menu">
        <button class="toolbar-btn" data-action="bold"><i data-lucide="bold"
                style="width: 16px; height: 16px;"></i></button>
        <button class="toolbar-btn" data-action="italic"><i data-lucide="italic"
                style="width: 16px; height: 16px;"></i></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="color"><i data-lucide="palette"
                style="width: 16px; height: 16px;"></i></button>
        <button class="toolbar-btn" data-action="habit"><i data-lucide="repeat"
                style="width: 16px; height: 16px;"></i></button>
        <div style="width: 1px; background: #333; margin: 0 4px;"></div>
        <button class="toolbar-btn" data-action="delete" style="color: var(--accent-red)"><i data-lucide="trash-2"
                style="width: 16px; height: 16px;"></i></button>
    </div>

    <!-- Color Menu (Restored) -->
    <div id="colorMenu" class="context-menu" style="display: none; grid-template-columns: repeat(5, 1fr); gap: 8px;">
        <div class="color-swatch" data-color="default"
            style="width: 20px; height: 20px; border-radius: 50%; background: #888; cursor: pointer;"></div>
        <div class="color-swatch" data-color="blue"
            style="width: 20px; height: 20px; border-radius: 50%; background: #0A84FF; cursor: pointer;"></div>
        <div class="color-swatch" data-color="green"
            style="width: 20px; height: 20px; border-radius: 50%; background: #30D158; cursor: pointer;"></div>
        <div class="color-swatch" data-color="yellow"
            style="width: 20px; height: 20px; border-radius: 50%; background: #FFD60A; cursor: pointer;"></div>
        <div class="color-swatch" data-color="red"
            style="width: 20px; height: 20px; border-radius: 50%; background: #FF453A; cursor: pointer;"></div>
    </div>

    <script src="js/app.js?v=4"></script>
</body>

</html>